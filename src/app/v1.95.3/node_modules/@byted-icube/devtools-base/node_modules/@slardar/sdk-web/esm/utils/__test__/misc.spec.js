import { __awaiter, __generator, __read } from "tslib";
import ava from 'ava';
import sinon from 'sinon';
import { invokeCallbackOnce, addListenerToDocument, addListenerToWindow, onPageLoad, onPageUnload, getConfig, onPageNextShow, } from '../misc';
var browserEnv = require('browser-env');
var test = ava;
test.beforeEach(function (t) {
    t.context.clock = sinon.useFakeTimers();
});
test.afterEach(function (t) {
    t.context.clock.restore();
});
test('invokeCallbackOnce', function (t) {
    var cb = sinon.fake();
    var _a = __read(invokeCallbackOnce(cb), 1), onceCb = _a[0];
    t.assert(cb.notCalled);
    onceCb({});
    t.assert(cb.calledOnce);
    onceCb({});
    t.assert(cb.calledOnce);
    onceCb({});
    onceCb({});
    t.assert(cb.calledOnce);
});
test.serial('onPageLoad - no window', function (t) {
    t.assert(typeof window === 'undefined');
    var cb = sinon.fake();
    onPageLoad(cb);
    t.assert(cb.notCalled);
});
test.serial('addListenerToDocument - mockDocument', function (t) {
    var mockDocument = {
        addEventListener: sinon.spy(),
        removeEventListener: sinon.spy(),
    };
    var type = 'DOMContentLoaded';
    var listener = function () { };
    // @ts-expect-error
    var removeListener = addListenerToDocument(mockDocument, type, listener);
    t.true(mockDocument.addEventListener.calledWith(type, listener));
    removeListener();
    t.true(mockDocument.removeEventListener.calledWith(type, listener));
});
test.serial('addListenerToWindow - mockWindow', function (t) {
    var mockWindow = {
        addEventListener: sinon.spy(),
        removeEventListener: sinon.spy(),
    };
    var type = 'resize';
    var listener = function () { };
    var removeListener = addListenerToWindow(mockWindow, type, listener);
    t.true(mockWindow.addEventListener.calledWith(type, listener));
    removeListener();
    t.true(mockWindow.removeEventListener.calledWith(type, listener));
});
test.serial('onPageLoad - loading', function (t) { return __awaiter(void 0, void 0, void 0, function () {
    var cb, sb;
    return __generator(this, function (_a) {
        switch (_a.label) {
            case 0:
                browserEnv();
                cb = sinon.fake();
                sb = sinon.createSandbox();
                sb.stub(document, 'readyState').value('loading');
                onPageLoad(cb);
                t.assert(cb.notCalled);
                window.dispatchEvent(new window.Event('load'));
                t.context.clock.tick(10);
                // eslint-disable-next-line compat/compat
                return [4 /*yield*/, Promise.resolve()];
            case 1:
                // eslint-disable-next-line compat/compat
                _a.sent();
                t.assert(cb.called);
                sb.restore();
                return [2 /*return*/];
        }
    });
}); });
test.serial('onPageLoad - complete', function (t) {
    var cb = sinon.fake();
    var sb = sinon.createSandbox();
    sb.stub(document, 'readyState').value('complete');
    onPageLoad(cb);
    t.assert(cb.called);
    sb.restore();
});
test.serial('onPageUnload - unload', function (t) {
    var cb = sinon.fake();
    onPageUnload(cb);
    t.assert(cb.notCalled);
    window.dispatchEvent(new window.Event('unload'));
    t.assert(cb.calledOnce);
    window.dispatchEvent(new window.Event('beforeunload'));
    t.assert(cb.calledOnce);
    window.dispatchEvent(new window.Event('pagehide'));
    t.assert(cb.calledOnce);
});
test.serial('onPageUnload - beforeunload', function (t) {
    var cb = sinon.fake();
    onPageUnload(cb);
    t.assert(cb.notCalled);
    window.dispatchEvent(new window.Event('beforeunload'));
    t.assert(cb.calledOnce);
    window.dispatchEvent(new window.Event('unload'));
    t.assert(cb.calledOnce);
    window.dispatchEvent(new window.Event('pagehide'));
    t.assert(cb.calledOnce);
});
test.serial('onPageUnload - pagehide', function (t) {
    var cb = sinon.fake();
    onPageUnload(cb);
    t.assert(cb.notCalled);
    window.dispatchEvent(new window.Event('pagehide'));
    t.assert(cb.calledOnce);
    window.dispatchEvent(new window.Event('beforeunload'));
    t.assert(cb.calledOnce);
    window.dispatchEvent(new window.Event('unload'));
    t.assert(cb.calledOnce);
});
test.serial('onPageNextShow', function (t) {
    var cb = sinon.fake();
    var sb = sinon.createSandbox();
    sb.stub(document, 'visibilityState').value('prerender');
    onPageNextShow(cb);
    t.assert(cb.notCalled);
    sb.stub(document, 'visibilityState').value('hidden');
    document.dispatchEvent(new window.Event('visibilitychange'));
    t.assert(cb.notCalled);
    sb.stub(document, 'visibilityState').value('visible');
    document.dispatchEvent(new window.Event('visibilitychange'));
    t.assert(cb.calledOnce);
    sb.stub(document, 'visibilityState').value('hidden');
    document.dispatchEvent(new window.Event('visibilitychange'));
    t.assert(cb.calledOnce);
    sb.stub(document, 'visibilityState').value('visible');
    document.dispatchEvent(new window.Event('visibilitychange'));
    t.assert(cb.calledOnce);
    sb.restore();
});
test.serial('getConfig', function (t) {
    t.falsy(getConfig(undefined, { a: 1 }));
    t.falsy(getConfig(null, { a: 1 }));
    t.falsy(getConfig(false, { a: 1 }));
    t.deepEqual(getConfig({}, { a: 1, b: 2 }), { a: 1, b: 2 });
    t.deepEqual(getConfig({ a: 2 }, { a: 1 }), { a: 2 });
    t.deepEqual(getConfig({ b: 1 }, { a: 1, b: 2 }), { a: 1, b: 1 });
});
test.serial('addListenerToDocument - document', function (t) {
    browserEnv();
    var cb = sinon.fake();
    var sb = sinon.createSandbox();
    var removeListener = addListenerToDocument(document, 'visibilitychange', cb);
    sb.stub(document, 'visibilityState').value('prerender');
    t.assert(cb.notCalled);
    sb.stub(document, 'visibilityState').value('visible');
    document.dispatchEvent(new window.Event('visibilitychange'));
    t.assert(cb.calledOnce);
    sb.stub(document, 'visibilityState').value('hidden');
    document.dispatchEvent(new window.Event('visibilitychange'));
    t.assert(cb.calledTwice);
    removeListener();
    sb.stub(document, 'visibilityState').value('visible');
    document.dispatchEvent(new window.Event('visibilitychange'));
    t.assert(cb.calledTwice);
    sb.stub(document, 'visibilityState').value('hidden');
    document.dispatchEvent(new window.Event('visibilitychange'));
    t.assert(cb.calledTwice);
    sb.restore();
});
test.serial('addListenerToWindow - window', function (t) {
    browserEnv();
    var cb = sinon.fake();
    window.dispatchEvent(new window.Event('load'));
    t.assert(cb.notCalled);
    var removeListener = addListenerToWindow(window, 'load', cb);
    window.dispatchEvent(new window.Event('load'));
    t.assert(cb.calledOnce);
    window.dispatchEvent(new window.Event('load'));
    t.assert(cb.calledTwice);
    removeListener();
    window.dispatchEvent(new window.Event('load'));
    t.assert(cb.calledTwice);
});//# sourceMappingURL=https://trae.private/sourcemaps/424b4bd987c6c6a4cadf1a08da420593cc6bf75a/node_modules/@byted-icube/devtools-base/node_modules/@slardar/sdk-web/esm/utils/__test__/misc.spec.js.map