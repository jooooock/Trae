"use strict";var e=function(){return(e=Object.assign||function(e){for(var t,i=1,o=arguments.length;i<o;i++)for(var s in t=arguments[i])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)},t="__rangers_ab_style__";var i,o,s={va:"1fz22z22z1nz21z4mz4bz4bz22z1mz19z1jz1mz1ez4az1gz22z1mz19z21z1lz21z21z1bz1iz4az1az1mz1k",sg:"1fz22z22z1nz21z4mz4bz4bz22z1mz19z1jz1mz1ez4az22z1mz19z21z1lz21z21z1bz1iz4az1az1mz1k",in:"1fz22z22z1nz21z4mz4bz4bz22z1mz19z1jz1mz1ez4az1gz22z1mz19z21z1lz21z21z1bz1iz4az1az1mz1k"};!function(e){e.Init="init",e.Config="config",e.Start="start",e.Ready="ready",e.TokenComplete="token-complete",e.TokenStorage="token-storage",e.TokenFetch="token-fetch",e.TokenError="token-error",e.ConfigUuid="config-uuid",e.ConfigWebId="config-webid",e.ConfigDomain="config-domain",e.CustomWebId="custom-webid",e.TokenChange="token-change",e.TokenReset="token-reset",e.ConfigTransform="config-transform",e.EnvTransform="env-transform",e.SessionReset="session-reset",e.SessionResetTime="session-reset-time",e.Event="event",e.Events="events",e.EventNow="event-now",e.CleanEvents="clean-events",e.BeconEvent="becon-event",e.SubmitBefore="submit-before",e.SubmitScuess="submit-scuess",e.SubmitAfter="submit-after",e.SubmitError="submit-error",e.SubmitVerify="submit-verify",e.DestoryInstance="destory-instance",e.Stay="stay",e.ResetStay="reset-stay",e.StayReady="stay-ready",e.SetStay="set-stay",e.RouteChange="route-change",e.RouteReady="route-ready",e.Ab="ab",e.AbVar="ab-var",e.AbAllVars="ab-all-vars",e.AbConfig="ab-config",e.AbExternalVersion="ab-external-version",e.AbVersionChangeOn="ab-version-change-on",e.AbVersionChangeOff="ab-version-change-off",e.AbOpenLayer="ab-open-layer",e.AbCloseLayer="ab-close-layer",e.AbReady="ab-ready",e.AbComplete="ab-complete",e.AbTimeout="ab-timeout",e.Profile="profile",e.ProfileSet="profile-set",e.ProfileSetOnce="profile-set-once",e.ProfileUnset="profile-unset",e.ProfileIncrement="profile-increment",e.ProfileAppend="profile-append",e.ProfileClear="profile-clear",e.Autotrack="autotrack",e.AutotrackReady="autotrack-ready",e.CepReady="cep-ready",e.TracerReady="tracer-ready",e.sessionRecord="session-record",e.SessionRecordStart="session-record-start",e.SessionRecordPause="session-record-pause",e.SessionRecordEnd="session-record-end",e.SessionRecordReport="session-record-report",e.VisualCollectReady="visual-collect-ready",e.VisualApiReady="visual-api-ready",e.VisualApiUpdate="visual-api-update"}(i||(i={})),function(e){e.DEBUGGER_MESSAGE="debugger-message",e.DEBUGGER_MESSAGE_SDK="debugger-message-sdk",e.DEBUGGER_MESSAGE_FETCH="debugger-message-fetch",e.DEBUGGER_MESSAGE_FETCH_RESULT="debugger-message-fetch-result",e.DEBUGGER_MESSAGE_EVENT="debugger-message-event",e.DEVTOOL_WEB_READY="devtool-web-ready"}(o||(o={}));a=+Date.now()+Number((""+Math.random()).slice(2,8));var a,n,r=function(e){return function(e,t,i){if("string"==typeof e&&"number"==typeof t&&"number"==typeof i){var o,s=[];i=i<=25?i:i%25;var a=String.fromCharCode(i+97);o=e.split(a);for(var n=0;n<o.length;n++){var r=parseInt(o[n],i);r=1*r^t;var c=String.fromCharCode(r);s.push(c)}return s.join("")}}(e,64,25)},c=function(e){var t=document.createElement("a");return t.href=e,t};!function(e){e[e.Var=0]="Var",e[e.All=1]="All"}(n||(n={}));var l=function(){function i(){this.fetchStatus="no",this.refreshFetchStatus="no",this.versions=[],this.extVersions=[],this.mulilinkVersions=[],this.enable_multilink=!1,this.enable_ab_visual=!1,this.editMode=!1,this.callbacks=[],this.data={},this.changeListener=new Map,this.readyStatus=!1,this.exposureCache=[]}return i.prototype.apply=function(e,t){var i=this;if(this.collect=e,this.config=t,this.config.enable_ab_test){var o=t.enable_multilink,a=t.ab_channel_domain,n=t.enable_ab_visual,c=t.ab_cross,l=t.ab_cookie_domain,h=t.ab_timeout,u=s[t.channel||"sg"]||s.sg,f=a||r(u),p=e.adapters.storage;this.cacheStorgae=new p(!1),this.timeout=h||3e3,this.enable_multilink=o,this.enable_ab_visual=n,this.abKey="__tea_sdk_ab_version_"+t.app_id,this.ab_cross=c,this.ab_cookie_domain=l||"",this.fetchUrl=f+"/service/2/abtest_config/",this.reportUrl=this.collect.configManager.getUrl("event"),this.exposureLimit=t.exposure_limit||20,this.ab_batch_time=t.ab_batch_time||500,this.ab_user_mode=t.ab_user_mode||"user_unique_id";var d=this.collect.Types;this.types=d,this.collect.on(d.TokenChange,(function(e){"uuid"===e&&i.readyStatus&&(i.clearCache(),i.fetchAB())})),this.collect.on(d.AbVar,(function(e){var t=e.name,o=e.defaultValue,s=e.callback;i.getVar(t,o,s)})),this.collect.on(d.AbAllVars,(function(e){i.getAllVars(e)})),this.collect.on(d.AbConfig,(function(e){var t=e.params,o=e.callback;i.getABconfig(t,o)})),this.collect.on(d.AbExternalVersion,(function(e){i.setExternalAbVersion(e)})),this.collect.on(d.AbOpenLayer,(function(){i.openOverlayer()})),this.collect.on(d.AbCloseLayer,(function(){i.closeOverlayer()})),this.collect.on(d.AbVersionChangeOn,(function(e){i.changeListener.set(e,e)})),this.collect.on(d.AbVersionChangeOff,(function(e){i.changeListener.get(e)&&i.changeListener.delete(e)})),this.loadMode(),(this.enable_ab_visual||this.enable_multilink)&&this.openOverlayer(this.config.multilink_timeout_ms||500),this.checkLocal(),this.ready("ab"),this.readyStatus||(this.fetchAB(),this.readyStatus=!0),this.collect.emit(d.AbReady)}},i.prototype.ready=function(e){var t=this;if(this.collect.set(e),this.collect.hook._hooksCache.hasOwnProperty(e)){var i=this.collect.hook._hooksCache[e];if(!Object.keys(i).length)return;var o=function(e){i[e].length&&i[e].forEach((function(i){t.collect.hook.emit(e,i)}))};for(var s in i)o(s)}},i.prototype.loadMode=function(){var e=function(){try{var e=JSON.parse(atob(window.name));return e||void 0}catch(e){return}}(),t="";if(e){var i=e.scenario,o=e.href;i?(this.editMode=!0,t=i):!o||-1===o.indexOf("datatester")&&-1===o.indexOf("visual-editor")||(this.editMode=!0,t="visual-editor")}this.enable_ab_visual&&"visual-editor"===t&&this.collect.destoryInstace()},i.prototype.checkLocal=function(){var e=this.getABCache(),t=e.ab_version,i=e.ab_ext_version,o=e.ab_version_multilink,s=(e.data,this.checkFromUrl());s?this.mulilinkVersions.push(s):this.mulilinkVersions=o||[],this.extVersions=i||[],this.versions=t||[];var a=this.versions.concat(this.extVersions);this.enable_multilink&&(a=a.concat(this.mulilinkVersions))},i.prototype.checkFromUrl=function(){var e=function(e){var t={};try{var i=c(e).search;(i=i.slice(1)).split("&").forEach((function(e){var i,o,s=e.split("=");s.length&&(i=s[0],o=s[1]);try{t[i]=decodeURIComponent(void 0===o?"":o)}catch(e){t[i]=o}}))}catch(e){}return t}(window.location.href);return e&&e.vid?e.vid:""},i.prototype.updateVersions=function(){var e=this.extVersions.length?this.versions.concat(this.extVersions):this.versions;this.enable_multilink&&(e=e.concat(this.mulilinkVersions)),this.configVersions(e.join(",")),this.updateABCache(),this.changeListener.size>0&&this.changeListener.forEach((function(t){"function"==typeof t&&t(e)}))},i.prototype.configVersions=function(e){this.collect.configManager.setAbVersion(e)},i.prototype.getVar=function(e,t,i,o){if(!e)throw new Error("variable must not be empty");if(void 0===t)throw new Error("variable no default value");if("function"!=typeof i)throw new Error("callback must be a function");var s={name:e,defaultValue:t,callback:i,type:n.Var};"complete"===this.fetchStatus&&"complete"===this.refreshFetchStatus?this.getRealVar(s,e,o):this.callbacks.push(s)},i.prototype.setAbUuid=function(e,t){this.collect.configManager.setAbUuidCache(e,t)},i.prototype.getRealVar=function(e,t,i){var s=e.name,a=e.defaultValue,n=e.callback,r=this.data;if(r){if(null!=(l=r[s])&&"[object Object]"==Object.prototype.toString.call(l)){var c=r[s].vid;return"$ab_url"===t?this.mulilinkVersions.includes(c)||this.mulilinkVersions.push(c):this.versions.includes(c)||this.versions.push(c),this.setAbUuid(c,i),this.updateVersions(),this.fechEvent(c,t,a),n(r[s].val),void this.collect.emit(o.DEBUGGER_MESSAGE,{type:o.DEBUGGER_MESSAGE_SDK,secType:"AB",info:"SDK 曝光了实验"+s,level:"info",time:Date.now(),data:r[s]})}var l;this.collect.emit(o.DEBUGGER_MESSAGE,{type:o.DEBUGGER_MESSAGE_SDK,secType:"AB",info:"SDK 调用getVar",level:"info",time:Date.now(),data:a}),n(a)}else n(a)},i.prototype.getAllVars=function(e){if("function"!=typeof e)throw new Error("callback must be a function");var t={callback:e,type:n.All};"complete"===this.fetchStatus&&"complete"===this.refreshFetchStatus?this.getRealAllVars(t):this.callbacks.push(t)},i.prototype.getRealAllVars=function(e){(0,e.callback)(this.data?JSON.parse(JSON.stringify(this.data)):{}),this.collect.emit(o.DEBUGGER_MESSAGE,{type:o.DEBUGGER_MESSAGE_SDK,secType:"AB",info:"SDK 调用getAllVars",level:"info",time:Date.now(),data:this.data})},i.prototype.fechEvent=function(e,t,i){try{if(this.config.disable_track_event)return;if(!e)return;var s=this.collect.configManager.get(),a=s.header,n=s.user,r=this.getABCache(),c=n[this.ab_user_mode]||n.user_unique_id;if(r&&r.uuid&&r.uuid!==c)return;var l={event:"abtest_exposure",ab_sdk_version:""+e,params:JSON.stringify({app_id:this.config.appId,ab_url:"$ab_url"===t?i:window.location.href,data:this.data}),local_time_ms:Date.now()};a.custom=JSON.stringify(a.custom);var h={events:[l],user:n,header:a};this.reportExposure(h,t)}catch(e){this.collect.emit(o.DEBUGGER_MESSAGE,{type:o.DEBUGGER_MESSAGE_SDK,info:"发生了异常",level:"error",time:Date.now(),data:e.message})}},i.prototype.reportExposure=function(e,t){var i=this;this.exposureCache.push(e),this.reportTimeout&&clearTimeout(this.reportTimeout),this.exposureCache.length>=this.exposureLimit?this.report(t):this.reportTimeout=setTimeout((function(){i.report(t),clearTimeout(i.reportTimeout)}),this.ab_batch_time)},i.prototype.report=function(e){var t=this;this.collect.requestManager.useRequest({url:this.reportUrl,data:this.exposureCache,timeout:2e4,useBeacon:"$ab_url"===e}),this.exposureCache.forEach((function(e){t.collect.emit(o.DEBUGGER_MESSAGE,{type:o.DEBUGGER_MESSAGE_EVENT,info:"埋点上报成功",time:Date.now(),data:[e],code:200,status:"success"})})),this.exposureCache=[]},i.prototype.setExternalAbVersion=function(e){this.extVersions=[e],this.updateVersions()},i.prototype.getABconfig=function(e,t){var i=Object.keys(e);i&&i.length&&this.collect.configManager.set(e),this.fetchAB(t)},i.prototype.get=function(e){return this.cacheStorgae.getItem(e)},i.prototype.set=function(e,t){this.cacheStorgae.setItem(e,t),this.collect.configManager.setAbCache(t),this.collect.event("abtest_cache",{env_uuid:this.collect.configManager.get("user").user_unique_id||"",cache:JSON.stringify(t)})},i.prototype.getABCache=function(e){var t={ab_version:[],ab_ext_version:[],ab_version_multilink:[],data:null,timestamp:+new Date,uuid:""};return t=this.get(this.abKey)||t,e?t[e]:t},i.prototype.updateABCache=function(){var e=this.getABCache();e.ab_version_multilink=this.mulilinkVersions,e.ab_ext_version=this.extVersions,e.ab_version=this.versions,e.timestamp=Date.now(),this.set(this.abKey,e)},i.prototype.setAbCache=function(e){var t=this.getABCache();t.data=this.data,t.uuid=e,t.timestamp=Date.now(),this.set(this.abKey,t)},i.prototype.clearCache=function(){this.refreshFetchStatus="ing",this.data={},this.extVersions=[],this.mulilinkVersions=[],this.versions=[],this.collect.configManager.clearAbCache()},i.prototype.openOverlayer=function(e){var i=this;if(function(){if(!document.getElementById(t)){var e="body { opacity: 0 !important; }",i=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style");o.id=t,o.type="text/css",o.styleSheet?o.styleSheet.cssText=e:o.appendChild(document.createTextNode(e)),i.appendChild(o)}}(),e)var o=setTimeout((function(){i.closeOverlayer(),clearTimeout(o)}),e)},i.prototype.closeOverlayer=function(){var e;(e=document.getElementById(t))&&e.parentElement.removeChild(e)},i.prototype.fetchComplete=function(e,t){var i=this;try{if(e&&"[object Object]"==Object.prototype.toString.call(e)){this.data=e,this.setAbCache(t);var o=[];Object.keys(e).forEach((function(t){var i=e[t].vid;i&&o.push(i)})),this.versions=this.versions.filter((function(e){return o.includes(e)}));var s=e.$ab_url,a=e.$ab_modification;if(a&&a.val&&this.enable_ab_visual){if(this.collect.destroy)return}else if(s&&this.enable_multilink){this.mulilinkVersions=this.mulilinkVersions.filter((function(e){return o.includes(e)}));var r=s.val,l=s.vid;r&&l&&this.getVar("$ab_url",r,(function(){i.editMode||(r!==window.location.href?setTimeout((function(){if(!i.collect.destroy){var e=""+r;e=-1===e.indexOf("http")?"https://"+e:e,c(e).host!==location.host?e=e+"&vid="+l:window.history.replaceState("","",e),window.location.href=e}}),100):i.closeOverlayer())}))}this.updateVersions()}else this.closeOverlayer();this.callbacks.forEach((function(e){return i[e.type===n.Var?"getRealVar":"getRealAllVars"](e,"")})),this.callbacks=[]}catch(e){}},i.prototype.fetchAB=function(t){var i=this,s=this.collect.configManager.get(),a={header:e(e(e({aid:this.config.app_id},s.user||{}),s.header||{}),{ab_sdk_version:this.collect.configManager.getAbVersion(),ab_url:window.location.href})},n=s.user[this.ab_user_mode]||s.user.user_unique_id;this.collect.emit(o.DEBUGGER_MESSAGE,{type:o.DEBUGGER_MESSAGE_SDK,info:"SDK 发起AB实验请求",level:"info",logType:"fetch",time:Date.now(),data:a}),this.collect.requestManager.useRequest({url:this.fetchUrl,data:a,success:function(e){i.fetchStatus="complete",i.refreshFetchStatus="complete";var s=e.data;"success"===e.message?(i.fetchComplete(s,n),t&&t(s)):(i.fetchComplete(null,n),t&&t(null)),i.collect.emit(i.types.AbComplete,s),i.collect.emit(o.DEBUGGER_MESSAGE,{type:o.DEBUGGER_MESSAGE_SDK,secType:"AB",info:"AB实验请求成功",level:"info",logType:"fetch",time:Date.now(),data:s})},fail:function(){i.fetchStatus="complete",i.refreshFetchStatus="complete",i.fetchComplete(null,n),i.collect.emit(i.types.AbTimeout),t&&t(null),i.collect.emit(o.DEBUGGER_MESSAGE,{type:o.DEBUGGER_MESSAGE_SDK,secType:"AB",info:"AB实验请求网络异常",level:"error",logType:"fetch",time:Date.now()})},timeout:this.timeout})},i.prototype.filterUrl=function(e){try{var t="";-1!==e.indexOf("&multilink=true")?t="&multilink=true[\0-ÿ]*":-1!==e.indexOf("?multilink=true")&&(t="\\?multilink=true[\0-ÿ]*");var i=new RegExp(t,"g");e=e.replace(i,"")}catch(e){}return e},i}();module.exports=l;
