import { __awaiter, __generator } from "tslib";
import test from 'ava';
import sinon from 'sinon';
import { createTestWebClient } from '../../../utils/__test__/util';
import { FetchMonitorPlugin } from '../fetch';
var browserEnv = require('browser-env');
test.before(function () {
    browserEnv();
});
/* eslint-disable compat/compat */
var virtualFetch = function (_url, _options) {
    return new Promise(function (resolve) {
        resolve({
            status: 200,
            headers: {
                header_1: 'value_1',
            },
            clone: function () {
                return {
                    json: function () {
                        return new Promise(function (resolve_1) {
                            resolve_1('res body');
                        });
                    },
                };
            },
        });
    });
};
var sleep = function (time) {
    if (time === void 0) { time = 1100; }
    return new Promise(function (resolve) {
        setTimeout(resolve, time);
    });
};
test.serial('FetchMonitorPlugin - ignoreUrls', function (t) { return __awaiter(void 0, void 0, void 0, function () {
    var client, onReport;
    return __generator(this, function (_a) {
        switch (_a.label) {
            case 0:
                window.fetch = virtualFetch;
                client = createTestWebClient();
                onReport = sinon.fake();
                FetchMonitorPlugin(client);
                client.init({
                    pid: 'init-pid',
                    plugins: {
                        fetch: {
                            ignoreUrls: ['test.com'],
                        },
                    },
                });
                client.on('report', onReport);
                return [4 /*yield*/, window.fetch('http://test.com')];
            case 1:
                _a.sent();
                return [4 /*yield*/, sleep()];
            case 2:
                _a.sent();
                t.true(onReport.notCalled);
                return [2 /*return*/];
        }
    });
}); });
test.serial('FetchMonitorPlugin - extraExtractor should work', function (t) { return __awaiter(void 0, void 0, void 0, function () {
    var target, client, onReport;
    return __generator(this, function (_a) {
        switch (_a.label) {
            case 0:
                target = {
                    reqBody: 'req=123',
                    resBody: JSON.stringify({ res: 'test' }),
                };
                window.fetch = virtualFetch;
                window.Request = function () { };
                window.Headers = function () { };
                global.fetch = window.fetch;
                client = createTestWebClient();
                onReport = sinon.fake();
                client.init({
                    pid: 'init-pid',
                    plugins: {
                        fetch: {
                            extraExtractor: function (resBody, _related, reqBody) {
                                t.is(reqBody, target.reqBody);
                                t.is(resBody, 'res body');
                                return {
                                    param: 'test',
                                };
                            },
                        },
                    },
                });
                FetchMonitorPlugin(client);
                client.on('report', onReport);
                return [4 /*yield*/, window.fetch('http://www.test.com', {
                        body: target.reqBody,
                    })];
            case 1:
                _a.sent();
                return [4 /*yield*/, sleep()];
            case 2:
                _a.sent();
                t.true(onReport.calledOnce);
                t.is(onReport.args[0][0].ev_type, 'http');
                t.deepEqual(onReport.args[0][0].payload.extra, {
                    param: 'test',
                });
                return [2 /*return*/];
        }
    });
}); });
test.serial('FetchMonitorPlugin - disable', function (t) { return __awaiter(void 0, void 0, void 0, function () {
    var target, client, onReport;
    return __generator(this, function (_a) {
        switch (_a.label) {
            case 0:
                target = {
                    reqBody: 'req=123',
                    resBody: JSON.stringify({ res: 'test' }),
                };
                window.fetch = virtualFetch;
                window.Request = function () { };
                window.Headers = function () { };
                global.fetch = window.fetch;
                client = createTestWebClient();
                onReport = sinon.fake();
                client.init({
                    pid: 'init-pid',
                    plugins: {
                        fetch: false,
                    },
                });
                FetchMonitorPlugin(client);
                client.on('report', onReport);
                return [4 /*yield*/, window.fetch('http://www.test.com', {
                        body: target.reqBody,
                    })];
            case 1:
                _a.sent();
                return [4 /*yield*/, sleep()];
            case 2:
                _a.sent();
                t.true(onReport.notCalled);
                return [2 /*return*/];
        }
    });
}); });//# sourceMappingURL=https://trae.private/sourcemaps/424b4bd987c6c6a4cadf1a08da420593cc6bf75a/node_modules/@slardar/sdk-web/esm/plugins/monitors/__test__/fetch.spec.js.map