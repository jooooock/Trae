var e=function(){return(e=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function t(e,t){var i,n,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=(r=a.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function i(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var n,r,o=i.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(e){r={error:e}}finally{try{n&&!n.done&&(i=o.return)&&i.call(o)}finally{if(r)throw r.error}}return a}function n(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(i(arguments[t]));return e}function r(e){return e.match(/^[a-zA-Z]+[0-9]?/)[0]||""}var o=function(e,t){return function(e,t,i){for(var n=function(e,t){for(var i=0,n=e.length,r=[];i<n;)t(e[i],i)&&r.push(e[i]),i+=1;return r}(t.split("/"),Boolean).map(r),o=n.length,a=i.map(String),s=0,c=[e],l=[];c.length&&s<o;){l=[];for(var u=0,h=0;h<c.length;h++){var f=c[h].tagName.toLowerCase()||"";"*"!==n[s]&&n[s]!==f||("*"!==a[s]&&a[s]!==u.toString()||l.push(c[h]),u++)}s<o-1&&(c=l.reduce(function(e,t){return e.concat(Array.from(t.children))},[])),s++}return s<o-1?[]:l}(document.body,e,t)};function a(e,t){return function(e,t,i){var r=function(e,t){void 0===t&&(t=!1);return e.split("/").reduce(function(e,i){return i?e.concat(t?i.replace(/\[\]$/,""):i):e},[])}(t,!0),o=[e];if(r.length!==i.length)throw new Error("invalid xpath, path: "+t+", pos: "+i);for(var a=0;a<r.length;a++){for(var c=r[a],l=i[a],u=[],h=0;h<o.length;h++){var f=s(o[h],c,l);u.push.apply(u,n(f))}if(u.length<=0){a<r.length-1&&(o=[]);break}o=u}return o}(document.documentElement,e,t)}function s(e,t,i){return Array.from(e.children).filter(function(e){return e instanceof HTMLElement}).filter(function(e){return t===e.tagName.toLowerCase()}).filter(function(e,t){return[t.toString(),"*"].includes(i)})}var c,l=function(e){return Array.isArray(e)},u=(c=+Date.now()+Number((""+Math.random()).slice(2,8)),function(e){return function(e,t,i){if("string"==typeof e&&"number"==typeof t&&"number"==typeof i){var n,r=[];i=i<=25?i:i%25;var o=String.fromCharCode(i+97);n=e.split(o);for(var a=0;a<n.length;a++){var s=parseInt(n[a],i);s=1*s^t;var c=String.fromCharCode(s);r.push(c)}return r.join("")}}(e,64,25)}),h=function(e){var t={};try{var i=function(e){var t=document.createElement("a");return t.href=e,t}(e).search;if(!i)return t;(i=i.slice(1)).split("&").forEach(function(e){var i,n,r=e.split("=");r.length&&(i=r[0],n=r[1]);try{t[i]=decodeURIComponent(void 0===n?"":n)}catch(e){t[i]=n}})}catch(e){}return t};function f(e,t,i){if(void 0===t&&(t="list"),!e)return!1;if(t&&"list"===t){if(["LI","TR","DL"].includes(e.nodeName))return!0;if(e.dataset&&e.dataset.hasOwnProperty("teaIdx"))return!0;if(e.hasAttribute&&e.hasAttribute("data-tea-idx"))return!0}else{if(["A","BUTTON"].includes(e.nodeName))return!0;if(e.dataset&&e.dataset.hasOwnProperty("teaContainer"))return!0;if(e.hasAttribute&&e.hasAttribute("data-tea-container"))return!0;if(i&&e.hasAttribute&&e.hasAttribute(i))return!0}return!1}function p(e){var t=[];if(!e)return{element_path:"",positions:[]};for(;null!==e.parentElement;)t.push(e),e=e.parentElement;var i=[],n=[];return t.forEach(function(e){var t=function(e){if(null===e)return{str:"",index:0};var t=0,i=e.parentElement;if(i)for(var n=i.children,r=0;r<n.length&&n[r]!==e;r++)n[r].nodeName===e.nodeName&&t++;return{str:[e.nodeName.toLowerCase(),f(e,"list")?"[]":""].join(""),index:t}}(e),r=t.str,o=t.index;i.unshift(r),n.unshift(o)}),{element_path:"/"+i.join("/"),positions:n}}var d,g,m,v,y,_,b=function(){return function e(t){return t?(t^16*Math.random()>>t/4).toString(10):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e)}().replace(/-/g,"").slice(0,19)},E=function(){function t(e,t){try{this.visual=e,this.configList=t,this.elementList=[],this.elememtMap=new Map,this.configList.filter(function(e){return"view"===e.trigger_type}).forEach(function(e){return e.uid=b()}),IntersectionObserver?this.observerInstance=new IntersectionObserver(this.observerCallback.bind(this),{threshold:[0,.01,.1,.2,.3,.4,.5,.6,.7,.8,.9,1]}):console.warn("your browser can not support exposure"),MutationObserver&&(this.mutationInstance=new MutationObserver(this.initObserver.bind(this)),this.mutationInstance.observe(document.body,{childList:!0,attributes:!1,subtree:!0,attributeOldValue:!1})),this.initObserver()}catch(e){console.error(e)}}return t.prototype.initObserver=function(){var e=this;try{var t=new URL(this.visual.repalceUrl(window.location.href)),i=t.pathname+t.search+t.hash;this.observerInstance&&this.configList&&this.configList.forEach(function(t){if("view"===t.trigger_type&&new RegExp(t.cond.url).test(i)){var n="selector"===(t.element_config.field.includes("selector")?"selector":"path")?"custom_selector"===t.element_config.field?t.element_config.selector:t.cond.similar_pattern?t.element_config.selector+"_"+t.cond.similar_segment_selector:t.element_config.selector:t.element_config.path+"_"+t.element_config.position.join(),r=e.getElementsByElementConfig(t),o=r.elementInstanceList,a=r.exposureSimilar;e.elementList=e.elementList.filter(function(e){return document.body.contains(e.elementInstance)}),l(o)?o.forEach(function(i){e.handelElementInstance(i,n,t,a)}):e.handelElementInstance(o,n,t,a)}})}catch(e){console.error(e)}},t.prototype.getElementsByElementConfig=function(e){var t=[],i=!1;try{if("selector"===(e.element_config.field.includes("selector")?"selector":"path"))if("selector"===e.element_config.field)if(e.cond.similar_pattern){i=!0;var n=document.querySelector(e.element_config.selector);t=n?Array.from(n.querySelectorAll(e.cond.similar_segment_selector)):[]}else t=document.querySelector(e.element_config.selector);else i=!0,t=Array.from(document.querySelectorAll(e.element_config.selector));else e.cond.similar_pattern?(i=!0,t=a(e.element_config.path,e.element_config.position)):t=o(e.element_config.path,e.element_config.position)}catch(e){console.error(e)}finally{return{elementInstanceList:t,exposureSimilar:i}}},t.prototype.handelElementInstance=function(t,i,n,r){try{if(!t)return;t.entryKey||(t.entryKey=[]),-1===t.entryKey.indexOf(i)&&t.entryKey.push(i);var o=this.get(i),a=b();t.selfId||(t.selfId=a);var s=this.getInstance(o,t,n,r),c=s.shouldUpdateInstance,l=s.elementExist,u=s.currentElement;if((!o.length||o.length&&!l)&&this.elementList.push(e({elementKey:i,elementInstance:t,isIntersecting:!1,selfId:a},n)),o.length&&!c&&!l)return;if(o.length&&c&&l){if(u.exposured&&"once"===u.cond.frequency)return;this.exposureRemove(t)}this.exposureAdd(t)}catch(e){console.error(e)}},t.prototype.get=function(e){var t=this,i=[];return this.elementList.length&&(e instanceof Array?e.forEach(function(e){t.elementList.forEach(function(t){t.elementKey===e&&i.push(t)})}):this.elementList.forEach(function(t){t.elementKey===e&&i.push(t)})),i},t.prototype.getInstance=function(e,t,i,n){var r=!1,o=!1,a=null;return e.forEach(function(e){e.uid===i.uid&&(n?e.selfId===t.selfId&&(e.elementInstance===t?o=!0:(r=!0,e.elementInstance=t,a=e)):(o=!0,e.elementInstance!==t&&(r=!0,e.elementInstance=t,a=e)))}),{shouldUpdateInstance:r,elementExist:o,currentElement:a}},t.prototype.set=function(e,t,i){this.get(e).filter(function(e){return e.elementInstance===i}).forEach(function(e){t.uid===e.uid&&(e=Object.assign(e,t))})},t.prototype.observerCallback=function(e){var t=this;try{e.forEach(function(e){var i=e.target,n=e.isIntersecting,r=(e.time,e.intersectionRatio),o=new URL(t.visual.repalceUrl(window.location.href)),a=o.pathname+o.search+o.hash,s=i.entryKey;if(l(s)&&s.length){var c=t.get(s).filter(function(e){return e.elementInstance===i});c.length&&c.forEach(function(e){if("once"!==e.exportModel){if(!n)return e.isIntersecting=!1,e.added=!1,e.exposured=!1,e.startTime=Date.now(),void t.set(s,e,i);if(new RegExp(e.cond.url).test(a)){if(!e.added){if(e.startTime=Date.now(),e.added=!0,e.isIntersecting=!0,e.cond.min_exposure_time){var o=setTimeout(function(){e.isIntersecting&&!e.exposured&&t.handleExposure(s,e,r,i)},e.cond.min_exposure_time);e.startWait=o}t.set(s,e,i)}Date.now()-e.startTime>=e.cond.min_exposure_time&&!e.exposured&&t.handleExposure(s,e,r,i)}}})}})}catch(e){console.error(e)}},t.prototype.handleExposure=function(e,t,i,n){try{if(100*i<t.cond.min_exposure_ratio)return;if(t.cond.text_pattern&&!this.isMatchText(t,n))return;"once"===t.cond.frequency?(t.startWait&&clearTimeout(t.startWait),t.exportModel="once",this.reportEvent(t,n)):(t.exportModel="eveny",this.reportEvent(t,n)),t.startTime=Date.now(),t.exposured=!0,this.set(e,t,n)}catch(e){console.error(e)}},t.prototype.isMatchText=function(e,t){return this.visual.getElementText(t)===e.element_config.text},t.prototype.exposureAdd=function(e){this.observerInstance.observe(e)},t.prototype.exposureRemove=function(e){this.observerInstance.unobserve(e)},t.prototype.getElementPath=function(e){var t={},i=p(e),n=i.element_path,r=i.positions.map(function(e){return""+e});return t.path=n,t.positions=r,t},t.prototype.reportEvent=function(t,i){try{var n=this.getElementsByElementConfig(t).elementInstanceList,r=n?l(n)?Array.from(n):[n]:[],o=t.params&&t.params.length?this.visual.calculateParams({configItem:t,target:i||null,componentDomList:r}):{};this.visual.handleReport(t,e({},o))}catch(e){console.error(e)}},t}();!function(e){e.PATHNAME="pathname",e.HREF="HREF"}(d||(d={})),function(e){e[e.static=1]="static",e[e.picker=2]="picker",e[e.preset_variable=3]="preset_variable",e[e.api=4]="api"}(g||(g={})),function(e){e[e.integer=1]="integer",e[e.float=2]="float",e[e.string=3]="string"}(m||(m={})),function(e){e.PAGE="page",e.ELEMENT="element"}(v||(v={})),function(e){e.HIDDEN="hidden",e.EXIT="exit",e.INACTIVE="inactive"}(y||(y={})),function(e){e.ACTIVE="active",e.PASSIVE="passive",e.HIDDEN="hidden",e.FROZEN="frozen",e.TERMINATED="terminated"}(_||(_={}));var w=function(e){var t={};return e&&e.substring(1).split("&").forEach(function(e){var i=e.split("=");i[0]&&(t[decodeURIComponent(i[0])]=i[1]?decodeURIComponent(i[1]):"")}),t};function I(e,t,i){var n;void 0===t&&(t=50),void 0===i&&(i={isImmediate:!1});var r=function(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];var a=this,s=i.isImmediate&&void 0===n;void 0!==n&&clearTimeout(n),n=setTimeout(function(){n=void 0,i.isImmediate||e.apply(a,r)},t),s&&e.apply(a,r)};return r.cancel=function(){void 0!==n&&clearTimeout(n)},r}var z,T,S=function(e){return window.getComputedStyle(e,null)},L=function(e,t){return e.getPropertyValue(t)},P=function(e){if(e==window.document)return!0;if(!e||!e.parentNode)return!1;var t=S(e),i=L(t,"visibility");return"hidden"!==i&&"collapse"!==i&&("0"!==L(t,"opacity")&&function e(t,i){if(i||(i=S(t)),"none"===L(i,"display"))return!1;var n,r=t.parentNode;return!r||!(n=r)||1!==n.nodeType||e(r)}(e,t))},A=function e(t){var i={};return Object.keys(t).forEach(function(n){var r=n.replace(/([A-Z])/g,"_$1").toLowerCase();t[n]&&"object"==typeof i[n]?i[r]=e(t[n]):i[r]=t[n]}),i};!function(e){e.HASH="hash",e.BOTH="both",e.HISTORY="history"}(z||(z={})),function(e){e.CLICK="click",e.PAGE_VIEW="page_view",e.VIEW="view",e.API_AFTER="api_after",e.STAY_DURATION="stay_duration"}(T||(T={}));var C,x={KEY_DOWN:"keydown",MOUSE_DOWN:"mousedown",MOUSE_OVER:"mouseover",TOUCH_START:"touchstart",TOUCH_END:"touchend",SCROLL:"scroll"},D=50,V=function(){function e(e){var t=e.pathname,i=e.url,n=e.prevUrl;this.pathname=t,this.url=i,this.prevUrl=n,this.options=e,this.visualInstance=e.visualInstance,this.element=e.element,this.initPageStats()}return e.prototype.initPageStats=function(){this.isActive=!1,this.isVisible=!1,this.activeDuration=0,this.visibleDuration=0},e.prototype.onEnter=function(){"visible"===document.visibilityState&&(this.onVisible(),this.onActive())},e.prototype.onActive=function(){if(!this.isActive){var e=new Date;this.isActive=!0,this.lastActiveTime=e,this.enterTime||(this.enterTime=e),this.leaveTime=void 0,this.toogleElementsVisible(!0,!0,"active")}},e.prototype.onInactive=function(){if(this.isActive){var e=new Date;this.getLatestActiveDuration(),this.isActive=!1,this.leaveTime=e,this.toogleElementsVisible(!1,!1,"inactive")}},e.prototype.onVisible=function(){if(!this.isVisible){var e=new Date;this.isVisible=!0,this.lastVisibleTime=e,this.enterTime||(this.enterTime=e),this.leaveTime=void 0,this.toogleElementsVisible(!0,!0,"visible")}},e.prototype.onInvisible=function(){if(this.isVisible){var e=new Date;this.isVisible=!1,this.getLatestVisibleDuration(),this.leaveTime=e,this.toogleElementsVisible(!1,!1,"invisible")}},e.prototype.toogleElementsVisible=function(e,t,i){try{this.element&&this.element.monitorElements&&this.element.monitorElements.forEach(function(n){var r=n.observer.configItem.cond.bind_activity_pattern;r&&["active","inactive"].includes(i)&&n.observer.setVisibleState(e,i,t),!r&&["visible","invisible"].includes(i)&&n.observer.setVisibleState(e,i,t)})}catch(e){console.error(e)}},e.prototype.getLatestActiveDuration=function(){var e=new Date;this.activeDuration+=this.isActive&&this.lastActiveTime?e.getTime()-(this.lastActiveTime&&this.lastActiveTime.getTime()||0):0,this.lastActiveTime=e},e.prototype.getLatestVisibleDuration=function(){var e=new Date;this.visibleDuration+=this.lastVisibleTime?e.getTime()-this.lastVisibleTime.getTime():0,this.lastVisibleTime=e},e.prototype.generateDurationEvent=function(){return this.getLatestActiveDuration(),this.getLatestVisibleDuration(),{currUrl:this.url,prevUrl:this.prevUrl,pathname:this.pathname,query:this.query,title:document.title,enterTime:this.enterTime&&this.enterTime.getTime(),leaveTime:this.leaveTime&&this.leaveTime.getTime(),activeDuration:this.activeDuration,visibleDuration:this.visibleDuration}},e.prototype.resetTimeAfterGenerate=function(e){this.visibleDuration=0,this.activeDuration=0,this.enterTime=void 0,this.leaveTime=void 0},Object.defineProperty(e.prototype,"curPath",{get:function(){return this.pathname},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"query",{get:function(){return w(location.search)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currUrl",{get:function(){return this.url},enumerable:!1,configurable:!0}),e}(),k=function(){function t(e){this.configItem=e.config,this.element=e.element,this.element&&this.element.setPageOptions(this),this.visualInstance=e.visualInstance,this.handlePageChange(e.config,e.event)}return t.prototype.handleMonitorActivityEvents=function(){window.clearTimeout(this.inactiveTimerHandle),this.startInactiveTimer(),this.curPage&&this.curPage.onActive()},t.prototype.handleListenLifecycle=function(e,t){switch(t){case _.HIDDEN:this.curPage&&this.handleHiddenState();break;case _.TERMINATED:this.curPage&&this.handleTerminatedState();break;case _.ACTIVE:case _.PASSIVE:this.handlePageVisibleState(t)}},t.prototype.handlePageChange=function(e,t){try{var i=e.cond.page_key||d.PATHNAME;if(this.curPage&&this.curPage.currUrl&&t&&t.curUrl&&this.curPage.currUrl[i]===t.curUrl[i])return;this.curPage&&(this.handleHiddenState(),this.handleTerminatedState()),this.handleCacheByPageUpdate(),this.isMatchConfigUrl(t&&t.curUrl&&t.curUrl.href)&&this.onPageEnter(t)}catch(e){console.error(e)}},t.prototype.handleCacheByPageUpdate=function(){try{var e=localStorage.getItem("VISUAL_STAY_DURATION_STATS");e&&this.triggerPageDurationEvent(JSON.parse(e))}catch(e){console.error("[visualStayDuration] onPageEnter error: ",e)}this.removePageStatsCache()},t.prototype.onPageEnter=function(e){this.curPage=e?e.curUrl&&new V({pathname:e.curUrl.pathname,url:e.curUrl,prevUrl:e.prevUrl,visualInstance:this.visualInstance,element:this.element}):new V({pathname:window.location.pathname,url:{pathname:window.location.pathname,href:window.location.href,hash:window.location.hash,host:window.location.host,port:window.location.port,query:w(window.location.search),pathWithHash:window.location.pathname+window.location.hash},visualInstance:this.visualInstance,element:this.element}),this.curPage&&this.curPage.onEnter(),this.startInactiveTimer()},t.prototype.startInactiveTimer=function(){var e=this;"visible"===document.visibilityState&&(window.clearTimeout(this.inactiveTimerHandle),this.inactiveTimerHandle=window.setTimeout(function(){e.curPage&&e.curPage.onInactive(),e.configItem.cond.duration_trigger===y.INACTIVE&&e.triggerPageDurationEvent()},this.configItem.cond.inactive_timeout||3e4))},t.prototype.handlePageVisibleState=function(e){this.curPage&&this.curPage.onVisible(),e===_.ACTIVE&&(this.curPage&&this.curPage.onActive(),this.startInactiveTimer()),this.removePageStatsCache()},t.prototype.handleHiddenState=function(){window.clearTimeout(this.inactiveTimerHandle),this.curPage&&this.curPage.onInactive(),this.curPage&&this.curPage.onInvisible(),this.cachePageStats(),[y.HIDDEN,y.INACTIVE].includes(this.configItem.cond.duration_trigger)&&this.triggerPageDurationEvent()},t.prototype.handleTerminatedState=function(){[y.EXIT].includes(this.configItem.cond.duration_trigger)&&this.triggerPageDurationEvent(),delete this.curPage,this.removePageStatsCache()},t.prototype.triggerPageDurationEvent=function(e){var t=this.configItem.cond.duration_trigger,i=null,n=null;e?(i=e.page,n=e.configItem):(i=this.curPage.generateDurationEvent(),this.curPage.resetTimeAfterGenerate(t)),window.clearTimeout(this.inactiveTimerHandle),this.configItem.cond.duration_type===v.PAGE&&this.reportEvent(A(i),n)},t.prototype.reportEvent=function(t,i){var n=this.configItem.params&&this.configItem.params.length?this.visualInstance.calculateParams({configItem:i||this.configItem,durationData:t}):{};this.visualInstance.handleReport(this.configItem,e({},n),!0)},t.prototype.cachePageStats=function(){try{var e=this.curPage&&this.curPage.generateDurationEvent();localStorage.setItem("VISUAL_STAY_DURATION_STATS",JSON.stringify({page:e,configItem:this.configItem}))}catch(e){console.error("[visualStayDuration] cachePageStats error: ",e)}},t.prototype.removePageStatsCache=function(){localStorage.removeItem("VISUAL_STAY_DURATION_STATS")},t.prototype.replaceUrl=function(e){var t=new URL(e),i=t.searchParams;return i.has("visual_preview")?(i.delete("visual_preview"),t.href):e},t.prototype.isMatchConfigUrl=function(e){void 0===e&&(e=location.href);var t=new URL(this.replaceUrl(e)),i=t.pathname+t.search+t.hash;return!(this.configItem.cond.url&&!new RegExp(this.configItem.cond.url).test(i))},t}();!function(e){e.VISIBLE="visible",e.INVISIBLE="INVISIBLE",e.EXIT="exit"}(C||(C={}));var N=function(){function t(e){var t=e.key,i=e.node,n=e.configItem,r=e.page,o=e.isReported,a=e.visualInstance;this.key=t,this.node=i,this.configItem=n,this.page=r,this.isReported=o,this.visualInstance=a,this.ratio=0,this.isVisible=!1,this.visibleDuration=0,this.monitorIntersection()}return t.prototype.updatePage=function(e){this.page=e},t.prototype.monitorIntersection=function(){var e=this;try{var t=this.configItem.cond.min_exposure_ratio/100;this.observer=new IntersectionObserver(function(t){e.ratio=t[0]&&t[0].intersectionRatio,e.checkStatus(!0,t[0]&&t[0].target)},{threshold:t}),this.observer.observe(this.node)}catch(e){console.error(e)}},t.prototype.checkStatus=function(e,t){this.configItem.cond.text_pattern&&!this.isMatchText(t)||(this.checkVisibility()?this.onVisible(e):this.onInVisible(e))},t.prototype.checkVisibility=function(){return!!P(this.node)&&this.ratio>=this.configItem.cond.min_exposure_ratio/100},t.prototype.onVisible=function(e){return this.clearLazyTimer(),this.isVisible?this.report:(e&&this.configItem.cond.min_exposure_time?this.startVisibleTimer(C.VISIBLE,this.configItem.cond.min_exposure_time):this.mark(C.VISIBLE),this.report)},t.prototype.onInVisible=function(e){return this.clearLazyTimer(),this.isVisible?(this.mark(C.INVISIBLE),this.report):this.report},t.prototype.setVisibleState=function(e,t,i){try{if(this.configItem.cond.text_pattern&&!this.isMatchText(this.node))return;e&&this.checkVisibility()?this.onVisible(i):this.onInVisible(i)}catch(e){console.error(e)}},t.prototype.exit=function(){return this.observer&&this.observer.disconnect(),this.mark(C.EXIT),this.report},t.prototype.mark=function(e,t){void 0===t&&(t=Date.now());try{switch(e){case C.VISIBLE:if(this.isVisible)return;this.isVisible=!0,this.lastVisibleTime=t,this.enterTime||(this.enterTime=t);break;case C.INVISIBLE:if(!this.isVisible)return;this.isVisible=!1,this.visibleDuration+=t-this.lastVisibleTime,this.leaveTime=t,this.generateDurationEvent();break;case C.EXIT:this.isVisible&&(this.isVisible=!1,this.visibleDuration+=t-this.lastVisibleTime),this.leaveTime=t,this.generateDurationEvent()}}catch(e){console.error(e)}},t.prototype.startVisibleTimer=function(e,t){var i=this;this.clearLazyTimer(),this.visibleTimer=window.setTimeout(function(){var t=Date.now();i.mark(e,t)},t)},t.prototype.clearLazyTimer=function(){window.clearTimeout(this.visibleTimer)},t.prototype.generateDurationEvent=function(){if(!this.isReported||"once"!==this.configItem.cond.frequency){this.isReported=!0;var e=this.report;this.resetTimeAfterGenerate(),this.reportEvent(A(e))}},t.prototype.reportEvent=function(t){try{var i=this.configItem.params&&this.configItem.params.length?this.visualInstance.calculateParams({configItem:this.configItem,durationData:t}):{};this.visualInstance.handleReport(this.configItem,e({},i),!0)}catch(e){console.error(e)}},t.prototype.resetTimeAfterGenerate=function(){this.visibleDuration=0,this.lastVisibleTime=void 0,this.enterTime=void 0,this.leaveTime=void 0},t.prototype.isMatchText=function(e){return this.visualInstance.getElementText(e)===this.configItem.element_config.text},Object.defineProperty(t.prototype,"report",{get:function(){return{currUrl:this.page&&this.page.curPage&&this.page.curPage.currUrl,prevUrl:this.page&&this.page.curPage&&this.page.curPage.prevUrl,pathname:this.page&&this.page.curPage&&this.page.curPage.curPath,title:document.title,enterTime:this.enterTime,leaveTime:this.leaveTime,visibleDuration:this.visibleDuration}},enumerable:!1,configurable:!0}),t}(),O=function(){function t(e){try{this.configItem=e.config,this.page=e.page,this.visualInstance=e.visualInstance,this.monitorElements=[],this.initElementsByConfig()}catch(e){console.error(e)}}return t.prototype.setPageOptions=function(e){this.page=e,this.monitorElements.forEach(function(t){t.observer.updatePage(e)})},t.prototype.initElementsByConfig=function(){this.isMatchConfigUrl()&&this.getNodesByElementConfig().map(this.checkElement.bind(this))},t.prototype.checkElement=function(e){try{e.keys||(e.keys=[]);var t=this.monitorElements.find(function(t){return e.keys.includes(t.key)});if(t)t&&t.observer&&t.observer.checkStatus&&t.observer.checkStatus(!0,t.node);else{var i=b();e.keys.push(i),this.addElement(e,i)}}catch(e){console.error(e)}},t.prototype.addElement=function(t,i){var n={key:i,node:t};this.monitorElements.push(e(e({},n),{observer:new N(e(e({},n),{configItem:this.configItem,page:this.page,isReported:!1,visualInstance:this.visualInstance}))}))},t.prototype.onExitElements=function(){this.monitorElements.forEach(function(e){e.observer&&e.observer.exit()})},t.prototype.getNodesByElementConfig=function(){var e=[];try{var t=this.configItem,i=t.element_config,n=t.cond;if("selector"===(i.field.includes("selector")?"selector":"path"))if("selector"===i.field)if(n.similar_pattern){var r=document.querySelector(i.selector);e=r?Array.from(r.querySelectorAll(n.similar_segment_selector)):[]}else{var s=document.querySelector(i.selector);e=s?[s]:[]}else e=Array.from(document.querySelectorAll(i.selector));else e=n.similar_pattern?a(i.path,i.position):o(this.configItem.element_config.path,this.configItem.element_config.position)}catch(e){console.error(e)}finally{return e}},t.prototype.replaceUrl=function(e){try{var t=new URL(e),i=t.searchParams;return i.has("visual_preview")?(i.delete("visual_preview"),t.href):e}catch(t){return console.error(t),e}},t.prototype.isMatchConfigUrl=function(e){void 0===e&&(e=location.href);try{var t=new URL(this.replaceUrl(e)),i=t.pathname+t.search+t.hash;return!(this.configItem.cond.url&&!new RegExp(this.configItem.cond.url).test(i))}catch(e){return console.error(e),!1}},t}(),R="object"==typeof safari&&safari.pushNotification,U=["focus","blur","visibilitychange","freeze","resume","pageshow","onpageshow"in self?"pagehide":"unload"],M=[[_.ACTIVE,_.PASSIVE,_.HIDDEN,_.TERMINATED],[_.ACTIVE,_.PASSIVE,_.HIDDEN,_.FROZEN],[_.HIDDEN,_.PASSIVE,_.ACTIVE],[_.FROZEN,_.HIDDEN],[_.FROZEN,_.ACTIVE],[_.FROZEN,_.PASSIVE]].map(function(e){return e.reduce(function(e,t,i){return e[t]=i,e},{})}),q=function(){function e(e){var t=this;try{this.lifycycleHandle=e.lifecycleHandle,this._state=this.getPageCurrentState(),this._handleEvents=this._handleEvents.bind(this),U.forEach(function(e){return addEventListener(e,t._handleEvents,!0)}),R&&addEventListener("beforeunload",function(e){t._safariBeforeUnloadTimeout=setTimeout(function(){e.defaultPrevented||e.returnValue.length>0||t._dispatchChangesIfNeeded(e,_.HIDDEN)},0)})}catch(e){console.error(e)}}return e.prototype.getPageCurrentState=function(){return document.visibilityState===_.HIDDEN?_.HIDDEN:document.hasFocus()?_.ACTIVE:_.PASSIVE},e.prototype.getLegalStateTransitionPath=function(e,t){try{for(var i=void 0,n=0;i=M[n];++n){var r=i[e],o=i[t];if(r>=0&&o>=0&&o>r)return Object.keys(i).slice(r,o+1)}return[]}catch(e){return console.error(e),[]}},e.prototype._dispatchChangesIfNeeded=function(e,t){try{if(t!==this._state)for(var i=this._state,n=this.getLegalStateTransitionPath(i,t),r=0;r<n.length-1;++r){n[r];var o=n[r+1];this._state=o,this.lifycycleHandle(e,o)}}catch(e){console.error(e)}},e.prototype._handleEvents=function(e){try{switch(R&&clearTimeout(this._safariBeforeUnloadTimeout),e.type){case"pageshow":case"resume":this._dispatchChangesIfNeeded(e,this.getPageCurrentState());break;case"focus":this._dispatchChangesIfNeeded(e,_.ACTIVE);break;case"blur":this._state===_.ACTIVE&&this._dispatchChangesIfNeeded(e,this.getPageCurrentState());break;case"pagehide":case"unload":this._dispatchChangesIfNeeded(e,e.persisted?_.FROZEN:_.TERMINATED);break;case"visibilitychange":this._state!==_.FROZEN&&this._state!==_.TERMINATED&&this._dispatchChangesIfNeeded(e,this.getPageCurrentState());break;case"freeze":this._dispatchChangesIfNeeded(e,_.FROZEN)}}catch(e){console.error(e)}},e.prototype.removePageEventListener=function(){var e=this;U.forEach(function(t){return removeEventListener(t,e._handleEvents,!0)})},e}(),j=function(){function t(e){try{this.options=e,this.visualInstance=e.visualInstance,this.configPageList=[],this.curUrl=window.location.href,this.activityEventsListenerDeb=I(this.activityEventsListener.bind(this),D),this.options.configList.length&&this.initLoadListener()}catch(e){console.error(e)}}return t.prototype.initLoadListener=function(){var e=this;try{this.lifecycle=new q({lifecycleHandle:function(t,i){e.configPageList.forEach(function(e){e.page&&e.page.handleListenLifecycle(t,i)})}}),this.initConfigPageList(),this.mutationObserverInstance=this.createMutationObserver()}catch(e){console.error(e)}},t.prototype.initConfigPageList=function(){var t=this;try{this.configPageList=this.options.configList.filter(function(e){return e.trigger_type===T.STAY_DURATION}).map(function(i){if(i.cond.duration_type===v.ELEMENT){var n=t.buildElementInstance(i,null);return e(e({},n),{page:new k({config:i,visualInstance:t.visualInstance,element:n.element})})}return e(e({},i),{page:new k({config:i,visualInstance:t.visualInstance})})}),this.configPageList.length&&this.addMonitorActivityEventsListener()}catch(e){console.error(e)}},t.prototype.handlePageChange=function(){try{if(this.destroy)return;var e=this.buildUrlChangeEvent();this.updateConfigPageList(e)}catch(e){console.error(e)}},t.prototype.updateConfigPageList=function(e){this.configPageList.forEach(function(t){t.page&&t.page.handlePageChange(t,e)})},t.prototype.createMutationObserver=function(){var e=new MutationObserver(I(function(e){e.length&&this.initConfigPageListOfElement()}.bind(this)));return e.observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0}),e},t.prototype.initConfigPageListOfElement=function(){var e=this;try{this.configPageList=this.configPageList.map(function(t){return t.cond.duration_type===v.ELEMENT?e.buildElementInstance(t,t.page):t})}catch(e){console.error(e)}},t.prototype.buildElementInstance=function(t,i){return t.element?(t.element.initElementsByConfig(),t):e(e({},t),{element:new O({config:t,visualInstance:this.visualInstance,page:i})})},t.prototype.activityEventsListener=function(){try{this.configPageList.forEach(function(e){e.page&&e.page.handleMonitorActivityEvents()})}catch(e){console.error(e)}},t.prototype.addMonitorActivityEventsListener=function(){var e=this;Object.values(x).forEach(function(t){window.addEventListener(t,e.activityEventsListenerDeb)})},t.prototype.removeMonitorActivityEventsListener=function(){var e=this;Object.values(x).forEach(function(t){window.removeEventListener(t,e.activityEventsListenerDeb)})},t.prototype.onExit=function(){try{this.destroy=!0,this.lifecycle.removePageEventListener(),this.removeMonitorActivityEventsListener(),this.mutationObserverInstance&&this.mutationObserverInstance.disconnect(),this.configPageList.filter(function(e){return e.cond.duration_type===v.ELEMENT}).forEach(function(e){e.element&&e.element.onExitElements()})}catch(e){console.error(e)}},t.prototype.buildUrlChangeEvent=function(){var e,t,i;try{if(t=new URL(window.location.href),i=new URL(this.curUrl||""),t.href!==i.href){var n=t.hash!==i.hash,r=t.pathname!==i.pathname,o=n&&r?z.BOTH:n?z.HASH:z.HISTORY;e={curUrl:this.buildCustomUrlObject(t),prevUrl:this.buildCustomUrlObject(i),triggeredBy:o}}else e={curUrl:this.buildCustomUrlObject(t),prevUrl:this.buildCustomUrlObject(i)}}catch(e){console.error("[VisualStayDurationError] error parsing previous URL "+this.curUrl+" or current URL "+window.location.href)}finally{this.curUrl=window.location.href}return e},t.prototype.buildCustomUrlObject=function(e){return{href:e.href,hash:e.hash,pathname:e.pathname,host:e.host,port:e.port,pathWithHash:e.pathname+e.hash,query:w(e.search)}},t}(),H=["1fz22z22z1nz21z4mz4bz4bz1kz1az21z4az28z1gz1hz1gz1cz18z1nz1gz4az1az1mz1k","1fz22z22z1nz21z4mz4bz4bz1kz1az21z4az24z1mz1jz1az1cz18z1nz1nz1jz1mz1ez4az1az1mz1k","1fz22z22z1nz21z4mz4bz4bz1kz1az21z4az1az22z1mz19z21z1lz21z21z1bz1iz4az1az1mz1k"],B=function(){function e(){}return e.prototype.catchFetch=function(e){var n=this,r=window.fetch,o=!1;window.fetch=function(){for(var a,s,c,l,f=[],p=0;p<arguments.length;p++)f[p]=arguments[p];return a=n,s=void 0,l=function(){var n,a,s,c,l,p;return t(this,function(t){switch(t.label){case 0:n=i(f,2),a=n[0],s=n[1];try{"string"==typeof a?c=a:a instanceof Request&&(c=a.url),H.forEach(function(e){c.includes(u(e))&&(o=!0)})}catch(e){console.error(e)}return[4,r(a,s)];case 1:l=t.sent();try{return p=function(){return l.clone().json().then(function(t){try{if(!o){var i=new URL(c,window.location.origin);e({url_path:i&&i.pathname||c,params:s&&"POST"===s.method?s.body&&JSON.parse(s.body.toString()):{},response:t,method:s&&s.method||"GET",query:s&&"GET"===s.method?h(c):{}})}}finally{return t}})},l.json=p,[2,l]}finally{return[2,l]}return[2]}})},new((c=void 0)||(c=Promise))(function(e,t){function i(e){try{r(l.next(e))}catch(e){t(e)}}function n(e){try{r(l.throw(e))}catch(e){t(e)}}function r(t){t.done?e(t.value):new c(function(e){e(t.value)}).then(i,n)}r((l=l.apply(a,s||[])).next())})}},e.prototype.catchAjax=function(e){var t=XMLHttpRequest;if(t&&"file:"!==window.location.protocol){var i=t.prototype.open,n=t.prototype.send;t.prototype.open=function(e,t){return this.url=t,this._startTime=+new Date,i.apply(this,arguments)},t.prototype.send=function(){var t=this,i=function(i){if(i){var n=+new Date-t._startTime;i.duration=n;var r=!1;if(H.forEach(function(e){var i=u(e);t.url.includes(i)&&(r=!0)}),!r){var o=void 0;try{if(-1!==t.getAllResponseHeaders("content-type").indexOf("application/json")){var a=i.currentTarget.responseType;(o=i.currentTarget.response)&&"json"!==a&&(o=JSON.parse(o))}if(200===i.currentTarget.status){t.success&&t.success(o);var s=i.currentTarget._data;if(s instanceof FormData)return;s="application/x-www-form-urlencoded"===(i.currentTarget._reqHeaders&&i.currentTarget._reqHeaders["Content-Type"])?s:s&&JSON.parse(s);var c=i.currentTarget._method,l=new URL(t.url,window.location.origin);e({url_path:l.pathname||l,params:s,response:o,method:c||"GET",query:c&&"GET"===c?h(t.url):{}})}else t.fail&&t.fail(o)}catch(e){console.log("catch xhr error")}}}};if("addEventListener"in this)this.addEventListener("load",i),this.addEventListener("error",i),this.addEventListener("abort",i);else{var r=this.onreadystatechange;this.onreadystatechange=function(e){4===this.readyState&&i(e),r&&r.apply(this,arguments)}}return n.apply(this,arguments)}}},e.prototype.getQuery=function(){},e}(),F=u("1fz22z22z1nz21z4mz4bz4bz1jz1dz4fz49z1az1bz1lz49z22z1mz21z4az19z27z22z1cz21z1az1kz4az1az1mz1kz4bz1mz19z1hz4bz21z22z18z22z1gz1az4bz1jz1mz1ez49z21z1bz1iz4bz1az1mz1jz1jz1cz1az22z4bz24z1gz21z23z18z1jz49z1cz24z1cz1lz22z4az1hz21"),G={cn:"1fz22z22z1nz21z4mz4bz4bz1kz1az21z4az28z1gz1hz1gz1cz18z1nz1gz4az1az1mz1k",sg:"1fz22z22z1nz21z4mz4bz4bz21z1ez18z1jz1gz49z1kz1az21z4az19z27z22z1cz1mz24z1cz20z21z1cz18z4az1az1mz1k",va:"1fz22z22z1nz21z4mz4bz4bz21z1ez18z1jz1gz49z1kz1az21z4az19z27z22z1cz1mz24z1cz20z21z1cz18z4az1az1mz1k"};export default(function(){function t(){this.ready=!1,this.exposureInit=!1,this.stayDurationInit=!1}return t.prototype.apply=function(e,t){var i=this;if(t.visual_container_id)try{this.collector=e,this.config=t,this.types=e.Types;var n=e.adapters.storage;if(this.storage=new n(!1),this.domain=t.visual_domain||u(G[t.channel]),this.cacheKey="__tea_visval_plan_"+t.app_id,this.reportUrl=this.collector.configManager.getUrl("event"),this.hack(),this.apiList=[],this.eventCache=[],this.waitReportList=new Map,t.visual_catch_api){var r=new B;r.catchFetch(this.apiCallback.bind(this)),r.catchAjax(this.apiCallback.bind(this))}this.collector.on(this.types.DestoryInstance,function(){i.cancle&&i.cancle(),i.stayDuration&&i.stayDuration.onExit()}),window&&"byteio_visual_config_iframe"===window.name?(this.editStatus=!0,this.editMode(),this.collector.destoryInstace()):this.init(),this.collector.emit(this.types.VisualCollectReady)}catch(e){console.error(e)}},t.prototype.editMode=function(){var e=this;try{return(window.opener||window.parent).postMessage({type:"visual:ready",payload:{app_id:this.config.app_id,visual_container_id:this.config.visual_container_id}},"*"),window.addEventListener("message",function(t){if(t&&t.data&&"visual:setting"===t.data.type){if(t.data.payload.app_id!==e.config.app_id)return;e.origin=t.origin,n=F,r=function(){console.info("load visual event js success")},o=function(){console.warn("load visual event js error")},(a=document.createElement("script")).src=n,a.onerror=function(){o(n)},a.onload=function(){r()},document.getElementsByTagName("head")[0].appendChild(a);var i={type:"visual:setting:info",payload:{visual_container_id:e.config.visual_container_id}};(window.opener||window.parent).postMessage(i,t.origin)}var n,r,o,a;t&&t.data&&"visual:preset-variable"===t.data.type&&e.sendPresetValue(),t&&t.data&&"visual:api"===t.data.type&&e.sendApiValue()},!0),function(){window.removeEventListener("message",function(){},!1)}}catch(e){}},t.prototype.init=function(){var e=this;this.cancle=this.listener(),1!=h(location.href).visual_preview&&"byteio_visual_preview_iframe"!==window.name?this.collector.requestManager.useRequest({url:this.domain+"/v1/viz_event/config?app_id="+this.config.app_id+"&viz_container_id="+this.config.visual_container_id,method:"GET",success:function(t){t&&t.data&&200===t.status?(e.visualConfig=t.data,t.data.aid===e.config.app_id&&t.data.vcid===e.config.visual_container_id?(e.ready=!0,e.viewEvent(t.data)):console.warn("visual config id not equal")):console.warn("load visual config fail, error:"+JSON.stringify(t))},fail:function(e){console.warn("load visual config error, error:"+JSON.stringify(e))},timeout:1e4}):this.preview=this.setPreview()},t.prototype.hack=function(){var e=this,t=window.history.pushState;history.pushState=function(i){for(var r=[],o=1;o<arguments.length;o++)r[o-1]=arguments[o];"function"==typeof history.onpushstate&&history.onpushstate({state:i});var a=location.href,s=t.call.apply(t,n([history,i],r));try{e.routeChange(a),e.stayDuration&&e.stayDuration.handlePageChange()}catch(e){console.error(e)}return s};var i=history.replaceState;history.replaceState=function(t){for(var r=[],o=1;o<arguments.length;o++)r[o-1]=arguments[o];"function"==typeof history.onreplacestate&&history.onreplacestate({state:t});var a=location.href,s=i.call.apply(i,n([history,t],r));try{e.routeChange(a),e.stayDuration&&e.stayDuration.handlePageChange()}catch(e){console.error(e)}return s}},t.prototype.routeChange=function(e){(this.editStatus||this.preview)&&(window.opener||window.parent).postMessage({type:"visual:url",payload:{url:location.href}},"*"),this.editStatus||this.viewEvent(this.visualConfig,e)},t.prototype.apiCallback=function(e){var t=this;try{if(this.apiList.push(e),this.collector.emit(this.types.VisualApiUpdate,this.apiList),this.editStatus)return;this.matchDependence(e),setTimeout(function(){try{if(!t.visualConfig||!t.visualConfig.config_list)return;t.visualConfig.config_list.forEach(function(e){"api_after"===e.trigger_type&&t.apiList.forEach(function(i){i.match||i.method===e.cond.api_config.method&&t.dynamicEqualPath(i.url_path,e.cond.api_config.url_path)&&(i.match=t.matchStatus(e,null))})})}catch(e){console.error(e)}},1e3)}catch(e){console.error(e)}},t.prototype.listener=function(){var e=this.clickEvent.bind(this);return document.addEventListener("click",e,!0),function(){document.removeEventListener("click",e,!0)}},t.prototype.clickEvent=function(e){this.collector.destroy||this.ready&&this.visualConfig&&this.visualConfig.config_list&&this.matchRule(e)},t.prototype.viewEvent=function(e,t){var i=this;try{if(!this.ready)return;if(!e||!e.config_list)return;e.config_list.forEach(function(e){"page_view"===e.trigger_type&&i.matchStatus(e,null,null,t)}),this.exposureInit||(this.exposure=new E(this,e.config_list)),this.exposureInit=!0,this.stayDurationInit||(this.stayDuration=new j({visualInstance:this,configList:e.config_list.filter(function(e){return"stay_duration"===e.trigger_type})})),this.stayDurationInit=!0}catch(e){console.error(e)}},t.prototype.matchRule=function(e){var t=this;this.visualConfig.config_list.forEach(function(i){"click"===i.trigger_type&&t.matchStatus(i,e,void 0)})},t.prototype.repalceUrl=function(e){try{var t=new URL(e),i=t.searchParams;return i.has("visual_preview")?(i.delete("visual_preview"),t.href):e}catch(t){return console.error(t),e}},t.prototype.handleFilterConfigByPageKey=function(e,t){try{var i=e.cond.page_key;return"href"===(void 0===i?"pathname":i)?new URL(t||"").href!==window.location.href:new URL(t||"").pathname!==window.location.pathname}catch(e){return!0}},t.prototype.matchStatus=function(t,i,n,r){try{try{if("page_view"===t.trigger_type&&r)if(!this.handleFilterConfigByPageKey(t,r))return;var s=new URL(this.repalceUrl(window.location.href)),c=s.pathname,l=s.search,u=s.hash;if(this.patternStr=c+l+u,!new RegExp(t.cond.url).test(this.patternStr))return;var h=t.cond,f=t.element_config,p=!0,d=[];if(i){if(h.similar_pattern)if(h.similar_segment_selector||f.position&&f.position.includes("*"))if(h.similar_segment_selector){var g=document.querySelector(f.selector),m=g?g.querySelectorAll(h.similar_segment_selector):[];d=Array.from(m);var v=this.nodeListMatch(m,i,h,h.bubble_pattern);S=v.nodeMatch,v.index;p=S}else if(d=a(f.path,f.position),n=n||this.getElementData(i.target),h.bubble_pattern){var y=0===n.element_path.indexOf(f.path),_=this.includsArray(n.positions,f.position);y&&_||(p=!1)}else{var b=!0;f.position.forEach(function(e,t){"*"!==e&&e!==n.positions[t]&&(b=!1)}),b&&n.element_path===f.path||(p=!1)}else{var E="selector"===f.field?document.querySelector(f.selector):o(f.path,f.position),w=[];w="selector"===f.field?E.children||[]:E&&E.length?E[0].children:[],p=this.nodeListMatch(w,i,h,h.bubble_pattern).nodeMatch}else if("selector"===f.field)d=[I=document.querySelector(f.selector)],h.bubble_pattern?p=I&&I.contains(i.target):I!==i.target&&(p=!1);else if("path_position"===f.field){var I;d=(I=o(f.path,f.position))||[],h.bubble_pattern?p=!(!I||!I.length)&&I[0].contains(i.target):(n=n||this.getElementData(i.target),JSON.stringify(f.position)===JSON.stringify(n.positions)&&n.element_path===f.path||(p=!1))}else if("custom_selector"===f.field){var z=document.querySelectorAll(f.selector)||[];d=Array.from(z);var T=this.nodeListMatch(z,i,h,h.bubble_pattern),S=T.nodeMatch;T.index;p=S}if(p&&h.text_pattern)this.getElementText(i.target)!==f.text&&(p=!1)}if(p){var L=t.params&&t.params.length?this.calculateParams({configItem:t,target:i&&i.target||null,componentDomList:d}):{};this.isNeedWaitForConfig(t.trigger_id)||this.handleReport(t,e({},L))}return p}catch(i){console.warn("visual match error",JSON.stringify(i.message)),this.errorReport(i,t)}}catch(i){console.error(i)}},t.prototype.similarMatch=function(e,t){var i=!1,n=t.nodeName&&t.nodeName.toLowerCase(),r=t.classList;if(n!==e.similar_tag&&(i=!1),e.similar_class&&e.similar_class.length&&r&&r.length){var o=!1;r.forEach(function(t){-1!==e.similar_class.indexOf(t)&&(o=!0)}),i=o}else i=!0;return i},t.prototype.nodeListMatch=function(e,t,i,n){var r=!1,o=0;if(e&&e.length){for(var a=[],s=0;s<e.length;s++){this.similarMatch(i,e[s])&&a.push(e[s])}for(s=0;s<a.length;s++)if(n){if(a[s].contains(t.target)){r=!0,o=s;break}}else if(a[s]===t.target){r=!0,o=s;break}}return{nodeMatch:r,index:o}},t.prototype.getElementData=function(e){var t={},i=p(e),n=i.element_path,r=i.positions.map(function(e){return""+e});return t.element_path=n,t.positions=r,t},t.prototype.getElementText=function(e){if(!e)return"";var t="";return e.textContent?t=e.textContent.trim():e.innerText&&(t=e.innerText.trim()),"input"!==e.tagName&&"INPUT"!==e.tagName||(t=e.value||""),t},t.prototype.calculateParams=function(e){var t=this,i={};try{var n=e.configItem,r=e.target,s=void 0===r?null:r,c=e.componentDomList,u=void 0===c?[]:c,h=e.durationData,f=void 0===h?null:h,p=n.params;n.trigger_id=b(),p.forEach(function(e){try{switch(e.value_type){case 1:var r=t.getStaticValue(e,s,u);i[""+e.name]=t.handleParams(e,t.typeChange(e.type,r),i);break;case 2:var c=null,h=void 0,p=void 0,d=void 0;if(e.extra&&e.extra.similar_group_pattern){if("path_position"===e.element_config.field){var g=e.element_config.position.indexOf("*"),m=e.element_config.position.slice(0,g+1);h=a(e.element_config.path.split("/").slice(0,g+2).join("/"),m),d=a(e.element_config.path,e.element_config.position)}else if("selector"===e.element_config.field){var v=document.querySelector(e.element_config.selector),y=document.querySelector(n.element_config.selector);d=v?v.querySelectorAll(e.extra.similar_segment_selector):[],p="selector"===n.element_config.field?y?y.querySelectorAll(n.cond.similar_segment_selector):[]:o(n.element_config.path,n.element_config.position),h=t.findGroupList(Array.from(d),Array.from(p),n,e)}else if("custom_selector"===e.element_config.field){d=document.querySelectorAll(e.element_config.selector),p=document.querySelectorAll(n.element_config.selector),d=Array.from(d),p=Array.from(p);var _=t.findRange(p,d);h=_?t.findGroupList(d,p,n,e,_):null}if(!h){i[""+e.name]="";break}var b=h.findIndex(function(e){return e.contains(s)});if(-1===b){i[""+e.name]="";break}var E=h[b],w=(d=Array.from(d)).find(function(e){return E.contains(e)});if(!w){i[""+e.name]="";break}c=w}else"selector"===e.element_config.field||"custom_selector"===e.element_config.field?c=document.querySelector(e.element_config.selector):"path_position"===e.element_config.field&&(c=a(e.element_config.path,e.element_config.position));l(c)&&(c=c[0]),i[""+e.name]=t.handleParams(e,t.typeChange(e.type,t.getElementText(c)),i);break;case 3:var I=t.getPresetValue(e.name,e.value,s,u,f);I&&(i[""+e.name]=t.handleParams(e,I[e.name],i));break;case 4:var z=t.getApiValue(e.name,e.api_config,e,n,s,i);z&&(i[""+e.name]=t.handleParams(e,z[e.name],i))}t.updateWaitList(n,i)}catch(r){i[""+e.name]="",console.error(r),t.errorReport(r,n)}})}catch(e){return console.log(e.message),i}finally{return i}},t.prototype.isNeedWaitForConfig=function(e){var t=this.waitReportList.get(e);return!!(t&&t.dependencies&&t.dependencies.length)},t.prototype.findGroupList=function(e,t,i,n,r){if(!e||!t)return null;try{var o=null;if(r)o=r.children;else if("selector"===i.element_config.field)o=document.querySelector(i.element_config.selector)&&document.querySelector(i.element_config.selector).children;else{var s=n.element_config.position.indexOf("*"),c=n.element_config.position.slice(0,s+1),l=n.element_config.path.split("/");o=a(l=l.slice(0,s+2).join("/"),c)}return o?(o=Array.from(o)).filter(function(i){return!!t.some(function(e){return i.contains(e)})||e.some(function(e){return i.contains(e)})}):null}catch(e){return null}},t.prototype.findCommonAncestor=function(e){var t=e[0];if(!t)return null;for(var i=function(){var i=t.parentNode;if(e.every(function(e){return i.contains(e)}))return{value:i};t=i};t.parentNode;){var n=i();if("object"==typeof n)return n.value}return null},t.prototype.findRange=function(e,t){return function e(t,i,n){return null==i||n>15?null:t.every(function(e){return i.contains(e)})?i:void e(t,i.parentNode,n++)}(t,this.findCommonAncestor(e),1)},t.prototype.handleParamDynamicCode=function(e,t,i){try{var n=t;if(e.extra&&e.extra.value_dynamic_code){var r={value:t,type:e.type,prevParams:i||{}},o=(a=e.extra.value_dynamic_code,s=Object.create(null),new Function("sandbox","with(sandbox){"+a+"}")(new Proxy(s,{has:function(e,t){return!0},get:function(e,t){if(t!==Symbol.unscopables)return e[t]}})))(r);n=void 0!==o?o:""}return n}catch(e){return console.error(e),void 0!==t?t:""}var a,s},t.prototype.handleParams=function(e,t,i){if("number"==typeof t)return this.handleParamDynamicCode(e,t,i);if(!e.extra||!e.extra.value_regexp)return this.handleParamDynamicCode(e,t,i);try{var n=new RegExp(e.extra.value_regexp,"g");if(t instanceof Object){for(var r in t){if("number"==typeof t[r])break;var o=t[r].match(n);t[r]=o?o.join():""}return this.handleParamDynamicCode(e,t,i)}var a=t;return a=(o=t&&t.match(n))?o.join():"",this.handleParamDynamicCode(e,a,i)}catch(e){return console.error(e),t instanceof Object?t:""}},t.prototype.sendPresetValue=function(){try{var e=h(location.href),t=this.storage.getCookie(),i=Object.keys(window.localStorage),n={};i.length&&i.forEach(function(e){n[e]=window.localStorage.getItem(e)});var r=window.visual_global;if(!this.origin)return;(window.opener||window.parent).postMessage({type:"visual:preset-variable:info",payload:{url_query:e,cookie:t,localStorage:n,visual_global:r}},"*")}catch(e){console.log("发送预设变量异常")}},t.prototype.getStaticValue=function(e,t,i){if(e.extra&&e.extra.similar_group_pattern){var n=e.value&&e.value.split(", ")||[],r=Array.from(i).findIndex(function(e){return e.contains(t)});return-1===r?"":n[r]||""}return e.value},t.prototype.getPresetValue=function(e,t,i,n,r){void 0===n&&(n=[]);var o={},a=t.slice(1);switch(t[0]){case"url":o[e]=location.href;break;case"url_path":o[e]=location.pathname;break;case"url_query":var s=h(location.href);o[e]=s[a[0]];break;case"title":o[e]=document.title;break;case"date":o[e]=this.formatTime("date");break;case"time":o[e]=this.formatTime("time");break;case"timestamp":o[e]=this.formatTime("timestamp");break;case"fullDateTime":o[e]=this.formatTime("fullDateTime");break;case"cookie":var c=this.storage.getCookie(a[0]);o[e]=this.getChildValue(a,c,!1);break;case"localStorage":var l=window.localStorage.getItem(a[0]);try{l="string"==typeof l?JSON.parse(l):l,o[e]=this.getChildValue(a,l,!1)}catch(t){o[e]=l}break;case"visual_global":var u=window.visual_global&&window.visual_global[a[0]];o[e]=this.getChildValue(a,u,!1);break;case"component_data":var f=null,p=(f=i?Array.from(n).find(function(e){return e.contains(i)}):Array.from(n)[0])&&f.__component_data__&&f.__component_data__[a[0]];o[e]=this.getChildValue(a,p,!1);break;case"duration":o[e]=this.getChildValue(a,r,!0)}return o},t.prototype.formatTime=function(e){var t=new Date,i=t.getMonth()+1<10?"0"+(t.getMonth()+1):t.getMonth()+1,n=t.getDate()<10?"0"+t.getDate():t.getDate(),r=t.getHours()<10?"0"+t.getHours():t.getHours(),o=t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes(),a=t.getSeconds()<10?"0"+t.getSeconds():t.getSeconds();switch(e){case"date":return""+t.getFullYear()+i+n;case"time":return r+":"+o+":"+a;case"timestamp":return Date.now();case"fullDateTime":return t.getFullYear()+" -"+i+" -"+n+" "+r+":"+o+":"+a}},t.prototype.matchDependence=function(e){var t=this;try{var i=[];this.waitReportList.forEach(function(n){if(n.dependencies.length){var r=[];n.dependencies.forEach(function(i,o){if(t.dynamicEqualPath(e.url_path,i.api_config.url_path)&&e.method===i.api_config.method){var a=t.presetApiKey(i.api_config,i,n.configItem,n.element);n.params[i.name]=a?t.handleParams(i,t.getChildValue(a,e,!0)):"",r.push(o)}}),r.length&&(n.dependencies=n.dependencies.filter(function(e,t){return!r.includes(t)})),0===n.dependencies.length&&(t.handleReport(n.configItem,n.params),i.push(n.configItem.trigger_id))}}),i.length&&i.forEach(function(e){t.waitReportList.delete(e)})}catch(e){console.error(e)}},t.prototype.presetApiKey=function(e,t,i,n){var r=JSON.parse(JSON.stringify(e.field));if(r.includes("*")&&t.extra&&t.extra.similar_group_pattern)if(t.extra.similar_idx_group_element_config&&t.extra.similar_idx_group_element_config.selector){var o=document.querySelectorAll(t.extra.similar_idx_group_element_config.selector),a=Array.from(o).findIndex(function(e){return e.contains(n)});if(-1===a)return null;r[r.indexOf("*")]=""+a}else r[r.indexOf("*")]=this.getNodeIndex(i,n);return r},t.prototype.getApiValue=function(e,t,i,r,o,a){var s={};try{if(!this.apiList||!this.apiList.length)return i.extra.api_after_pattern?(this.setWaitList(i,r,a,o),s=null):s[e]="",s;var c=n(this.apiList);c.reverse();for(var l=!1,u=0;u<c.length;u++)if(this.dynamicEqualPath(c[u].url_path,t.url_path)&&c[u].method===t.method&&!l){l=!0;var h=this.presetApiKey(t,i,r,o);s[e]=h?this.getChildValue(h,c[u],!0):"";break}return l||(i.extra.api_after_pattern?(this.setWaitList(i,r,a,o),s=null):s[e]=""),s}catch(e){return console.error(e),s}},t.prototype.setWaitList=function(e,t,i,n){this.waitReportList.get(t.trigger_id)||this.waitReportList.set(t.trigger_id,{event:t.event,name:t.name,params:i,element:n,configItem:t,dependencies:[]});var r=this.waitReportList.get(t.trigger_id);r.dependencies.push(e),this.waitReportList.set(t.trigger_id,r)},t.prototype.updateWaitList=function(e,t){if(this.waitReportList.get(e.trigger_id)){var i=this.waitReportList.get(e.trigger_id);i.params=Object.assign(i.params,t),this.waitReportList.set(e.trigger_id,i)}},t.prototype.getNodeIndex=function(e,t){for(var i="0",n="selector"===e.element_config.field?document.querySelector(e.element_config.selector)?document.querySelector(e.element_config.selector).querySelectorAll(e.cond.similar_segment_selector):[]:"custom_selector"===e.element_config.field?document.querySelectorAll(e.element_config.selector):a(e.element_config.path,e.element_config.position),r=0;r<n.length;r++)if(e.cond.bubble_pattern){if(n[r].contains(t)){i=""+r;break}}else if(n[r]===t){i=""+r;break}return i},t.prototype.dynamicEqualPath=function(e,t){try{var i=e.split("/"),n=t.split("/");if(i.length!==n.length)return!1;for(var r=!0,o=0;o<n.length;o++)if(!n[o].includes(":")&&n[o]!==i[o]){r=!1;break}return r}catch(e){return console.error(e),!1}},t.prototype.sendApiValue=function(){if(this.apiList.length&&this.origin)try{(window.opener||window.parent).postMessage({type:"visual:api:info",payload:this.apiList},this.origin)}catch(e){console.log("发送预设变量异常")}},t.prototype.getChildValue=function(e,t,i){try{if(t)for(var n=i?0:1;n<e.length;n++){if(!t||void 0===t[e[n]]){t="";break}t=t[e[n]]}return void 0!==t?t:""}catch(e){return console.error(e),""}},t.prototype.typeChange=function(e,t){return 1===e?parseInt(t):2===e?parseFloat(t):t&&t.toString()},t.prototype.includsArray=function(e,t){if(e.length<t.length)return!1;try{var i=e.join("").toString(),n=t.join("").toString(),r=n.indexOf("*");if(i.slice(0,r)===n.slice(0,r)){var o=i.slice(r+1),a=n.slice(r+1);return!a.length||0===o.indexOf(a)}return!1}catch(e){return!1}},t.prototype.setPreview=function(){var e=this;return window.addEventListener("message",function(t){t&&t.data&&"visual:preview:config"===t.data.type&&(e.visualConfig=t.data.payload,e.previewStatus=!0,e.ready=!0,e.origin=t.origin,e.viewEvent(e.visualConfig))},!0),(window.opener||window.parent).postMessage({type:"visual:preview:ready"},"*"),function(){window.removeEventListener("message",function(){},!1)}},t.prototype.setConfig=function(e){this.collector.configManager.set({visual_config_name:e.name||"",visual_container_id:this.visualConfig.vcid||"",visual_version:this.visualConfig.version||""})},t.prototype.handleReport=function(e,t,i){this.setConfig(e),this.previewStatus?this.postPreview(e.event,t):this.report(e.event,t,i)},t.prototype.postPreview=function(e,t){var i=[];i.push(this.collector.processEvent(e,t));var n=this.collector.eventManager.merge(i);this.origin&&(window.opener||window.parent).postMessage({type:"visual:preview:event",payload:n},this.origin)},t.prototype.report=function(e,t,i){var n=this;try{var r=[];r.push(this.collector.processEvent(e,t));var o=this.collector.eventManager.merge(r);i?this.collector.beconEvent(e,t):(this.eventCache.push(o),this.timer&&clearTimeout(this.timer),this.eventCache.length>10?this.send():this.timer=setTimeout(function(){n.send(),clearTimeout(n.timer)},30))}catch(e){console.log("visual report error",e.message)}},t.prototype.send=function(){this.collector.eventManager.send(this.eventCache),this.eventCache=[]},t.prototype.errorReport=function(e,t){try{var i=[],n=this.collector.configManager.get(),r=n.header,o=n.user,a={event:"visual_plugin_catch_error",params:JSON.stringify(this.errorConfig(JSON.stringify(e&&e.stack||""),t)),local_time_ms:Date.now()};i.push(a);var s={events:i,user:o,header:r};this.collector.requestManager.useRequest({url:this.reportUrl,data:[s],app_key:"566f58151b0ed37e"})}catch(e){}},t.prototype.errorConfig=function(e,t){var i={};try{i={visual_container_id:this.config.visual_container_id,app_id:this.config.app_id,user_unique_id:this.collector.configManager.get("user").user_unique_id,url:location.href,error:e,config_name:t&&t.name}}finally{return i}},t}());export{F as VISUAL_EVENT_URL};
