export default(function(){function t(){this.retryWaitTime=3e3,this.retryStatus=!1,this.retryCacheStatus=!1}return t.prototype.apply=function(t,e){var r=this;if(e.enable_storage&&!e.disable_storage&&(this.collect=t,this.config=e,!this.collect.destroy)){var a=t.Types,n=t.adapters.storage;this.storage=new n(!1),this.eventUrl=this.collect.configManager.getUrl("event"),this.eventKey="__tea_cache_events_"+e.app_id,this.storageNum=e.storage_num||50,this.retryNum=e.retry_num||3,this.retryInterval=1e3,t.on(a.SubmitError,function(t){"f_data"!==t.type&&r.storeData(t)}),t.on(a.Ready,function(){r.checkStorage()})}},t.prototype.retryRightNow=function(t){var e=this;if(this.retryStatus)this.errorCache.push(t);else{var r=0;this.retryStatus=!0;var a=setInterval(function(){if(3===r)return e.storeData(e.errorCache),e.retryStatus=!1,void clearInterval(a);var n=t.eventData;e.fetchData(n,function(){e.retryStatus=!1,clearInterval(a),e.retryCacheStatus&&e.errorCache.splice(0,1),e.errorCache.length&&(e.retryCacheStatus=!0,e.retryRightNow(e.errorCache[0]))},function(){r++})},this.retryInterval)}},t.prototype.storeData=function(t){var e=this.storage.getItem(this.eventKey),r=t.eventData;Object.keys(e).length!==this.storageNum&&(e[Date.now()]=r,this.storage.setItem(this.eventKey,e))},t.prototype.checkStorage=function(){var t=this;try{if(!window.navigator.onLine)return;var e=this.storage.getItem(this.eventKey);if(!e||!Object.keys(e).length)return;var r={events:[{event:"ontest",params:{app_id:this.config.app_id},local_time_ms:Date.now()}],user:{user_unique_id:this.collect.configManager.get("web_id")},header:{}};this.fetchData([r],function(){var r=JSON.parse(JSON.stringify(e)),a=function(a){t.fetchData(e[a],function(){delete r[a],t.storage.setItem(t.eventKey,r)},function(){},!1)};for(var n in e)a(n)},function(){console.log("network errorï¼Œcompensate report fail")},!0)}catch(t){console.warn("error check storage")}},t.prototype.fetchData=function(t,e,r,a){this.collect.requestManager.useRequest({url:this.eventUrl,data:t,timeout:3e4,success:e,fail:r,app_key:a?"566f58151b0ed37e":""})},t}());
