"use strict";var Types,DebuggerMesssge,__assign=function(){return(__assign=Object.assign||function(t){for(var e,i=1,s=arguments.length;i<s;i++)for(var a in e=arguments[i])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)},isObject=function(t){return null!=t&&"[object Object]"==Object.prototype.toString.call(t)},getIndex=function(){var t=+Date.now()+Number((""+Math.random()).slice(2,8));return function(){return t+=1}}(),isSupVisChange=function(){var t=0;return["hidden","msHidden","webkitHidden"].forEach(function(e){void 0!==document[e]&&(t=1)}),t},Alive=function(){function t(t,e){this.maxDuration=432e5,this.aliveDTime=6e4,this.options={aliveName:"predefine_page_alive",params:{}},this.focusState=!0,this.collect=t,this.config=e,this.pageStartTime=Date.now(),this.sessionStartTime=this.pageStartTime,this.timerHandler=null,isObject(e.enable_stay_duration)&&(this.options=Object.assign(this.options,e.enable_stay_duration)),this.hard=this.options.mode&&"hard"===this.options.mode,this.focusState=document.hasFocus(),this.aliveDTime=this.options.aliveTime||6e4}return t.prototype.setParams=function(t,e,i){this.set_path=t,this.set_url=i,this.set_title=e},t.prototype.enable=function(t,e,i){this.url_path=t,this.url=i,this.title=e,this.disableCallback=this.enablePageAlive(),this.hard&&(this.removeMode=this.hardMode())},t.prototype.disable=function(){this.disableCallback(),this.pageStartTime=Date.now(),this.hard&&this.removeMode&&this.removeMode()},t.prototype.sendEvent=function(t,e){void 0===e&&(e=!1);var i=e?this.aliveDTime:Date.now()-this.sessionStartTime;i<0||i>this.aliveDTime||Date.now()-this.pageStartTime>this.maxDuration||e&&"hidden"===document.visibilityState||this.hard&&!this.focusState||(this.collect.beconEvent(this.options.aliveName,__assign({url_path:this.getParams("url_path"),title:this.getParams("title"),url:this.getParams("url"),duration:i,is_support_visibility_change:isSupVisChange(),startTime:this.sessionStartTime,hidden:document.visibilityState,leave:t,mode:this.hard?"hard":"normal",focusState:this.focusState},this.options.params)),this.sessionStartTime=Date.now())},t.prototype.getParams=function(t){switch(t){case"url_path":return this.set_path||this.url_path||location.pathname;case"title":return this.set_title||this.title||document.title||location.pathname;case"url":return this.set_url||this.url||location.href}},t.prototype.setUpTimer=function(){var t=this;return this.timerHandler&&clearInterval(this.timerHandler),setInterval(function(){Date.now()-t.sessionStartTime>t.aliveDTime&&t.sendEvent(!1,!0)},1e3)},t.prototype.visibilitychange=function(){"hidden"===document.visibilityState?this.timerHandler&&(clearInterval(this.timerHandler),this.sendEvent(!1)):"visible"===document.visibilityState&&(this.sessionStartTime=Date.now(),this.timerHandler=this.setUpTimer())},t.prototype.beforeunload=function(){document.hidden||this.sendEvent(!0)},t.prototype.enablePageAlive=function(){var t=this;this.timerHandler=this.setUpTimer();var e=this.visibilitychange.bind(this),i=this.beforeunload.bind(this);return document.addEventListener("visibilitychange",e),window.addEventListener("pagehide",i),function(){t.beforeunload(),document.removeEventListener("visibilitychange",e),window.removeEventListener("pagehide",i)}},t.prototype.hardMode=function(){var t=this,e=function(){t.timerHandler&&(clearInterval(t.timerHandler),t.sendEvent(!1)),t.focusState=!1},i=function(){t.focusState=!0,t.sessionStartTime=Date.now(),t.timerHandler=t.setUpTimer()};return window.addEventListener("blur",e),window.addEventListener("focus",i),function(){window.removeEventListener("blur",e),window.removeEventListener("focus",i)}},t}(),Close=function(){function t(t,e){var i=this;this.maxDuration=432e5,this.aliveDTime=6e4,this.options={closeName:"predefine_page_close",params:{}},this.focusState=!0,this.visibilitychange=function(){"hidden"===document.visibilityState?i.activeEndTime=Date.now():"visible"===document.visibilityState&&(i.activeEndTime&&(i.totalTime+=i.activeEndTime-i.activeStartTime,i.activeTimes+=1),i.activeEndTime=void 0,i.activeStartTime=Date.now())},this.beforeunload=function(){if(i.totalTime+=(i.activeEndTime||Date.now())-i.activeStartTime,i.config.autotrack){try{window.sessionStorage.setItem("_tea_cache_duration",JSON.stringify({duration:i.totalTime,page_title:document.title||location.pathname}))}catch(t){}}i.sendEventPageClose()},this.collect=t,this.config=e,this.maxDuration=e.maxDuration||e.max_duration||864e5,this.pageStartTime=Date.now(),isObject(e.enable_stay_duration)&&(this.options=Object.assign(this.options,e.enable_stay_duration)),this.hard=this.options.mode&&"hard"===this.options.mode,this.focusState=document.hasFocus(),this.resetData()}return t.prototype.setParams=function(t,e,i){this.set_path=t,this.set_url=i,this.set_title=e},t.prototype.resetParams=function(t,e,i){this.url_path=t,this.url=i,this.title=e},t.prototype.enable=function(t,e,i){this.url_path=t,this.url=i,this.title=e,this.disableCallback=this.enablePageClose(),this.hard&&(this.removeMode=this.hardMode())},t.prototype.disable=function(){this.disableCallback(),this.hard&&this.removeMode&&this.removeMode()},t.prototype.resetData=function(){this.activeStartTime=void 0===this.activeStartTime?this.pageStartTime:Date.now(),this.activeEndTime=void 0,this.activeTimes=1,this.totalTime=0,this.resetParams(location.pathname,document.title,location.href)},t.prototype.sendEventPageClose=function(){var t=Date.now()-this.pageStartTime;this.totalTime<0||t<0||this.totalTime>=this.maxDuration||this.hard&&!this.focusState||(this.collect.beconEvent(this.options.closeName,__assign({url_path:this.getParams("url_path"),title:this.getParams("title"),url:this.getParams("url"),active_times:this.activeTimes,duration:this.totalTime,total_duration:t,is_support_visibility_change:isSupVisChange(),mode:this.hard?"hard":"normal",focusState:this.focusState},this.options.params)),this.pageStartTime=Date.now(),this.resetData())},t.prototype.getParams=function(t){switch(t){case"url_path":return this.set_path||this.url_path||location.pathname;case"title":return this.set_title||this.title||document.title||location.pathname;case"url":return this.set_url||this.url||location.href}},t.prototype.enablePageClose=function(){var t=this,e=this.visibilitychange.bind(this),i=this.beforeunload.bind(this);return document.addEventListener("visibilitychange",e),window.addEventListener("pagehide",i),function(){t.beforeunload(),document.removeEventListener("visibilitychange",e),window.removeEventListener("pagehide",i)}},t.prototype.hardMode=function(){var t=this,e=function(){t.focusState=!1},i=function(){t.focusState=!0};return window.addEventListener("blur",e),window.addEventListener("focus",i),function(){window.removeEventListener("blur",e),window.removeEventListener("focus",i)}},t}();!function(t){t.Init="init",t.Config="config",t.Start="start",t.Ready="ready",t.UnReady="un-ready",t.TokenComplete="token-complete",t.TokenStorage="token-storage",t.TokenFetch="token-fetch",t.TokenError="token-error",t.ConfigUuid="config-uuid",t.ConfigWebId="config-webid",t.ConfigDomain="config-domain",t.CustomWebId="custom-webid",t.TokenChange="token-change",t.TokenReset="token-reset",t.ConfigTransform="config-transform",t.EnvTransform="env-transform",t.SessionReset="session-reset",t.SessionResetTime="session-reset-time",t.SetSessionId="set-session-id",t.Event="event",t.Events="events",t.EventNow="event-now",t.CleanEvents="clean-events",t.BeconEvent="becon-event",t.SubmitBefore="submit-before",t.SubmitScuess="submit-scuess",t.SubmitAfter="submit-after",t.SubmitError="submit-error",t.SubmitVerify="submit-verify",t.Stay="stay",t.ResetStay="reset-stay",t.StayReady="stay-ready",t.SetStay="set-stay",t.RouteChange="route-change",t.RouteReady="route-ready",t.Ab="ab",t.AbVar="ab-var",t.AbAllVars="ab-all-vars",t.AbConfig="ab-config",t.AbExternalVersion="ab-external-version",t.AbVersionChangeOn="ab-version-change-on",t.AbVersionChangeOff="ab-version-change-off",t.AbOpenLayer="ab-open-layer",t.AbCloseLayer="ab-close-layer",t.AbReady="ab-ready",t.AbComplete="ab-complete",t.AbTimeout="ab-timeout",t.Profile="profile",t.ProfileSet="profile-set",t.ProfileSetOnce="profile-set-once",t.ProfileUnset="profile-unset",t.ProfileIncrement="profile-increment",t.ProfileAppend="profile-append",t.ProfileClear="profile-clear",t.Autotrack="autotrack",t.AutotrackReady="autotrack-ready",t.CepReady="cep-ready",t.TracerReady="tracer-ready",t.sessionRecord="session-record",t.SessionRecordStart="session-record-start",t.SessionRecordPause="session-record-pause",t.SessionRecordEnd="session-record-end",t.SessionRecordReport="session-record-report",t.DestoryInstance="destory-instance",t.VisualCollectReady="visual-collect-ready",t.VisualApiReady="visual-api-ready",t.VisualApiUpdate="visual-api-update"}(Types||(Types={})),function(t){t.DEBUGGER_MESSAGE="debugger-message",t.DEBUGGER_MESSAGE_SDK="debugger-message-sdk",t.DEBUGGER_MESSAGE_FETCH="debugger-message-fetch",t.DEBUGGER_MESSAGE_FETCH_RESULT="debugger-message-fetch-result",t.DEBUGGER_MESSAGE_EVENT="debugger-message-event",t.DEVTOOL_WEB_READY="devtool-web-ready"}(DebuggerMesssge||(DebuggerMesssge={}));var Stay=function(){function t(){}return t.prototype.apply=function(t,e){var i=this;if(this.collect=t,this.config=e,this.config.enable_stay_duration){this.title=document.title||location.pathname,this.url=location.href,this.url_path=location.pathname,this.pageAlive=new Alive(t,e),this.pageClose=new Close(t,e);var s=this.collect.Types;this.collect.on(s.DestoryInstance,function(){i.disable()}),this.collect.on(s.ResetStay,function(t){var e=t.url_path,s=t.title,a=t.url;i.resetStayDuration(e,s,a)}),this.collect.on(s.RouteChange,function(t){t.init||e.disable_route_report||i.resetStayDuration()}),this.collect.on(s.SetStay,function(t){var e=t.url_path,s=t.title,a=t.url;i.setStayParmas(e,s,a)}),this.enable(this.url_path,this.title,this.url),this.ready(s.Stay),this.collect.emit(s.StayReady)}},t.prototype.ready=function(t){var e=this;if(this.collect.set(t),this.collect.hook._hooksCache.hasOwnProperty(t)){var i=this.collect.hook._hooksCache[t];if(!Object.keys(i).length)return;var s=function(t){i[t].length&&i[t].forEach(function(i){e.collect.hook.emit(t,i)})};for(var a in i)s(a)}},t.prototype.enable=function(t,e,i){this.pageAlive.enable(t,e,i),this.pageClose.enable(t,e,i)},t.prototype.disable=function(){this.pageAlive.disable(),this.pageClose.disable()},t.prototype.setStayParmas=function(t,e,i){void 0===t&&(t=""),void 0===e&&(e=""),void 0===i&&(i=""),this.pageAlive.setParams(t,e,i),this.pageClose.setParams(t,e,i),this.collect.emit(DebuggerMesssge.DEBUGGER_MESSAGE,{type:DebuggerMesssge.DEBUGGER_MESSAGE_SDK,info:"SDK 执行 resetStayParams",level:"info",time:Date.now(),data:{url_path:t,title:e,url:i}})},t.prototype.reset=function(t,e,i){this.disable(),this.enable(t,e,i)},t.prototype.resetStayDuration=function(t,e,i){this.reset(t,e,i),this.collect.emit(DebuggerMesssge.DEBUGGER_MESSAGE,{type:DebuggerMesssge.DEBUGGER_MESSAGE_SDK,info:"SDK 执行 resetStayDuration",level:"info",time:Date.now(),data:{url_path:t,title:e,url:i}})},t}();module.exports=Stay;
