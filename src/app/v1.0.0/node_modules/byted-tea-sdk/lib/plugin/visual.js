"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var __assign=function(){return(__assign=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function __awaiter(e,t,i,n){return new(i||(i=Promise))(function(r,o){function a(e){try{c(n.next(e))}catch(e){o(e)}}function s(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?r(e.value):new i(function(t){t(e.value)}).then(a,s)}c((n=n.apply(e,t||[])).next())})}function __generator(e,t){var i,n,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=(r=a.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function __read(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var n,r,o=i.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(e){r={error:e}}finally{try{n&&!n.done&&(i=o.return)&&i.call(o)}finally{if(r)throw r.error}}return a}function __spread(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(__read(arguments[t]));return e}function extractTag(e){return e.match(/^[a-zA-Z]+[0-9]?/)[0]||""}function filter(e,t){for(var i=0,n=e.length,r=[];i<n;)t(e[i],i)&&r.push(e[i]),i+=1;return r}function getNodesFromXPathInRange(e,t,i){for(var n=filter(t.split("/"),Boolean).map(extractTag),r=n.length,o=i.map(String),a=0,s=[e],c=[];s.length&&a<r;){c=[];for(var l=0,u=0;u<s.length;u++){var h=s[u].tagName.toLowerCase()||"";"*"!==n[a]&&n[a]!==h||("*"!==o[a]&&o[a]!==l.toString()||c.push(s[u]),l++)}a<r-1&&(s=c.reduce(function(e,t){return e.concat(Array.from(t.children))},[])),a++}return a<r-1?[]:c}var getElementsFromXPath=function(e,t){return getNodesFromXPathInRange(document.body,e,t)};function getElementsFromXPathNext(e,t){return _getElementsFromXpathNext(document.documentElement,e,t)}function getPathComponents(e,t){return void 0===t&&(t=!1),e.split("/").reduce(function(e,i){return i?e.concat(t?i.replace(/\[\]$/,""):i):e},[])}function extractChildren(e,t,i){return Array.from(e.children).filter(function(e){return e instanceof HTMLElement}).filter(function(e){return t===e.tagName.toLowerCase()}).filter(function(e,t){return[t.toString(),"*"].includes(i)})}function _getElementsFromXpathNext(e,t,i){var n=getPathComponents(t,!0),r=[e];if(n.length!==i.length)throw new Error("invalid xpath, path: "+t+", pos: "+i);for(var o=0;o<n.length;o++){for(var a=n[o],s=i[o],c=[],l=0;l<r.length;l++){var u=extractChildren(r[l],a,s);c.push.apply(c,__spread(u))}if(c.length<=0){o<n.length-1&&(r=[]);break}r=c}return r}var isArray=function(e){return Array.isArray(e)},getIndex=function(){var e=+Date.now()+Number((""+Math.random()).slice(2,8));return function(){return e+=1}}(),decrypto=function(e,t,i){if("string"==typeof e&&"number"==typeof t&&"number"==typeof i){var n,r=[];i=i<=25?i:i%25;var o=String.fromCharCode(i+97);n=e.split(o);for(var a=0;a<n.length;a++){var s=parseInt(n[a],i);s=1*s^t;var c=String.fromCharCode(s);r.push(c)}return r.join("")}},decodeUrl=function(e){return decrypto(e,64,25)},loadScript=function(e,t,i){var n=document.createElement("script");n.src=e,n.onerror=function(){i(e)},n.onload=function(){t()},document.getElementsByTagName("head")[0].appendChild(n)},parseURL=function(e){var t=document.createElement("a");return t.href=e,t},parseUrlQuery=function(e){var t={};try{var i=parseURL(e).search;if(!i)return t;(i=i.slice(1)).split("&").forEach(function(e){var i,n,r=e.split("=");r.length&&(i=r[0],n=r[1]);try{t[i]=decodeURIComponent(void 0===n?"":n)}catch(e){t[i]=n}})}catch(e){}return t};function isNeedElement(e,t,i){if(void 0===t&&(t="list"),!e)return!1;if(t&&"list"===t){if(["LI","TR","DL"].includes(e.nodeName))return!0;if(e.dataset&&e.dataset.hasOwnProperty("teaIdx"))return!0;if(e.hasAttribute&&e.hasAttribute("data-tea-idx"))return!0}else{if(["A","BUTTON"].includes(e.nodeName))return!0;if(e.dataset&&e.dataset.hasOwnProperty("teaContainer"))return!0;if(e.hasAttribute&&e.hasAttribute("data-tea-container"))return!0;if(i&&e.hasAttribute&&e.hasAttribute(i))return!0}return!1}function getXpath(e){var t=[];if(!e)return{element_path:"",positions:[]};for(;null!==e.parentElement;)t.push(e),e=e.parentElement;var i=[],n=[];return t.forEach(function(e){var t=getXpathIndex(e),r=t.str,o=t.index;i.unshift(r),n.unshift(o)}),{element_path:"/"+i.join("/"),positions:n}}function getXpathIndex(e){if(null===e)return{str:"",index:0};var t=0,i=e.parentElement;if(i)for(var n=i.children,r=0;r<n.length&&n[r]!==e;r++)n[r].nodeName===e.nodeName&&t++;return{str:[e.nodeName.toLowerCase(),isNeedElement(e,"list")?"[]":""].join(""),index:t}}var VISUAL_COND_PAGE_KEY,VISUAL_PARAM_VALUE_TYPE,VISUAL_PARAM_TYPE,VISUAL_COND_DURATION_TYPE,VISUAL_COND_DURATION_TRIGGER,LifecycleState,b=function e(t){return t?(t^16*Math.random()>>t/4).toString(10):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e)},localWebId=function(){return b().replace(/-/g,"").slice(0,19)},Exposure=function(){function e(e,t){try{this.visual=e,this.configList=t,this.elementList=[],this.elememtMap=new Map,this.configList.filter(function(e){return"view"===e.trigger_type}).forEach(function(e){return e.uid=localWebId()}),IntersectionObserver?this.observerInstance=new IntersectionObserver(this.observerCallback.bind(this),{threshold:[0,.01,.1,.2,.3,.4,.5,.6,.7,.8,.9,1]}):console.warn("your browser can not support exposure"),MutationObserver&&(this.mutationInstance=new MutationObserver(this.initObserver.bind(this)),this.mutationInstance.observe(document.body,{childList:!0,attributes:!1,subtree:!0,attributeOldValue:!1})),this.initObserver()}catch(e){console.error(e)}}return e.prototype.initObserver=function(){var e=this;try{var t=new URL(this.visual.repalceUrl(window.location.href)),i=t.pathname+t.search+t.hash;this.observerInstance&&this.configList&&this.configList.forEach(function(t){if("view"===t.trigger_type&&new RegExp(t.cond.url).test(i)){var n="selector"===(t.element_config.field.includes("selector")?"selector":"path")?"custom_selector"===t.element_config.field?t.element_config.selector:t.cond.similar_pattern?t.element_config.selector+"_"+t.cond.similar_segment_selector:t.element_config.selector:t.element_config.path+"_"+t.element_config.position.join(),r=e.getElementsByElementConfig(t),o=r.elementInstanceList,a=r.exposureSimilar;e.elementList=e.elementList.filter(function(e){return document.body.contains(e.elementInstance)}),isArray(o)?o.forEach(function(i){e.handelElementInstance(i,n,t,a)}):e.handelElementInstance(o,n,t,a)}})}catch(e){console.error(e)}},e.prototype.getElementsByElementConfig=function(e){var t=[],i=!1;try{if("selector"===(e.element_config.field.includes("selector")?"selector":"path"))if("selector"===e.element_config.field)if(e.cond.similar_pattern){i=!0;var n=document.querySelector(e.element_config.selector);t=n?Array.from(n.querySelectorAll(e.cond.similar_segment_selector)):[]}else t=document.querySelector(e.element_config.selector);else i=!0,t=Array.from(document.querySelectorAll(e.element_config.selector));else e.cond.similar_pattern?(i=!0,t=getElementsFromXPathNext(e.element_config.path,e.element_config.position)):t=getElementsFromXPath(e.element_config.path,e.element_config.position)}catch(e){console.error(e)}finally{return{elementInstanceList:t,exposureSimilar:i}}},e.prototype.handelElementInstance=function(e,t,i,n){try{if(!e)return;e.entryKey||(e.entryKey=[]),-1===e.entryKey.indexOf(t)&&e.entryKey.push(t);var r=this.get(t),o=localWebId();e.selfId||(e.selfId=o);var a=this.getInstance(r,e,i,n),s=a.shouldUpdateInstance,c=a.elementExist,l=a.currentElement;if((!r.length||r.length&&!c)&&this.elementList.push(__assign({elementKey:t,elementInstance:e,isIntersecting:!1,selfId:o},i)),r.length&&!s&&!c)return;if(r.length&&s&&c){if(l.exposured&&"once"===l.cond.frequency)return;this.exposureRemove(e)}this.exposureAdd(e)}catch(e){console.error(e)}},e.prototype.get=function(e){var t=this,i=[];return this.elementList.length&&(e instanceof Array?e.forEach(function(e){t.elementList.forEach(function(t){t.elementKey===e&&i.push(t)})}):this.elementList.forEach(function(t){t.elementKey===e&&i.push(t)})),i},e.prototype.getInstance=function(e,t,i,n){var r=!1,o=!1,a=null;return e.forEach(function(e){e.uid===i.uid&&(n?e.selfId===t.selfId&&(e.elementInstance===t?o=!0:(r=!0,e.elementInstance=t,a=e)):(o=!0,e.elementInstance!==t&&(r=!0,e.elementInstance=t,a=e)))}),{shouldUpdateInstance:r,elementExist:o,currentElement:a}},e.prototype.set=function(e,t,i){this.get(e).filter(function(e){return e.elementInstance===i}).forEach(function(e){t.uid===e.uid&&(e=Object.assign(e,t))})},e.prototype.observerCallback=function(e){var t=this;try{e.forEach(function(e){var i=e.target,n=e.isIntersecting,r=(e.time,e.intersectionRatio),o=new URL(t.visual.repalceUrl(window.location.href)),a=o.pathname+o.search+o.hash,s=i.entryKey;if(isArray(s)&&s.length){var c=t.get(s).filter(function(e){return e.elementInstance===i});c.length&&c.forEach(function(e){if("once"!==e.exportModel){if(!n)return e.isIntersecting=!1,e.added=!1,e.exposured=!1,e.startTime=Date.now(),void t.set(s,e,i);if(new RegExp(e.cond.url).test(a)){if(!e.added){if(e.startTime=Date.now(),e.added=!0,e.isIntersecting=!0,e.cond.min_exposure_time){var o=setTimeout(function(){e.isIntersecting&&!e.exposured&&t.handleExposure(s,e,r,i)},e.cond.min_exposure_time);e.startWait=o}t.set(s,e,i)}Date.now()-e.startTime>=e.cond.min_exposure_time&&!e.exposured&&t.handleExposure(s,e,r,i)}}})}})}catch(e){console.error(e)}},e.prototype.handleExposure=function(e,t,i,n){try{if(100*i<t.cond.min_exposure_ratio)return;if(t.cond.text_pattern&&!this.isMatchText(t,n))return;"once"===t.cond.frequency?(t.startWait&&clearTimeout(t.startWait),t.exportModel="once",this.reportEvent(t,n)):(t.exportModel="eveny",this.reportEvent(t,n)),t.startTime=Date.now(),t.exposured=!0,this.set(e,t,n)}catch(e){console.error(e)}},e.prototype.isMatchText=function(e,t){return this.visual.getElementText(t)===e.element_config.text},e.prototype.exposureAdd=function(e){this.observerInstance.observe(e)},e.prototype.exposureRemove=function(e){this.observerInstance.unobserve(e)},e.prototype.getElementPath=function(e){var t={},i=getXpath(e),n=i.element_path,r=i.positions.map(function(e){return""+e});return t.path=n,t.positions=r,t},e.prototype.reportEvent=function(e,t){try{var i=this.getElementsByElementConfig(e).elementInstanceList,n=i?isArray(i)?Array.from(i):[i]:[],r=e.params&&e.params.length?this.visual.calculateParams({configItem:e,target:t||null,componentDomList:n}):{};this.visual.handleReport(e,__assign({},r))}catch(e){console.error(e)}},e}();!function(e){e.PATHNAME="pathname",e.HREF="HREF"}(VISUAL_COND_PAGE_KEY||(VISUAL_COND_PAGE_KEY={})),function(e){e[e.static=1]="static",e[e.picker=2]="picker",e[e.preset_variable=3]="preset_variable",e[e.api=4]="api"}(VISUAL_PARAM_VALUE_TYPE||(VISUAL_PARAM_VALUE_TYPE={})),function(e){e[e.integer=1]="integer",e[e.float=2]="float",e[e.string=3]="string"}(VISUAL_PARAM_TYPE||(VISUAL_PARAM_TYPE={})),function(e){e.PAGE="page",e.ELEMENT="element"}(VISUAL_COND_DURATION_TYPE||(VISUAL_COND_DURATION_TYPE={})),function(e){e.HIDDEN="hidden",e.EXIT="exit",e.INACTIVE="inactive"}(VISUAL_COND_DURATION_TRIGGER||(VISUAL_COND_DURATION_TRIGGER={})),function(e){e.ACTIVE="active",e.PASSIVE="passive",e.HIDDEN="hidden",e.FROZEN="frozen",e.TERMINATED="terminated"}(LifecycleState||(LifecycleState={}));var parseQueryObject=function(e){var t={};return e&&e.substring(1).split("&").forEach(function(e){var i=e.split("=");i[0]&&(t[decodeURIComponent(i[0])]=i[1]?decodeURIComponent(i[1]):"")}),t};function debounce(e,t,i){var n;void 0===t&&(t=50),void 0===i&&(i={isImmediate:!1});var r=function(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];var a=this,s=i.isImmediate&&void 0===n;void 0!==n&&clearTimeout(n),n=setTimeout(function(){n=void 0,i.isImmediate||e.apply(a,r)},t),s&&e.apply(a,r)};return r.cancel=function(){void 0!==n&&clearTimeout(n)},r}var TriggeringMethod,TRIGGER_TYPE,computedStyle=function(e){return window.getComputedStyle(e,null)},styleProperty=function(e,t){return e.getPropertyValue(t)},isElement=function(e){return e&&1===e.nodeType||!1},isDisplayed=function e(t,i){if(i||(i=computedStyle(t)),"none"===styleProperty(i,"display"))return!1;var n=t.parentNode;return!n||!isElement(n)||e(n)},isVisibleByStyling=function(e){if(e==window.document)return!0;if(!e||!e.parentNode)return!1;var t=computedStyle(e),i=styleProperty(t,"visibility");return"hidden"!==i&&"collapse"!==i&&("0"!==styleProperty(t,"opacity")&&isDisplayed(e,t))},transformHumoToLine=function e(t){var i={};return Object.keys(t).forEach(function(n){var r=n.replace(/([A-Z])/g,"_$1").toLowerCase();t[n]&&"object"==typeof i[n]?i[r]=e(t[n]):i[r]=t[n]}),i},evaluteDynamicCode=function(e){var t=Object.create(null);return new Function("sandbox","with(sandbox){"+e+"}")(new Proxy(t,{has:function(e,t){return!0},get:function(e,t){if(t!==Symbol.unscopables)return e[t]}}))};!function(e){e.HASH="hash",e.BOTH="both",e.HISTORY="history"}(TriggeringMethod||(TriggeringMethod={})),function(e){e.CLICK="click",e.PAGE_VIEW="page_view",e.VIEW="view",e.API_AFTER="api_after",e.STAY_DURATION="stay_duration"}(TRIGGER_TYPE||(TRIGGER_TYPE={}));var MARK_STATE,PAGE_STATS_CACHE_KEY="VISUAL_STAY_DURATION_STATS",ActivityEvent={KEY_DOWN:"keydown",MOUSE_DOWN:"mousedown",MOUSE_OVER:"mouseover",TOUCH_START:"touchstart",TOUCH_END:"touchend",SCROLL:"scroll"},DEBOUNCE_TIMEOUT=50,INACTIVE_TIMEOUT=3e4,Page=function(){function e(e){var t=e.pathname,i=e.url,n=e.prevUrl;this.pathname=t,this.url=i,this.prevUrl=n,this.options=e,this.visualInstance=e.visualInstance,this.element=e.element,this.initPageStats()}return e.prototype.initPageStats=function(){this.isActive=!1,this.isVisible=!1,this.activeDuration=0,this.visibleDuration=0},e.prototype.onEnter=function(){"visible"===document.visibilityState&&(this.onVisible(),this.onActive())},e.prototype.onActive=function(){if(!this.isActive){var e=new Date;this.isActive=!0,this.lastActiveTime=e,this.enterTime||(this.enterTime=e),this.leaveTime=void 0,this.toogleElementsVisible(!0,!0,"active")}},e.prototype.onInactive=function(){if(this.isActive){var e=new Date;this.getLatestActiveDuration(),this.isActive=!1,this.leaveTime=e,this.toogleElementsVisible(!1,!1,"inactive")}},e.prototype.onVisible=function(){if(!this.isVisible){var e=new Date;this.isVisible=!0,this.lastVisibleTime=e,this.enterTime||(this.enterTime=e),this.leaveTime=void 0,this.toogleElementsVisible(!0,!0,"visible")}},e.prototype.onInvisible=function(){if(this.isVisible){var e=new Date;this.isVisible=!1,this.getLatestVisibleDuration(),this.leaveTime=e,this.toogleElementsVisible(!1,!1,"invisible")}},e.prototype.toogleElementsVisible=function(e,t,i){try{this.element&&this.element.monitorElements&&this.element.monitorElements.forEach(function(n){var r=n.observer.configItem.cond.bind_activity_pattern;r&&["active","inactive"].includes(i)&&n.observer.setVisibleState(e,i,t),!r&&["visible","invisible"].includes(i)&&n.observer.setVisibleState(e,i,t)})}catch(e){console.error(e)}},e.prototype.getLatestActiveDuration=function(){var e=new Date;this.activeDuration+=this.isActive&&this.lastActiveTime?e.getTime()-(this.lastActiveTime&&this.lastActiveTime.getTime()||0):0,this.lastActiveTime=e},e.prototype.getLatestVisibleDuration=function(){var e=new Date;this.visibleDuration+=this.lastVisibleTime?e.getTime()-this.lastVisibleTime.getTime():0,this.lastVisibleTime=e},e.prototype.generateDurationEvent=function(){return this.getLatestActiveDuration(),this.getLatestVisibleDuration(),{currUrl:this.url,prevUrl:this.prevUrl,pathname:this.pathname,query:this.query,title:document.title,enterTime:this.enterTime&&this.enterTime.getTime(),leaveTime:this.leaveTime&&this.leaveTime.getTime(),activeDuration:this.activeDuration,visibleDuration:this.visibleDuration}},e.prototype.resetTimeAfterGenerate=function(e){this.visibleDuration=0,this.activeDuration=0,this.enterTime=void 0,this.leaveTime=void 0},Object.defineProperty(e.prototype,"curPath",{get:function(){return this.pathname},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"query",{get:function(){return parseQueryObject(location.search)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currUrl",{get:function(){return this.url},enumerable:!1,configurable:!0}),e}(),Tracer=function(){function e(e){this.configItem=e.config,this.element=e.element,this.element&&this.element.setPageOptions(this),this.visualInstance=e.visualInstance,this.handlePageChange(e.config,e.event)}return e.prototype.handleMonitorActivityEvents=function(){window.clearTimeout(this.inactiveTimerHandle),this.startInactiveTimer(),this.curPage&&this.curPage.onActive()},e.prototype.handleListenLifecycle=function(e,t){switch(t){case LifecycleState.HIDDEN:this.curPage&&this.handleHiddenState();break;case LifecycleState.TERMINATED:this.curPage&&this.handleTerminatedState();break;case LifecycleState.ACTIVE:case LifecycleState.PASSIVE:this.handlePageVisibleState(t)}},e.prototype.handlePageChange=function(e,t){try{var i=e.cond.page_key||VISUAL_COND_PAGE_KEY.PATHNAME;if(this.curPage&&this.curPage.currUrl&&t&&t.curUrl&&this.curPage.currUrl[i]===t.curUrl[i])return;this.curPage&&(this.handleHiddenState(),this.handleTerminatedState()),this.handleCacheByPageUpdate(),this.isMatchConfigUrl(t&&t.curUrl&&t.curUrl.href)&&this.onPageEnter(t)}catch(e){console.error(e)}},e.prototype.handleCacheByPageUpdate=function(){try{var e=localStorage.getItem(PAGE_STATS_CACHE_KEY);e&&this.triggerPageDurationEvent(JSON.parse(e))}catch(e){console.error("[visualStayDuration] onPageEnter error: ",e)}this.removePageStatsCache()},e.prototype.onPageEnter=function(e){this.curPage=e?e.curUrl&&new Page({pathname:e.curUrl.pathname,url:e.curUrl,prevUrl:e.prevUrl,visualInstance:this.visualInstance,element:this.element}):new Page({pathname:window.location.pathname,url:{pathname:window.location.pathname,href:window.location.href,hash:window.location.hash,host:window.location.host,port:window.location.port,query:parseQueryObject(window.location.search),pathWithHash:window.location.pathname+window.location.hash},visualInstance:this.visualInstance,element:this.element}),this.curPage&&this.curPage.onEnter(),this.startInactiveTimer()},e.prototype.startInactiveTimer=function(){var e=this;"visible"===document.visibilityState&&(window.clearTimeout(this.inactiveTimerHandle),this.inactiveTimerHandle=window.setTimeout(function(){e.curPage&&e.curPage.onInactive(),e.configItem.cond.duration_trigger===VISUAL_COND_DURATION_TRIGGER.INACTIVE&&e.triggerPageDurationEvent()},this.configItem.cond.inactive_timeout||INACTIVE_TIMEOUT))},e.prototype.handlePageVisibleState=function(e){this.curPage&&this.curPage.onVisible(),e===LifecycleState.ACTIVE&&(this.curPage&&this.curPage.onActive(),this.startInactiveTimer()),this.removePageStatsCache()},e.prototype.handleHiddenState=function(){window.clearTimeout(this.inactiveTimerHandle),this.curPage&&this.curPage.onInactive(),this.curPage&&this.curPage.onInvisible(),this.cachePageStats(),[VISUAL_COND_DURATION_TRIGGER.HIDDEN,VISUAL_COND_DURATION_TRIGGER.INACTIVE].includes(this.configItem.cond.duration_trigger)&&this.triggerPageDurationEvent()},e.prototype.handleTerminatedState=function(){[VISUAL_COND_DURATION_TRIGGER.EXIT].includes(this.configItem.cond.duration_trigger)&&this.triggerPageDurationEvent(),delete this.curPage,this.removePageStatsCache()},e.prototype.triggerPageDurationEvent=function(e){var t=this.configItem.cond.duration_trigger,i=null,n=null;e?(i=e.page,n=e.configItem):(i=this.curPage.generateDurationEvent(),this.curPage.resetTimeAfterGenerate(t)),window.clearTimeout(this.inactiveTimerHandle),this.configItem.cond.duration_type===VISUAL_COND_DURATION_TYPE.PAGE&&this.reportEvent(transformHumoToLine(i),n)},e.prototype.reportEvent=function(e,t){var i=this.configItem.params&&this.configItem.params.length?this.visualInstance.calculateParams({configItem:t||this.configItem,durationData:e}):{};this.visualInstance.handleReport(this.configItem,__assign({},i),!0)},e.prototype.cachePageStats=function(){try{var e=this.curPage&&this.curPage.generateDurationEvent();localStorage.setItem(PAGE_STATS_CACHE_KEY,JSON.stringify({page:e,configItem:this.configItem}))}catch(e){console.error("[visualStayDuration] cachePageStats error: ",e)}},e.prototype.removePageStatsCache=function(){localStorage.removeItem(PAGE_STATS_CACHE_KEY)},e.prototype.replaceUrl=function(e){var t=new URL(e),i=t.searchParams;return i.has("visual_preview")?(i.delete("visual_preview"),t.href):e},e.prototype.isMatchConfigUrl=function(e){void 0===e&&(e=location.href);var t=new URL(this.replaceUrl(e)),i=t.pathname+t.search+t.hash;return!(this.configItem.cond.url&&!new RegExp(this.configItem.cond.url).test(i))},e}();!function(e){e.VISIBLE="visible",e.INVISIBLE="INVISIBLE",e.EXIT="exit"}(MARK_STATE||(MARK_STATE={}));var MonitorElement=function(){function e(e){var t=e.key,i=e.node,n=e.configItem,r=e.page,o=e.isReported,a=e.visualInstance;this.key=t,this.node=i,this.configItem=n,this.page=r,this.isReported=o,this.visualInstance=a,this.ratio=0,this.isVisible=!1,this.visibleDuration=0,this.monitorIntersection()}return e.prototype.updatePage=function(e){this.page=e},e.prototype.monitorIntersection=function(){var e=this;try{var t=this.configItem.cond.min_exposure_ratio/100;this.observer=new IntersectionObserver(function(t){e.ratio=t[0]&&t[0].intersectionRatio,e.checkStatus(!0,t[0]&&t[0].target)},{threshold:t}),this.observer.observe(this.node)}catch(e){console.error(e)}},e.prototype.checkStatus=function(e,t){this.configItem.cond.text_pattern&&!this.isMatchText(t)||(this.checkVisibility()?this.onVisible(e):this.onInVisible(e))},e.prototype.checkVisibility=function(){return!!isVisibleByStyling(this.node)&&this.ratio>=this.configItem.cond.min_exposure_ratio/100},e.prototype.onVisible=function(e){return this.clearLazyTimer(),this.isVisible?this.report:(e&&this.configItem.cond.min_exposure_time?this.startVisibleTimer(MARK_STATE.VISIBLE,this.configItem.cond.min_exposure_time):this.mark(MARK_STATE.VISIBLE),this.report)},e.prototype.onInVisible=function(e){return this.clearLazyTimer(),this.isVisible?(this.mark(MARK_STATE.INVISIBLE),this.report):this.report},e.prototype.setVisibleState=function(e,t,i){try{if(this.configItem.cond.text_pattern&&!this.isMatchText(this.node))return;e&&this.checkVisibility()?this.onVisible(i):this.onInVisible(i)}catch(e){console.error(e)}},e.prototype.exit=function(){return this.observer&&this.observer.disconnect(),this.mark(MARK_STATE.EXIT),this.report},e.prototype.mark=function(e,t){void 0===t&&(t=Date.now());try{switch(e){case MARK_STATE.VISIBLE:if(this.isVisible)return;this.isVisible=!0,this.lastVisibleTime=t,this.enterTime||(this.enterTime=t);break;case MARK_STATE.INVISIBLE:if(!this.isVisible)return;this.isVisible=!1,this.visibleDuration+=t-this.lastVisibleTime,this.leaveTime=t,this.generateDurationEvent();break;case MARK_STATE.EXIT:this.isVisible&&(this.isVisible=!1,this.visibleDuration+=t-this.lastVisibleTime),this.leaveTime=t,this.generateDurationEvent()}}catch(e){console.error(e)}},e.prototype.startVisibleTimer=function(e,t){var i=this;this.clearLazyTimer(),this.visibleTimer=window.setTimeout(function(){var t=Date.now();i.mark(e,t)},t)},e.prototype.clearLazyTimer=function(){window.clearTimeout(this.visibleTimer)},e.prototype.generateDurationEvent=function(){if(!this.isReported||"once"!==this.configItem.cond.frequency){this.isReported=!0;var e=this.report;this.resetTimeAfterGenerate(),this.reportEvent(transformHumoToLine(e))}},e.prototype.reportEvent=function(e){try{var t=this.configItem.params&&this.configItem.params.length?this.visualInstance.calculateParams({configItem:this.configItem,durationData:e}):{};this.visualInstance.handleReport(this.configItem,__assign({},t),!0)}catch(e){console.error(e)}},e.prototype.resetTimeAfterGenerate=function(){this.visibleDuration=0,this.lastVisibleTime=void 0,this.enterTime=void 0,this.leaveTime=void 0},e.prototype.isMatchText=function(e){return this.visualInstance.getElementText(e)===this.configItem.element_config.text},Object.defineProperty(e.prototype,"report",{get:function(){return{currUrl:this.page&&this.page.curPage&&this.page.curPage.currUrl,prevUrl:this.page&&this.page.curPage&&this.page.curPage.prevUrl,pathname:this.page&&this.page.curPage&&this.page.curPage.curPath,title:document.title,enterTime:this.enterTime,leaveTime:this.leaveTime,visibleDuration:this.visibleDuration}},enumerable:!1,configurable:!0}),e}(),Element=function(){function e(e){try{this.configItem=e.config,this.page=e.page,this.visualInstance=e.visualInstance,this.monitorElements=[],this.initElementsByConfig()}catch(e){console.error(e)}}return e.prototype.setPageOptions=function(e){this.page=e,this.monitorElements.forEach(function(t){t.observer.updatePage(e)})},e.prototype.initElementsByConfig=function(){this.isMatchConfigUrl()&&this.getNodesByElementConfig().map(this.checkElement.bind(this))},e.prototype.checkElement=function(e){try{e.keys||(e.keys=[]);var t=this.monitorElements.find(function(t){return e.keys.includes(t.key)});if(t)t&&t.observer&&t.observer.checkStatus&&t.observer.checkStatus(!0,t.node);else{var i=localWebId();e.keys.push(i),this.addElement(e,i)}}catch(e){console.error(e)}},e.prototype.addElement=function(e,t){var i={key:t,node:e};this.monitorElements.push(__assign(__assign({},i),{observer:new MonitorElement(__assign(__assign({},i),{configItem:this.configItem,page:this.page,isReported:!1,visualInstance:this.visualInstance}))}))},e.prototype.onExitElements=function(){this.monitorElements.forEach(function(e){e.observer&&e.observer.exit()})},e.prototype.getNodesByElementConfig=function(){var e=[];try{var t=this.configItem,i=t.element_config,n=t.cond;if("selector"===(i.field.includes("selector")?"selector":"path"))if("selector"===i.field)if(n.similar_pattern){var r=document.querySelector(i.selector);e=r?Array.from(r.querySelectorAll(n.similar_segment_selector)):[]}else{var o=document.querySelector(i.selector);e=o?[o]:[]}else e=Array.from(document.querySelectorAll(i.selector));else e=n.similar_pattern?getElementsFromXPathNext(i.path,i.position):getElementsFromXPath(this.configItem.element_config.path,this.configItem.element_config.position)}catch(e){console.error(e)}finally{return e}},e.prototype.replaceUrl=function(e){try{var t=new URL(e),i=t.searchParams;return i.has("visual_preview")?(i.delete("visual_preview"),t.href):e}catch(t){return console.error(t),e}},e.prototype.isMatchConfigUrl=function(e){void 0===e&&(e=location.href);try{var t=new URL(this.replaceUrl(e)),i=t.pathname+t.search+t.hash;return!(this.configItem.cond.url&&!new RegExp(this.configItem.cond.url).test(i))}catch(e){return console.error(e),!1}},e}(),IS_SAFARI="object"==typeof safari&&safari.pushNotification,SUPPORTS_PAGE_TRANSITION_EVENTS="onpageshow"in self,EVENTS=["focus","blur","visibilitychange","freeze","resume","pageshow",SUPPORTS_PAGE_TRANSITION_EVENTS?"pagehide":"unload"],toIndexedObject=function(e){return e.reduce(function(e,t,i){return e[t]=i,e},{})},LEGAL_STATE_TRANSITIONS=[[LifecycleState.ACTIVE,LifecycleState.PASSIVE,LifecycleState.HIDDEN,LifecycleState.TERMINATED],[LifecycleState.ACTIVE,LifecycleState.PASSIVE,LifecycleState.HIDDEN,LifecycleState.FROZEN],[LifecycleState.HIDDEN,LifecycleState.PASSIVE,LifecycleState.ACTIVE],[LifecycleState.FROZEN,LifecycleState.HIDDEN],[LifecycleState.FROZEN,LifecycleState.ACTIVE],[LifecycleState.FROZEN,LifecycleState.PASSIVE]].map(toIndexedObject),Lifecycle=function(){function e(e){var t=this;try{this.lifycycleHandle=e.lifecycleHandle,this._state=this.getPageCurrentState(),this._handleEvents=this._handleEvents.bind(this),EVENTS.forEach(function(e){return addEventListener(e,t._handleEvents,!0)}),IS_SAFARI&&addEventListener("beforeunload",function(e){t._safariBeforeUnloadTimeout=setTimeout(function(){e.defaultPrevented||e.returnValue.length>0||t._dispatchChangesIfNeeded(e,LifecycleState.HIDDEN)},0)})}catch(e){console.error(e)}}return e.prototype.getPageCurrentState=function(){return document.visibilityState===LifecycleState.HIDDEN?LifecycleState.HIDDEN:document.hasFocus()?LifecycleState.ACTIVE:LifecycleState.PASSIVE},e.prototype.getLegalStateTransitionPath=function(e,t){try{for(var i=void 0,n=0;i=LEGAL_STATE_TRANSITIONS[n];++n){var r=i[e],o=i[t];if(r>=0&&o>=0&&o>r)return Object.keys(i).slice(r,o+1)}return[]}catch(e){return console.error(e),[]}},e.prototype._dispatchChangesIfNeeded=function(e,t){try{if(t!==this._state)for(var i=this._state,n=this.getLegalStateTransitionPath(i,t),r=0;r<n.length-1;++r){n[r];var o=n[r+1];this._state=o,this.lifycycleHandle(e,o)}}catch(e){console.error(e)}},e.prototype._handleEvents=function(e){try{switch(IS_SAFARI&&clearTimeout(this._safariBeforeUnloadTimeout),e.type){case"pageshow":case"resume":this._dispatchChangesIfNeeded(e,this.getPageCurrentState());break;case"focus":this._dispatchChangesIfNeeded(e,LifecycleState.ACTIVE);break;case"blur":this._state===LifecycleState.ACTIVE&&this._dispatchChangesIfNeeded(e,this.getPageCurrentState());break;case"pagehide":case"unload":this._dispatchChangesIfNeeded(e,e.persisted?LifecycleState.FROZEN:LifecycleState.TERMINATED);break;case"visibilitychange":this._state!==LifecycleState.FROZEN&&this._state!==LifecycleState.TERMINATED&&this._dispatchChangesIfNeeded(e,this.getPageCurrentState());break;case"freeze":this._dispatchChangesIfNeeded(e,LifecycleState.FROZEN)}}catch(e){console.error(e)}},e.prototype.removePageEventListener=function(){var e=this;EVENTS.forEach(function(t){return removeEventListener(t,e._handleEvents,!0)})},e}(),StayDuration=function(){function e(e){try{this.options=e,this.visualInstance=e.visualInstance,this.configPageList=[],this.curUrl=window.location.href,this.activityEventsListenerDeb=debounce(this.activityEventsListener.bind(this),DEBOUNCE_TIMEOUT),this.options.configList.length&&this.initLoadListener()}catch(e){console.error(e)}}return e.prototype.initLoadListener=function(){var e=this;try{this.lifecycle=new Lifecycle({lifecycleHandle:function(t,i){e.configPageList.forEach(function(e){e.page&&e.page.handleListenLifecycle(t,i)})}}),this.initConfigPageList(),this.mutationObserverInstance=this.createMutationObserver()}catch(e){console.error(e)}},e.prototype.initConfigPageList=function(){var e=this;try{this.configPageList=this.options.configList.filter(function(e){return e.trigger_type===TRIGGER_TYPE.STAY_DURATION}).map(function(t){if(t.cond.duration_type===VISUAL_COND_DURATION_TYPE.ELEMENT){var i=e.buildElementInstance(t,null);return __assign(__assign({},i),{page:new Tracer({config:t,visualInstance:e.visualInstance,element:i.element})})}return __assign(__assign({},t),{page:new Tracer({config:t,visualInstance:e.visualInstance})})}),this.configPageList.length&&this.addMonitorActivityEventsListener()}catch(e){console.error(e)}},e.prototype.handlePageChange=function(){try{if(this.destroy)return;var e=this.buildUrlChangeEvent();this.updateConfigPageList(e)}catch(e){console.error(e)}},e.prototype.updateConfigPageList=function(e){this.configPageList.forEach(function(t){t.page&&t.page.handlePageChange(t,e)})},e.prototype.createMutationObserver=function(){var e=new MutationObserver(debounce(function(e){e.length&&this.initConfigPageListOfElement()}.bind(this)));return e.observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0}),e},e.prototype.initConfigPageListOfElement=function(){var e=this;try{this.configPageList=this.configPageList.map(function(t){return t.cond.duration_type===VISUAL_COND_DURATION_TYPE.ELEMENT?e.buildElementInstance(t,t.page):t})}catch(e){console.error(e)}},e.prototype.buildElementInstance=function(e,t){return e.element?(e.element.initElementsByConfig(),e):__assign(__assign({},e),{element:new Element({config:e,visualInstance:this.visualInstance,page:t})})},e.prototype.activityEventsListener=function(){try{this.configPageList.forEach(function(e){e.page&&e.page.handleMonitorActivityEvents()})}catch(e){console.error(e)}},e.prototype.addMonitorActivityEventsListener=function(){var e=this;Object.values(ActivityEvent).forEach(function(t){window.addEventListener(t,e.activityEventsListenerDeb)})},e.prototype.removeMonitorActivityEventsListener=function(){var e=this;Object.values(ActivityEvent).forEach(function(t){window.removeEventListener(t,e.activityEventsListenerDeb)})},e.prototype.onExit=function(){try{this.destroy=!0,this.lifecycle.removePageEventListener(),this.removeMonitorActivityEventsListener(),this.mutationObserverInstance&&this.mutationObserverInstance.disconnect(),this.configPageList.filter(function(e){return e.cond.duration_type===VISUAL_COND_DURATION_TYPE.ELEMENT}).forEach(function(e){e.element&&e.element.onExitElements()})}catch(e){console.error(e)}},e.prototype.buildUrlChangeEvent=function(){var e,t,i;try{if(t=new URL(window.location.href),i=new URL(this.curUrl||""),t.href!==i.href){var n=t.hash!==i.hash,r=t.pathname!==i.pathname,o=n&&r?TriggeringMethod.BOTH:n?TriggeringMethod.HASH:TriggeringMethod.HISTORY;e={curUrl:this.buildCustomUrlObject(t),prevUrl:this.buildCustomUrlObject(i),triggeredBy:o}}else e={curUrl:this.buildCustomUrlObject(t),prevUrl:this.buildCustomUrlObject(i)}}catch(e){console.error("[VisualStayDurationError] error parsing previous URL "+this.curUrl+" or current URL "+window.location.href)}finally{this.curUrl=window.location.href}return e},e.prototype.buildCustomUrlObject=function(e){return{href:e.href,hash:e.hash,pathname:e.pathname,host:e.host,port:e.port,pathWithHash:e.pathname+e.hash,query:parseQueryObject(e.search)}},e}(),filterUrl=["1fz22z22z1nz21z4mz4bz4bz1kz1az21z4az28z1gz1hz1gz1cz18z1nz1gz4az1az1mz1k","1fz22z22z1nz21z4mz4bz4bz1kz1az21z4az24z1mz1jz1az1cz18z1nz1nz1jz1mz1ez4az1az1mz1k","1fz22z22z1nz21z4mz4bz4bz1kz1az21z4az1az22z1mz19z21z1lz21z21z1bz1iz4az1az1mz1k"],InterceptorRequest=function(){function e(){}return e.prototype.catchFetch=function(e){var t=this,i=window.fetch,n=!1;window.fetch=function(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];return __awaiter(t,void 0,void 0,function(){var t,o,a,s,c,l;return __generator(this,function(u){switch(u.label){case 0:t=__read(r,2),o=t[0],a=t[1];try{"string"==typeof o?s=o:o instanceof Request&&(s=o.url),filterUrl.forEach(function(e){s.includes(decodeUrl(e))&&(n=!0)})}catch(e){console.error(e)}return[4,i(o,a)];case 1:c=u.sent();try{return l=function(){return c.clone().json().then(function(t){try{if(!n){var i=new URL(s,window.location.origin);e({url_path:i&&i.pathname||s,params:a&&"POST"===a.method?a.body&&JSON.parse(a.body.toString()):{},response:t,method:a&&a.method||"GET",query:a&&"GET"===a.method?parseUrlQuery(s):{}})}}finally{return t}})},c.json=l,[2,c]}finally{return[2,c]}return[2]}})})}},e.prototype.catchAjax=function(e){var t=XMLHttpRequest;if(t&&"file:"!==window.location.protocol){var i=t.prototype.open,n=t.prototype.send;t.prototype.open=function(e,t){return this.url=t,this._startTime=+new Date,i.apply(this,arguments)},t.prototype.send=function(){var t=this,i=function(i){if(i){var n=+new Date-t._startTime;i.duration=n;var r=!1;if(filterUrl.forEach(function(e){var i=decodeUrl(e);t.url.includes(i)&&(r=!0)}),!r){var o=void 0;try{if(-1!==t.getAllResponseHeaders("content-type").indexOf("application/json")){var a=i.currentTarget.responseType;(o=i.currentTarget.response)&&"json"!==a&&(o=JSON.parse(o))}if(200===i.currentTarget.status){t.success&&t.success(o);var s=i.currentTarget._data;if(s instanceof FormData)return;s="application/x-www-form-urlencoded"===(i.currentTarget._reqHeaders&&i.currentTarget._reqHeaders["Content-Type"])?s:s&&JSON.parse(s);var c=i.currentTarget._method,l=new URL(t.url,window.location.origin);e({url_path:l.pathname||l,params:s,response:o,method:c||"GET",query:c&&"GET"===c?parseUrlQuery(t.url):{}})}else t.fail&&t.fail(o)}catch(e){console.log("catch xhr error")}}}};if("addEventListener"in this)this.addEventListener("load",i),this.addEventListener("error",i),this.addEventListener("abort",i);else{var r=this.onreadystatechange;this.onreadystatechange=function(e){4===this.readyState&&i(e),r&&r.apply(this,arguments)}}return n.apply(this,arguments)}}},e.prototype.getQuery=function(){},e}(),VISUAL_EVENT_URL=decodeUrl("1fz22z22z1nz21z4mz4bz4bz1jz1dz4fz49z1az1bz1lz49z22z1mz21z4az19z27z22z1cz21z1az1kz4az1az1mz1kz4bz1mz19z1hz4bz21z22z18z22z1gz1az4bz1jz1mz1ez49z21z1bz1iz4bz1az1mz1jz1jz1cz1az22z4bz24z1gz21z23z18z1jz49z1cz24z1cz1lz22z4az1hz21"),VISUAL_DOMAIN={cn:"1fz22z22z1nz21z4mz4bz4bz1kz1az21z4az28z1gz1hz1gz1cz18z1nz1gz4az1az1mz1k",sg:"1fz22z22z1nz21z4mz4bz4bz21z1ez18z1jz1gz49z1kz1az21z4az19z27z22z1cz1mz24z1cz20z21z1cz18z4az1az1mz1k",va:"1fz22z22z1nz21z4mz4bz4bz21z1ez18z1jz1gz49z1kz1az21z4az19z27z22z1cz1mz24z1cz20z21z1cz18z4az1az1mz1k"},Visual=function(){function e(){this.ready=!1,this.exposureInit=!1,this.stayDurationInit=!1}return e.prototype.apply=function(e,t){var i=this;if(t.visual_container_id)try{this.collector=e,this.config=t,this.types=e.Types;var n=e.adapters.storage;if(this.storage=new n(!1),this.domain=t.visual_domain||decodeUrl(VISUAL_DOMAIN[t.channel]),this.cacheKey="__tea_visval_plan_"+t.app_id,this.reportUrl=this.collector.configManager.getUrl("event"),this.hack(),this.apiList=[],this.eventCache=[],this.waitReportList=new Map,t.visual_catch_api){var r=new InterceptorRequest;r.catchFetch(this.apiCallback.bind(this)),r.catchAjax(this.apiCallback.bind(this))}this.collector.on(this.types.DestoryInstance,function(){i.cancle&&i.cancle(),i.stayDuration&&i.stayDuration.onExit()}),window&&"byteio_visual_config_iframe"===window.name?(this.editStatus=!0,this.editMode(),this.collector.destoryInstace()):this.init(),this.collector.emit(this.types.VisualCollectReady)}catch(e){console.error(e)}},e.prototype.editMode=function(){var e=this;try{return(window.opener||window.parent).postMessage({type:"visual:ready",payload:{app_id:this.config.app_id,visual_container_id:this.config.visual_container_id}},"*"),window.addEventListener("message",function(t){if(t&&t.data&&"visual:setting"===t.data.type){if(t.data.payload.app_id!==e.config.app_id)return;e.origin=t.origin,loadScript(VISUAL_EVENT_URL,function(){console.info("load visual event js success")},function(){console.warn("load visual event js error")});var i={type:"visual:setting:info",payload:{visual_container_id:e.config.visual_container_id}};(window.opener||window.parent).postMessage(i,t.origin)}t&&t.data&&"visual:preset-variable"===t.data.type&&e.sendPresetValue(),t&&t.data&&"visual:api"===t.data.type&&e.sendApiValue()},!0),function(){window.removeEventListener("message",function(){},!1)}}catch(e){}},e.prototype.init=function(){var e=this;this.cancle=this.listener(),1!=parseUrlQuery(location.href).visual_preview&&"byteio_visual_preview_iframe"!==window.name?this.collector.requestManager.useRequest({url:this.domain+"/v1/viz_event/config?app_id="+this.config.app_id+"&viz_container_id="+this.config.visual_container_id,method:"GET",success:function(t){t&&t.data&&200===t.status?(e.visualConfig=t.data,t.data.aid===e.config.app_id&&t.data.vcid===e.config.visual_container_id?(e.ready=!0,e.viewEvent(t.data)):console.warn("visual config id not equal")):console.warn("load visual config fail, error:"+JSON.stringify(t))},fail:function(e){console.warn("load visual config error, error:"+JSON.stringify(e))},timeout:1e4}):this.preview=this.setPreview()},e.prototype.hack=function(){var e=this,t=window.history.pushState;history.pushState=function(i){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];"function"==typeof history.onpushstate&&history.onpushstate({state:i});var o=location.href,a=t.call.apply(t,__spread([history,i],n));try{e.routeChange(o),e.stayDuration&&e.stayDuration.handlePageChange()}catch(e){console.error(e)}return a};var i=history.replaceState;history.replaceState=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];"function"==typeof history.onreplacestate&&history.onreplacestate({state:t});var o=location.href,a=i.call.apply(i,__spread([history,t],n));try{e.routeChange(o),e.stayDuration&&e.stayDuration.handlePageChange()}catch(e){console.error(e)}return a}},e.prototype.routeChange=function(e){(this.editStatus||this.preview)&&(window.opener||window.parent).postMessage({type:"visual:url",payload:{url:location.href}},"*"),this.editStatus||this.viewEvent(this.visualConfig,e)},e.prototype.apiCallback=function(e){var t=this;try{if(this.apiList.push(e),this.collector.emit(this.types.VisualApiUpdate,this.apiList),this.editStatus)return;this.matchDependence(e),setTimeout(function(){try{if(!t.visualConfig||!t.visualConfig.config_list)return;t.visualConfig.config_list.forEach(function(e){"api_after"===e.trigger_type&&t.apiList.forEach(function(i){i.match||i.method===e.cond.api_config.method&&t.dynamicEqualPath(i.url_path,e.cond.api_config.url_path)&&(i.match=t.matchStatus(e,null))})})}catch(e){console.error(e)}},1e3)}catch(e){console.error(e)}},e.prototype.listener=function(){var e=this.clickEvent.bind(this);return document.addEventListener("click",e,!0),function(){document.removeEventListener("click",e,!0)}},e.prototype.clickEvent=function(e){this.collector.destroy||this.ready&&this.visualConfig&&this.visualConfig.config_list&&this.matchRule(e)},e.prototype.viewEvent=function(e,t){var i=this;try{if(!this.ready)return;if(!e||!e.config_list)return;e.config_list.forEach(function(e){"page_view"===e.trigger_type&&i.matchStatus(e,null,null,t)}),this.exposureInit||(this.exposure=new Exposure(this,e.config_list)),this.exposureInit=!0,this.stayDurationInit||(this.stayDuration=new StayDuration({visualInstance:this,configList:e.config_list.filter(function(e){return"stay_duration"===e.trigger_type})})),this.stayDurationInit=!0}catch(e){console.error(e)}},e.prototype.matchRule=function(e){var t=this;this.visualConfig.config_list.forEach(function(i){"click"===i.trigger_type&&t.matchStatus(i,e,void 0)})},e.prototype.repalceUrl=function(e){try{var t=new URL(e),i=t.searchParams;return i.has("visual_preview")?(i.delete("visual_preview"),t.href):e}catch(t){return console.error(t),e}},e.prototype.handleFilterConfigByPageKey=function(e,t){try{var i=e.cond.page_key;return"href"===(void 0===i?"pathname":i)?new URL(t||"").href!==window.location.href:new URL(t||"").pathname!==window.location.pathname}catch(e){return!0}},e.prototype.matchStatus=function(e,t,i,n){try{try{if("page_view"===e.trigger_type&&n)if(!this.handleFilterConfigByPageKey(e,n))return;var r=new URL(this.repalceUrl(window.location.href)),o=r.pathname,a=r.search,s=r.hash;if(this.patternStr=o+a+s,!new RegExp(e.cond.url).test(this.patternStr))return;var c=e.cond,l=e.element_config,u=!0,h=[];if(t){if(c.similar_pattern)if(c.similar_segment_selector||l.position&&l.position.includes("*"))if(c.similar_segment_selector){var f=document.querySelector(l.selector),p=f?f.querySelectorAll(c.similar_segment_selector):[];h=Array.from(p);var d=this.nodeListMatch(p,t,c,c.bubble_pattern);T=d.nodeMatch,d.index;u=T}else if(h=getElementsFromXPathNext(l.path,l.position),i=i||this.getElementData(t.target),c.bubble_pattern){var g=0===i.element_path.indexOf(l.path),m=this.includsArray(i.positions,l.position);g&&m||(u=!1)}else{var v=!0;l.position.forEach(function(e,t){"*"!==e&&e!==i.positions[t]&&(v=!1)}),v&&i.element_path===l.path||(u=!1)}else{var y="selector"===l.field?document.querySelector(l.selector):getElementsFromXPath(l.path,l.position),_=[];_="selector"===l.field?y.children||[]:y&&y.length?y[0].children:[],u=this.nodeListMatch(_,t,c,c.bubble_pattern).nodeMatch}else if("selector"===l.field)h=[E=document.querySelector(l.selector)],c.bubble_pattern?u=E&&E.contains(t.target):E!==t.target&&(u=!1);else if("path_position"===l.field){var E;h=(E=getElementsFromXPath(l.path,l.position))||[],c.bubble_pattern?u=!(!E||!E.length)&&E[0].contains(t.target):(i=i||this.getElementData(t.target),JSON.stringify(l.position)===JSON.stringify(i.positions)&&i.element_path===l.path||(u=!1))}else if("custom_selector"===l.field){var I=document.querySelectorAll(l.selector)||[];h=Array.from(I);var b=this.nodeListMatch(I,t,c,c.bubble_pattern),T=b.nodeMatch;b.index;u=T}if(u&&c.text_pattern)this.getElementText(t.target)!==l.text&&(u=!1)}if(u){var S=e.params&&e.params.length?this.calculateParams({configItem:e,target:t&&t.target||null,componentDomList:h}):{};this.isNeedWaitForConfig(e.trigger_id)||this.handleReport(e,__assign({},S))}return u}catch(t){console.warn("visual match error",JSON.stringify(t.message)),this.errorReport(t,e)}}catch(t){console.error(t)}},e.prototype.similarMatch=function(e,t){var i=!1,n=t.nodeName&&t.nodeName.toLowerCase(),r=t.classList;if(n!==e.similar_tag&&(i=!1),e.similar_class&&e.similar_class.length&&r&&r.length){var o=!1;r.forEach(function(t){-1!==e.similar_class.indexOf(t)&&(o=!0)}),i=o}else i=!0;return i},e.prototype.nodeListMatch=function(e,t,i,n){var r=!1,o=0;if(e&&e.length){for(var a=[],s=0;s<e.length;s++){this.similarMatch(i,e[s])&&a.push(e[s])}for(s=0;s<a.length;s++)if(n){if(a[s].contains(t.target)){r=!0,o=s;break}}else if(a[s]===t.target){r=!0,o=s;break}}return{nodeMatch:r,index:o}},e.prototype.getElementData=function(e){var t={},i=getXpath(e),n=i.element_path,r=i.positions.map(function(e){return""+e});return t.element_path=n,t.positions=r,t},e.prototype.getElementText=function(e){if(!e)return"";var t="";return e.textContent?t=e.textContent.trim():e.innerText&&(t=e.innerText.trim()),"input"!==e.tagName&&"INPUT"!==e.tagName||(t=e.value||""),t},e.prototype.calculateParams=function(e){var t=this,i={};try{var n=e.configItem,r=e.target,o=void 0===r?null:r,a=e.componentDomList,s=void 0===a?[]:a,c=e.durationData,l=void 0===c?null:c,u=n.params;n.trigger_id=localWebId(),u.forEach(function(e){try{switch(e.value_type){case 1:var r=t.getStaticValue(e,o,s);i[""+e.name]=t.handleParams(e,t.typeChange(e.type,r),i);break;case 2:var a=null,c=void 0,u=void 0,h=void 0;if(e.extra&&e.extra.similar_group_pattern){if("path_position"===e.element_config.field){var f=e.element_config.position.indexOf("*"),p=e.element_config.position.slice(0,f+1);c=getElementsFromXPathNext(e.element_config.path.split("/").slice(0,f+2).join("/"),p),h=getElementsFromXPathNext(e.element_config.path,e.element_config.position)}else if("selector"===e.element_config.field){var d=document.querySelector(e.element_config.selector),g=document.querySelector(n.element_config.selector);h=d?d.querySelectorAll(e.extra.similar_segment_selector):[],u="selector"===n.element_config.field?g?g.querySelectorAll(n.cond.similar_segment_selector):[]:getElementsFromXPath(n.element_config.path,n.element_config.position),c=t.findGroupList(Array.from(h),Array.from(u),n,e)}else if("custom_selector"===e.element_config.field){h=document.querySelectorAll(e.element_config.selector),u=document.querySelectorAll(n.element_config.selector),h=Array.from(h),u=Array.from(u);var m=t.findRange(u,h);c=m?t.findGroupList(h,u,n,e,m):null}if(!c){i[""+e.name]="";break}var v=c.findIndex(function(e){return e.contains(o)});if(-1===v){i[""+e.name]="";break}var y=c[v],_=(h=Array.from(h)).find(function(e){return y.contains(e)});if(!_){i[""+e.name]="";break}a=_}else"selector"===e.element_config.field||"custom_selector"===e.element_config.field?a=document.querySelector(e.element_config.selector):"path_position"===e.element_config.field&&(a=getElementsFromXPathNext(e.element_config.path,e.element_config.position));isArray(a)&&(a=a[0]),i[""+e.name]=t.handleParams(e,t.typeChange(e.type,t.getElementText(a)),i);break;case 3:var E=t.getPresetValue(e.name,e.value,o,s,l);E&&(i[""+e.name]=t.handleParams(e,E[e.name],i));break;case 4:var I=t.getApiValue(e.name,e.api_config,e,n,o,i);I&&(i[""+e.name]=t.handleParams(e,I[e.name],i))}t.updateWaitList(n,i)}catch(r){i[""+e.name]="",console.error(r),t.errorReport(r,n)}})}catch(e){return console.log(e.message),i}finally{return i}},e.prototype.isNeedWaitForConfig=function(e){var t=this.waitReportList.get(e);return!!(t&&t.dependencies&&t.dependencies.length)},e.prototype.findGroupList=function(e,t,i,n,r){if(!e||!t)return null;try{var o=null;if(r)o=r.children;else if("selector"===i.element_config.field)o=document.querySelector(i.element_config.selector)&&document.querySelector(i.element_config.selector).children;else{var a=n.element_config.position.indexOf("*"),s=n.element_config.position.slice(0,a+1),c=n.element_config.path.split("/");o=getElementsFromXPathNext(c=c.slice(0,a+2).join("/"),s)}return o?(o=Array.from(o)).filter(function(i){return!!t.some(function(e){return i.contains(e)})||e.some(function(e){return i.contains(e)})}):null}catch(e){return null}},e.prototype.findCommonAncestor=function(e){var t=e[0];if(!t)return null;for(var i=function(){var i=t.parentNode;if(e.every(function(e){return i.contains(e)}))return{value:i};t=i};t.parentNode;){var n=i();if("object"==typeof n)return n.value}return null},e.prototype.findRange=function(e,t){return function e(t,i,n){return null==i||n>15?null:t.every(function(e){return i.contains(e)})?i:void e(t,i.parentNode,n++)}(t,this.findCommonAncestor(e),1)},e.prototype.handleParamDynamicCode=function(e,t,i){try{var n=t;if(e.extra&&e.extra.value_dynamic_code){var r={value:t,type:e.type,prevParams:i||{}},o=evaluteDynamicCode(e.extra.value_dynamic_code)(r);n=void 0!==o?o:""}return n}catch(e){return console.error(e),void 0!==t?t:""}},e.prototype.handleParams=function(e,t,i){if("number"==typeof t)return this.handleParamDynamicCode(e,t,i);if(!e.extra||!e.extra.value_regexp)return this.handleParamDynamicCode(e,t,i);try{var n=new RegExp(e.extra.value_regexp,"g");if(t instanceof Object){for(var r in t){if("number"==typeof t[r])break;var o=t[r].match(n);t[r]=o?o.join():""}return this.handleParamDynamicCode(e,t,i)}var a=t;return a=(o=t&&t.match(n))?o.join():"",this.handleParamDynamicCode(e,a,i)}catch(e){return console.error(e),t instanceof Object?t:""}},e.prototype.sendPresetValue=function(){try{var e=parseUrlQuery(location.href),t=this.storage.getCookie(),i=Object.keys(window.localStorage),n={};i.length&&i.forEach(function(e){n[e]=window.localStorage.getItem(e)});var r=window.visual_global;if(!this.origin)return;(window.opener||window.parent).postMessage({type:"visual:preset-variable:info",payload:{url_query:e,cookie:t,localStorage:n,visual_global:r}},"*")}catch(e){console.log("")}},e.prototype.getStaticValue=function(e,t,i){if(e.extra&&e.extra.similar_group_pattern){var n=e.value&&e.value.split(", ")||[],r=Array.from(i).findIndex(function(e){return e.contains(t)});return-1===r?"":n[r]||""}return e.value},e.prototype.getPresetValue=function(e,t,i,n,r){void 0===n&&(n=[]);var o={},a=t.slice(1);switch(t[0]){case"url":o[e]=location.href;break;case"url_path":o[e]=location.pathname;break;case"url_query":var s=parseUrlQuery(location.href);o[e]=s[a[0]];break;case"title":o[e]=document.title;break;case"date":o[e]=this.formatTime("date");break;case"time":o[e]=this.formatTime("time");break;case"timestamp":o[e]=this.formatTime("timestamp");break;case"fullDateTime":o[e]=this.formatTime("fullDateTime");break;case"cookie":var c=this.storage.getCookie(a[0]);o[e]=this.getChildValue(a,c,!1);break;case"localStorage":var l=window.localStorage.getItem(a[0]);try{l="string"==typeof l?JSON.parse(l):l,o[e]=this.getChildValue(a,l,!1)}catch(t){o[e]=l}break;case"visual_global":var u=window.visual_global&&window.visual_global[a[0]];o[e]=this.getChildValue(a,u,!1);break;case"component_data":var h=null,f=(h=i?Array.from(n).find(function(e){return e.contains(i)}):Array.from(n)[0])&&h.__component_data__&&h.__component_data__[a[0]];o[e]=this.getChildValue(a,f,!1);break;case"duration":o[e]=this.getChildValue(a,r,!0)}return o},e.prototype.formatTime=function(e){var t=new Date,i=t.getMonth()+1<10?"0"+(t.getMonth()+1):t.getMonth()+1,n=t.getDate()<10?"0"+t.getDate():t.getDate(),r=t.getHours()<10?"0"+t.getHours():t.getHours(),o=t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes(),a=t.getSeconds()<10?"0"+t.getSeconds():t.getSeconds();switch(e){case"date":return""+t.getFullYear()+i+n;case"time":return r+":"+o+":"+a;case"timestamp":return Date.now();case"fullDateTime":return t.getFullYear()+" -"+i+" -"+n+" "+r+":"+o+":"+a}},e.prototype.matchDependence=function(e){var t=this;try{var i=[];this.waitReportList.forEach(function(n){if(n.dependencies.length){var r=[];n.dependencies.forEach(function(i,o){if(t.dynamicEqualPath(e.url_path,i.api_config.url_path)&&e.method===i.api_config.method){var a=t.presetApiKey(i.api_config,i,n.configItem,n.element);n.params[i.name]=a?t.handleParams(i,t.getChildValue(a,e,!0)):"",r.push(o)}}),r.length&&(n.dependencies=n.dependencies.filter(function(e,t){return!r.includes(t)})),0===n.dependencies.length&&(t.handleReport(n.configItem,n.params),i.push(n.configItem.trigger_id))}}),i.length&&i.forEach(function(e){t.waitReportList.delete(e)})}catch(e){console.error(e)}},e.prototype.presetApiKey=function(e,t,i,n){var r=JSON.parse(JSON.stringify(e.field));if(r.includes("*")&&t.extra&&t.extra.similar_group_pattern)if(t.extra.similar_idx_group_element_config&&t.extra.similar_idx_group_element_config.selector){var o=document.querySelectorAll(t.extra.similar_idx_group_element_config.selector),a=Array.from(o).findIndex(function(e){return e.contains(n)});if(-1===a)return null;r[r.indexOf("*")]=""+a}else r[r.indexOf("*")]=this.getNodeIndex(i,n);return r},e.prototype.getApiValue=function(e,t,i,n,r,o){var a={};try{if(!this.apiList||!this.apiList.length)return i.extra.api_after_pattern?(this.setWaitList(i,n,o,r),a=null):a[e]="",a;var s=__spread(this.apiList);s.reverse();for(var c=!1,l=0;l<s.length;l++)if(this.dynamicEqualPath(s[l].url_path,t.url_path)&&s[l].method===t.method&&!c){c=!0;var u=this.presetApiKey(t,i,n,r);a[e]=u?this.getChildValue(u,s[l],!0):"";break}return c||(i.extra.api_after_pattern?(this.setWaitList(i,n,o,r),a=null):a[e]=""),a}catch(e){return console.error(e),a}},e.prototype.setWaitList=function(e,t,i,n){this.waitReportList.get(t.trigger_id)||this.waitReportList.set(t.trigger_id,{event:t.event,name:t.name,params:i,element:n,configItem:t,dependencies:[]});var r=this.waitReportList.get(t.trigger_id);r.dependencies.push(e),this.waitReportList.set(t.trigger_id,r)},e.prototype.updateWaitList=function(e,t){if(this.waitReportList.get(e.trigger_id)){var i=this.waitReportList.get(e.trigger_id);i.params=Object.assign(i.params,t),this.waitReportList.set(e.trigger_id,i)}},e.prototype.getNodeIndex=function(e,t){for(var i="0",n="selector"===e.element_config.field?document.querySelector(e.element_config.selector)?document.querySelector(e.element_config.selector).querySelectorAll(e.cond.similar_segment_selector):[]:"custom_selector"===e.element_config.field?document.querySelectorAll(e.element_config.selector):getElementsFromXPathNext(e.element_config.path,e.element_config.position),r=0;r<n.length;r++)if(e.cond.bubble_pattern){if(n[r].contains(t)){i=""+r;break}}else if(n[r]===t){i=""+r;break}return i},e.prototype.dynamicEqualPath=function(e,t){try{var i=e.split("/"),n=t.split("/");if(i.length!==n.length)return!1;for(var r=!0,o=0;o<n.length;o++)if(!n[o].includes(":")&&n[o]!==i[o]){r=!1;break}return r}catch(e){return console.error(e),!1}},e.prototype.sendApiValue=function(){if(this.apiList.length&&this.origin)try{(window.opener||window.parent).postMessage({type:"visual:api:info",payload:this.apiList},this.origin)}catch(e){console.log("")}},e.prototype.getChildValue=function(e,t,i){try{if(t)for(var n=i?0:1;n<e.length;n++){if(!t||void 0===t[e[n]]){t="";break}t=t[e[n]]}return void 0!==t?t:""}catch(e){return console.error(e),""}},e.prototype.typeChange=function(e,t){return 1===e?parseInt(t):2===e?parseFloat(t):t&&t.toString()},e.prototype.includsArray=function(e,t){if(e.length<t.length)return!1;try{var i=e.join("").toString(),n=t.join("").toString(),r=n.indexOf("*");if(i.slice(0,r)===n.slice(0,r)){var o=i.slice(r+1),a=n.slice(r+1);return!a.length||0===o.indexOf(a)}return!1}catch(e){return!1}},e.prototype.setPreview=function(){var e=this;return window.addEventListener("message",function(t){t&&t.data&&"visual:preview:config"===t.data.type&&(e.visualConfig=t.data.payload,e.previewStatus=!0,e.ready=!0,e.origin=t.origin,e.viewEvent(e.visualConfig))},!0),(window.opener||window.parent).postMessage({type:"visual:preview:ready"},"*"),function(){window.removeEventListener("message",function(){},!1)}},e.prototype.setConfig=function(e){this.collector.configManager.set({visual_config_name:e.name||"",visual_container_id:this.visualConfig.vcid||"",visual_version:this.visualConfig.version||""})},e.prototype.handleReport=function(e,t,i){this.setConfig(e),this.previewStatus?this.postPreview(e.event,t):this.report(e.event,t,i)},e.prototype.postPreview=function(e,t){var i=[];i.push(this.collector.processEvent(e,t));var n=this.collector.eventManager.merge(i);this.origin&&(window.opener||window.parent).postMessage({type:"visual:preview:event",payload:n},this.origin)},e.prototype.report=function(e,t,i){var n=this;try{var r=[];r.push(this.collector.processEvent(e,t));var o=this.collector.eventManager.merge(r);i?this.collector.beconEvent(e,t):(this.eventCache.push(o),this.timer&&clearTimeout(this.timer),this.eventCache.length>10?this.send():this.timer=setTimeout(function(){n.send(),clearTimeout(n.timer)},30))}catch(e){console.log("visual report error",e.message)}},e.prototype.send=function(){this.collector.eventManager.send(this.eventCache),this.eventCache=[]},e.prototype.errorReport=function(e,t){try{var i=[],n=this.collector.configManager.get(),r=n.header,o=n.user,a={event:"visual_plugin_catch_error",params:JSON.stringify(this.errorConfig(JSON.stringify(e&&e.stack||""),t)),local_time_ms:Date.now()};i.push(a);var s={events:i,user:o,header:r};this.collector.requestManager.useRequest({url:this.reportUrl,data:[s],app_key:"566f58151b0ed37e"})}catch(e){}},e.prototype.errorConfig=function(e,t){var i={};try{i={visual_container_id:this.config.visual_container_id,app_id:this.config.app_id,user_unique_id:this.collector.configManager.get("user").user_unique_id,url:location.href,error:e,config_name:t&&t.name}}finally{return i}},e}();exports.VISUAL_EVENT_URL=VISUAL_EVENT_URL,exports.default=Visual;
