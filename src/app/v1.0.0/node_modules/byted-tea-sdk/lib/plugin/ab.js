"use strict";var __assign=function(){return(__assign=Object.assign||function(e){for(var t,s=1,i=arguments.length;s<i;s++)for(var a in t=arguments[s])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},STYLE_ID="__rangers_ab_style__";function openOverlayer(){if(!document.getElementById(STYLE_ID)){var e="body { opacity: 0 !important; }",t=document.head||document.getElementsByTagName("head")[0],s=document.createElement("style");s.id=STYLE_ID,s.type="text/css",s.styleSheet?s.styleSheet.cssText=e:s.appendChild(document.createTextNode(e)),t.appendChild(s)}}function closeOverlayer(){var e=document.getElementById(STYLE_ID);e&&e.parentElement.removeChild(e)}var Types,DebuggerMesssge,CallbackType,isObject=function(e){return null!=e&&"[object Object]"==Object.prototype.toString.call(e)},getIndex=function(){var e=+Date.now()+Number((""+Math.random()).slice(2,8));return function(){return e+=1}}(),decrypto=function(e,t,s){if("string"==typeof e&&"number"==typeof t&&"number"==typeof s){var i,a=[];s=s<=25?s:s%25;var o=String.fromCharCode(s+97);i=e.split(o);for(var r=0;r<i.length;r++){var n=parseInt(i[r],s);n=1*n^t;var c=String.fromCharCode(n);a.push(c)}return a.join("")}},decodeUrl=function(e){return decrypto(e,64,25)},getIframeUrl=function(){try{var e=JSON.parse(atob(window.name));return e||void 0}catch(e){return}},parseURL=function(e){var t=document.createElement("a");return t.href=e,t},parseUrlQuery=function(e){var t={};try{var s=parseURL(e).search;if(!s)return t;(s=s.slice(1)).split("&").forEach(function(e){var s,i,a=e.split("=");a.length&&(s=a[0],i=a[1]);try{t[s]=decodeURIComponent(void 0===i?"":i)}catch(e){t[s]=i}})}catch(e){}return t},AB_DOMAINS={cn:"1fz22z22z1nz21z4mz4bz4bz22z1mz19z1jz1mz1ez4az1az22z1mz19z21z1lz21z21z1bz1iz4az1az1mz1k",va:"1fz22z22z1nz21z4mz4bz4bz22z1mz19z1jz1mz1ez4az1gz22z1mz19z21z1lz21z21z1bz1iz4az1az1mz1k",sg:"1fz22z22z1nz21z4mz4bz4bz22z1mz19z1jz1mz1ez4az22z1mz19z21z1lz21z21z1bz1iz4az1az1mz1k"},VISUAL_EDITOR_RANGERS=decodeUrl("1fz22z22z1nz21z4mz4bz4bz1jz1dz49z1az1bz1lz49z22z1mz21z4az19z27z22z1cz21z1az1kz4az1az1mz1kz4bz1mz19z1hz4bz21z22z18z22z1gz1az4bz1jz1mz1ez49z21z1bz1iz4bz1az1mz1jz1jz1cz1az22z4bz24z1gz21z23z18z1jz49z1cz1bz1gz22z1mz20z49z20z18z1lz1ez1cz20z21z4az1hz21"),VISUAL_AB_CORE=decodeUrl("1fz22z22z1nz21z4mz4bz4bz1jz1dz49z1az1bz1lz49z22z1mz21z4az19z27z22z1cz21z1az1kz4az1az1mz1kz4bz1mz19z1hz4bz21z22z18z22z1gz1az4bz1jz1mz1ez49z21z1bz1iz4bz1az1mz1jz1jz1cz1az22z4bz24z1gz21z23z18z1jz49z18z19z49z1az1mz20z1cz4az1hz21"),VISUAL_AB_LOADER=decodeUrl("1fz22z22z1nz21z4mz4bz4bz1jz1dz49z1az1bz1lz49z22z1mz21z4az19z27z22z1cz21z1az1kz4az1az1mz1kz4bz1mz19z1hz4bz21z22z18z22z1gz1az4bz1jz1mz1ez49z21z1bz1iz4bz1az1mz1jz1jz1cz1az22z4bz24z1gz21z23z18z1jz49z18z19z49z1jz1mz18z1bz1cz20z4az1hz21"),HOT_PIC_URL=decodeUrl("1fz22z22z1nz21z4mz4bz4bz1jz1dz49z1az1bz1lz49z22z1mz21z4az19z27z22z1cz21z1az1kz4az1az1mz1kz4bz1mz19z1hz4bz21z22z18z22z1gz1az4bz1jz1mz1ez49z21z1bz1iz4bz1az1mz1jz1jz1cz1az22z4bz1fz1cz18z22z1kz18z1nz49z1az1mz20z1c"),VISUAL_URL_INSPECTOR=decodeUrl("1fz22z22z1nz21z4mz4bz4bz1jz1dz4fz49z1bz18z22z18z4az24z1mz1jz1az1az1bz1lz4az1az1mz1kz4bz1mz19z1hz4bz1bz18z22z18z49z21z22z18z22z1gz1az4bz1jz1mz1ez49z21z1bz1iz4bz1az1mz1jz1jz1cz1az22z4bz22z1cz21z22z1cz20z49z1cz24z1cz1lz22z49z1gz1lz21z1nz1cz1az22z1mz20");!function(e){e.Init="init",e.Config="config",e.Start="start",e.Ready="ready",e.UnReady="un-ready",e.TokenComplete="token-complete",e.TokenStorage="token-storage",e.TokenFetch="token-fetch",e.TokenError="token-error",e.ConfigUuid="config-uuid",e.ConfigWebId="config-webid",e.ConfigDomain="config-domain",e.CustomWebId="custom-webid",e.TokenChange="token-change",e.TokenReset="token-reset",e.ConfigTransform="config-transform",e.EnvTransform="env-transform",e.SessionReset="session-reset",e.SessionResetTime="session-reset-time",e.SetSessionId="set-session-id",e.Event="event",e.Events="events",e.EventNow="event-now",e.CleanEvents="clean-events",e.BeconEvent="becon-event",e.SubmitBefore="submit-before",e.SubmitScuess="submit-scuess",e.SubmitAfter="submit-after",e.SubmitError="submit-error",e.SubmitVerify="submit-verify",e.Stay="stay",e.ResetStay="reset-stay",e.StayReady="stay-ready",e.SetStay="set-stay",e.RouteChange="route-change",e.RouteReady="route-ready",e.Ab="ab",e.AbVar="ab-var",e.AbAllVars="ab-all-vars",e.AbConfig="ab-config",e.AbExternalVersion="ab-external-version",e.AbVersionChangeOn="ab-version-change-on",e.AbVersionChangeOff="ab-version-change-off",e.AbOpenLayer="ab-open-layer",e.AbCloseLayer="ab-close-layer",e.AbReady="ab-ready",e.AbComplete="ab-complete",e.AbTimeout="ab-timeout",e.Profile="profile",e.ProfileSet="profile-set",e.ProfileSetOnce="profile-set-once",e.ProfileUnset="profile-unset",e.ProfileIncrement="profile-increment",e.ProfileAppend="profile-append",e.ProfileClear="profile-clear",e.Autotrack="autotrack",e.AutotrackReady="autotrack-ready",e.CepReady="cep-ready",e.TracerReady="tracer-ready",e.sessionRecord="session-record",e.SessionRecordStart="session-record-start",e.SessionRecordPause="session-record-pause",e.SessionRecordEnd="session-record-end",e.SessionRecordReport="session-record-report",e.DestoryInstance="destory-instance",e.VisualCollectReady="visual-collect-ready",e.VisualApiReady="visual-api-ready",e.VisualApiUpdate="visual-api-update"}(Types||(Types={})),function(e){e.DEBUGGER_MESSAGE="debugger-message",e.DEBUGGER_MESSAGE_SDK="debugger-message-sdk",e.DEBUGGER_MESSAGE_FETCH="debugger-message-fetch",e.DEBUGGER_MESSAGE_FETCH_RESULT="debugger-message-fetch-result",e.DEBUGGER_MESSAGE_EVENT="debugger-message-event",e.DEVTOOL_WEB_READY="devtool-web-ready"}(DebuggerMesssge||(DebuggerMesssge={})),function(e){e[e.Var=0]="Var",e[e.All=1]="All"}(CallbackType||(CallbackType={}));var STORAGE_EXPRIRE=2592e6,API="/service/2/abtest_config/",Ab=function(){function e(){this.fetchStatus="no",this.refreshFetchStatus="complete",this.versions=[],this.extVersions=[],this.mulilinkVersions=[],this.enable_multilink=!1,this.enable_ab_visual=!1,this.editMode=!1,this.callbacks=[],this.data=null,this.changeListener=new Map,this.readyStatus=!1,this.exposureCache=[]}return e.prototype.apply=function(e,t){var s=this;if(t.enable_ab_test){this.collect=e,this.config=t;var i=t.enable_multilink,a=t.ab_channel_domain,o=t.enable_ab_visual,r=t.ab_cross,n=t.ab_cookie_domain,c=t.ab_timeout,z=a||decodeUrl(AB_DOMAINS[t.channel||"cn"]),l=e.adapters.storage,h=this.collect.Types;this.types=h,this.cacheStorgae=new l(!1),this.timeout=c||3e3,this.enable_multilink=i,this.enable_ab_visual=o,this.abKey="__tea_sdk_ab_version_"+t.app_id,this.ab_cross=r,this.ab_cookie_domain=n||"",this.fetchUrl=""+z+API,this.reportUrl=""+e.configManager.getUrl("event"),this.exposureLimit=t.exposure_limit||20,this.ab_batch_time=t.ab_batch_time||500,this.ab_user_mode=t.ab_user_mode||"user_unique_id",this.collect.on(h.TokenChange,function(e){"uuid"===e&&s.readyStatus&&(s.clearCache(),s.fetchAB())}),this.collect.on(h.TokenReset,function(e){"uuid"===e&&s.readyStatus&&(s.clearCache(),s.fetchAB())}),this.collect.on(h.AbVar,function(e){var t=e.name,i=e.defaultValue,a=e.callback;s.getVar(t,i,a)}),this.collect.on(h.AbAllVars,function(e){s.getAllVars(e)}),this.collect.on(h.AbConfig,function(e){var t=e.params,i=e.callback;s.getABconfig(t,i)}),this.collect.on(h.AbExternalVersion,function(e){s.setExternalAbVersion(e)}),this.collect.on(h.AbOpenLayer,function(){s.openOverlayer()}),this.collect.on(h.AbCloseLayer,function(){s.closeOverlayer()}),this.collect.on(h.AbVersionChangeOn,function(e){s.changeListener.set(e,e)}),this.collect.on(h.AbVersionChangeOff,function(e){s.changeListener.get(e)&&s.changeListener.delete(e)}),this.loadMode(),(this.enable_ab_visual||this.enable_multilink)&&this.openOverlayer(this.config.multilink_timeout_ms||500),this.checkLocal(),this.ready("ab"),this.readyStatus||(this.fetchAB(),this.readyStatus=!0),this.collect.emit(h.AbReady)}},e.prototype.ready=function(e){var t=this;if(this.collect.set(e),this.collect.hook._hooksCache.hasOwnProperty(e)){var s=this.collect.hook._hooksCache[e];if(!Object.keys(s).length)return;var i=function(e){s[e].length&&s[e].forEach(function(s){t.collect.hook.emit(e,s)})};for(var a in s)i(a)}},e.prototype.loadMode=function(){var e=getIframeUrl(),t="";if(e){var s=e.scenario,i=e.href;s?(this.editMode=!0,t=s):!i||-1===i.indexOf("datatester")&&-1===i.indexOf("visual-editor")||(this.editMode=!0,t="visual-editor")}this.enable_ab_visual&&"visual-editor"===t&&this.collect.destoryInstace()},e.prototype.checkLocal=function(){var e=this.getABCache(),t=e.ab_version,s=e.ab_ext_version,i=e.ab_version_multilink,a=e.data,o=this.checkFromUrl();o?this.mulilinkVersions.push(o):this.mulilinkVersions=i||[],this.extVersions=s||[],this.versions=t||[],this.data=a;var r=this.versions.concat(this.extVersions);this.enable_multilink&&(r=r.concat(this.mulilinkVersions)),this.configVersions(r.join(","))},e.prototype.checkFromUrl=function(){var e=parseUrlQuery(window.location.href);return e&&e.vid?e.vid:""},e.prototype.updateVersions=function(){var e=this.extVersions.length?this.versions.concat(this.extVersions):this.versions;this.enable_multilink&&(e=e.concat(this.mulilinkVersions)),this.configVersions(e.join(",")),this.updateABCache(),this.changeListener.size>0&&this.changeListener.forEach(function(t){"function"==typeof t&&t(e)})},e.prototype.configVersions=function(e){this.collect.configManager.setAbVersion(e)},e.prototype.getVar=function(e,t,s){if(!e)throw new Error("variable must not be empty");if(void 0===t)throw new Error("variable no default value");if("function"!=typeof s)throw new Error("callback must be a function");var i={name:e,defaultValue:t,callback:s,type:CallbackType.Var};"complete"===this.fetchStatus&&"complete"===this.refreshFetchStatus?this.getRealVar(i,e):this.callbacks.push(i)},e.prototype.getRealVar=function(e,t){var s=e.name,i=e.defaultValue,a=e.callback,o=this.data;if(o){if(isObject(o[s])){var r=o[s].vid;return"$ab_url"===t?this.mulilinkVersions.includes(r)||this.mulilinkVersions.push(r):this.versions.includes(r)||this.versions.push(r),this.updateVersions(),this.fechEvent(r,t,i),a(o[s].val),void this.collect.emit(DebuggerMesssge.DEBUGGER_MESSAGE,{type:DebuggerMesssge.DEBUGGER_MESSAGE_SDK,secType:"AB",info:"SDK 曝光了实验"+s,level:"info",time:Date.now(),data:o[s]})}this.collect.emit(DebuggerMesssge.DEBUGGER_MESSAGE,{type:DebuggerMesssge.DEBUGGER_MESSAGE_SDK,secType:"AB",info:"SDK 调用getVar",level:"info",time:Date.now(),data:i}),a(i)}else a(i)},e.prototype.getAllVars=function(e){if("function"!=typeof e)throw new Error("callback must be a function");var t={callback:e,type:CallbackType.All};"complete"===this.fetchStatus&&"complete"===this.refreshFetchStatus?this.getRealAllVars(t):this.callbacks.push(t)},e.prototype.getRealAllVars=function(e){(0,e.callback)(this.data?JSON.parse(JSON.stringify(this.data)):{}),this.collect.emit(DebuggerMesssge.DEBUGGER_MESSAGE,{type:DebuggerMesssge.DEBUGGER_MESSAGE_SDK,secType:"AB",info:"SDK 调用getAllVars",level:"info",time:Date.now(),data:this.data})},e.prototype.fechEvent=function(e,t,s){try{if(this.config.disable_track_event)return;if(!e)return;var i=this.collect.configManager.get(),a=i.header,o=i.user,r=this.getABCache(),n=o[this.ab_user_mode]||o.user_unique_id;if(r&&r.uuid&&r.uuid!==n)return;var c={event:"abtest_exposure",ab_sdk_version:""+e,params:JSON.stringify({app_id:this.config.appId,ab_url:"$ab_url"===t?s:window.location.href}),local_time_ms:Date.now()};a.custom=JSON.stringify(a.custom);var z={events:[c],user:o,header:a};this.reportExposure(z,t)}catch(e){this.collect.emit(DebuggerMesssge.DEBUGGER_MESSAGE,{type:DebuggerMesssge.DEBUGGER_MESSAGE_SDK,info:"发生了异常",level:"error",time:Date.now(),data:e.message})}},e.prototype.reportExposure=function(e,t){var s=this;this.exposureCache.push(e),this.reportTimeout&&clearTimeout(this.reportTimeout),this.exposureCache.length>=this.exposureLimit?this.report(t):this.reportTimeout=setTimeout(function(){s.report(t),clearTimeout(s.reportTimeout)},this.ab_batch_time)},e.prototype.report=function(e){var t=this;this.collect.requestManager.useRequest({url:this.reportUrl,data:this.exposureCache,timeout:2e4,useBeacon:"$ab_url"===e}),this.exposureCache.forEach(function(e){t.collect.emit(DebuggerMesssge.DEBUGGER_MESSAGE,{type:DebuggerMesssge.DEBUGGER_MESSAGE_EVENT,info:"埋点上报成功",time:Date.now(),data:[e],code:200,status:"success"})}),this.exposureCache=[]},e.prototype.setExternalAbVersion=function(e){this.extVersions=[e],this.updateVersions()},e.prototype.getABconfig=function(e,t){var s=Object.keys(e);s&&s.length&&this.collect.configManager.set(e),this.fetchAB(t)},e.prototype.get=function(e){if(this.ab_cross){var t=this.cacheStorgae.getCookie(e,this.ab_cookie_domain);return t?JSON.parse(t):{}}return this.cacheStorgae.getItem(e)},e.prototype.set=function(e,t){this.ab_cross?this.cacheStorgae.setCookie(e,t,STORAGE_EXPRIRE,this.ab_cookie_domain):this.cacheStorgae.setItem(e,t),this.collect.configManager.setAbCache(t)},e.prototype.getABCache=function(e){var t={ab_version:[],ab_ext_version:[],ab_version_multilink:[],data:null,timestamp:+new Date,uuid:""};return t=this.get(this.abKey)||t,e?t[e]:t},e.prototype.updateABCache=function(){var e=this.getABCache();e.ab_version_multilink=this.mulilinkVersions,e.ab_ext_version=this.extVersions,e.ab_version=this.versions,e.timestamp=Date.now(),this.set(this.abKey,e)},e.prototype.setAbCache=function(e){var t=this.getABCache();t.data=this.data,t.uuid=e,t.timestamp=Date.now(),this.set(this.abKey,t)},e.prototype.clearCache=function(){this.refreshFetchStatus="ing",this.data={},this.extVersions=[],this.mulilinkVersions=[],this.versions=[],this.collect.configManager.clearAbCache()},e.prototype.openOverlayer=function(e){var t=this;if(openOverlayer(),e)var s=setTimeout(function(){t.closeOverlayer(),clearTimeout(s)},e)},e.prototype.closeOverlayer=function(){closeOverlayer()},e.prototype.fetchComplete=function(e,t){var s=this;try{if(e&&"[object Object]"==Object.prototype.toString.call(e)){this.data=e,this.setAbCache(t);var i=[];Object.keys(e).forEach(function(t){var s=e[t].vid;s&&i.push(s)}),this.versions=this.versions.filter(function(e){return i.includes(e)});var a=e.$ab_url,o=e.$ab_modification;if(o&&o.val&&this.enable_ab_visual){if(this.collect.destroy)return}else if(a&&this.enable_multilink){this.mulilinkVersions=this.mulilinkVersions.filter(function(e){return i.includes(e)});var r=a.val,n=a.vid;r&&n&&this.getVar("$ab_url",r,function(){s.editMode||(r!==window.location.href?setTimeout(function(){if(!s.collect.destroy){var e=""+r;e=-1===e.indexOf("http")?"https://"+e:e,parseURL(e).host!==location.host?e=e+"&vid="+n:window.history.replaceState("","",e),window.location.href=e}},100):s.closeOverlayer())})}this.updateVersions()}else this.closeOverlayer();this.callbacks.forEach(function(e){return s[e.type===CallbackType.Var?"getRealVar":"getRealAllVars"](e,"")}),this.callbacks=[]}catch(e){}},e.prototype.fetchAB=function(e){var t=this,s=this.collect.configManager.get(),i={header:__assign(__assign(__assign({aid:this.config.app_id},s.user||{}),s.header||{}),{ab_sdk_version:this.collect.configManager.getAbVersion(),ab_url:window.location.href})};this.collect.emit(DebuggerMesssge.DEBUGGER_MESSAGE,{type:DebuggerMesssge.DEBUGGER_MESSAGE_SDK,info:"SDK 发起AB实验请求",level:"info",logType:"fetch",time:Date.now(),data:i});var a=s.user[this.ab_user_mode]||s.user.user_unique_id;this.collect.requestManager.useRequest({url:this.fetchUrl,data:i,success:function(s){t.fetchStatus="complete",t.refreshFetchStatus="complete";var i=s.data;"success"===s.message?(t.fetchComplete(i,a),e&&e(i)):(t.fetchComplete(null,a),e&&e(null)),t.collect.emit(t.types.AbComplete,i),t.collect.emit(DebuggerMesssge.DEBUGGER_MESSAGE,{type:DebuggerMesssge.DEBUGGER_MESSAGE_SDK,secType:"AB",info:"AB实验请求成功",level:"info",logType:"fetch",time:Date.now(),data:i})},fail:function(){t.fetchStatus="complete",t.refreshFetchStatus="complete",t.fetchComplete(null,a),t.collect.emit(t.types.AbTimeout),e&&e(null),t.collect.emit(DebuggerMesssge.DEBUGGER_MESSAGE,{type:DebuggerMesssge.DEBUGGER_MESSAGE_SDK,secType:"AB",info:"AB实验请求网络异常",level:"error",logType:"fetch",time:Date.now()})},timeout:this.timeout})},e}();module.exports=Ab;
