var e=function(){return(e=Object.assign||function(e){for(var t,i=1,a=arguments.length;i<a;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},t="__rangers_ab_style__";i=+Date.now()+Number((""+Math.random()).slice(2,8));var i,a,o,s,n=function(e){return function(e,t,i){if("string"==typeof e&&"number"==typeof t&&"number"==typeof i){var a,o=[];i=i<=25?i:i%25;var s=String.fromCharCode(i+97);a=e.split(s);for(var n=0;n<a.length;n++){var r=parseInt(a[n],i);r=1*r^t;var z=String.fromCharCode(r);o.push(z)}return o.join("")}}(e,64,25)},r=function(e){var t=document.createElement("a");return t.href=e,t},z={cn:"1fz22z22z1nz21z4mz4bz4bz22z1mz19z1jz1mz1ez4az1az22z1mz19z21z1lz21z21z1bz1iz4az1az1mz1k",va:"1fz22z22z1nz21z4mz4bz4bz22z1mz19z1jz1mz1ez4az1gz22z1mz19z21z1lz21z21z1bz1iz4az1az1mz1k",sg:"1fz22z22z1nz21z4mz4bz4bz22z1mz19z1jz1mz1ez4az22z1mz19z21z1lz21z21z1bz1iz4az1az1mz1k"};n("1fz22z22z1nz21z4mz4bz4bz1jz1dz49z1az1bz1lz49z22z1mz21z4az19z27z22z1cz21z1az1kz4az1az1mz1kz4bz1mz19z1hz4bz21z22z18z22z1gz1az4bz1jz1mz1ez49z21z1bz1iz4bz1az1mz1jz1jz1cz1az22z4bz24z1gz21z23z18z1jz49z1cz1bz1gz22z1mz20z49z20z18z1lz1ez1cz20z21z4az1hz21"),n("1fz22z22z1nz21z4mz4bz4bz1jz1dz49z1az1bz1lz49z22z1mz21z4az19z27z22z1cz21z1az1kz4az1az1mz1kz4bz1mz19z1hz4bz21z22z18z22z1gz1az4bz1jz1mz1ez49z21z1bz1iz4bz1az1mz1jz1jz1cz1az22z4bz24z1gz21z23z18z1jz49z18z19z49z1az1mz20z1cz4az1hz21"),n("1fz22z22z1nz21z4mz4bz4bz1jz1dz49z1az1bz1lz49z22z1mz21z4az19z27z22z1cz21z1az1kz4az1az1mz1kz4bz1mz19z1hz4bz21z22z18z22z1gz1az4bz1jz1mz1ez49z21z1bz1iz4bz1az1mz1jz1jz1cz1az22z4bz24z1gz21z23z18z1jz49z18z19z49z1jz1mz18z1bz1cz20z4az1hz21"),n("1fz22z22z1nz21z4mz4bz4bz1jz1dz49z1az1bz1lz49z22z1mz21z4az19z27z22z1cz21z1az1kz4az1az1mz1kz4bz1mz19z1hz4bz21z22z18z22z1gz1az4bz1jz1mz1ez49z21z1bz1iz4bz1az1mz1jz1jz1cz1az22z4bz1fz1cz18z22z1kz18z1nz49z1az1mz20z1c"),n("1fz22z22z1nz21z4mz4bz4bz1jz1dz4fz49z1bz18z22z18z4az24z1mz1jz1az1az1bz1lz4az1az1mz1kz4bz1mz19z1hz4bz1bz18z22z18z49z21z22z18z22z1gz1az4bz1jz1mz1ez49z21z1bz1iz4bz1az1mz1jz1jz1cz1az22z4bz22z1cz21z22z1cz20z49z1cz24z1cz1lz22z49z1gz1lz21z1nz1cz1az22z1mz20");!function(e){e.Init="init",e.Config="config",e.Start="start",e.Ready="ready",e.UnReady="un-ready",e.TokenComplete="token-complete",e.TokenStorage="token-storage",e.TokenFetch="token-fetch",e.TokenError="token-error",e.ConfigUuid="config-uuid",e.ConfigWebId="config-webid",e.ConfigDomain="config-domain",e.CustomWebId="custom-webid",e.TokenChange="token-change",e.TokenReset="token-reset",e.ConfigTransform="config-transform",e.EnvTransform="env-transform",e.SessionReset="session-reset",e.SessionResetTime="session-reset-time",e.SetSessionId="set-session-id",e.Event="event",e.Events="events",e.EventNow="event-now",e.CleanEvents="clean-events",e.BeconEvent="becon-event",e.SubmitBefore="submit-before",e.SubmitScuess="submit-scuess",e.SubmitAfter="submit-after",e.SubmitError="submit-error",e.SubmitVerify="submit-verify",e.Stay="stay",e.ResetStay="reset-stay",e.StayReady="stay-ready",e.SetStay="set-stay",e.RouteChange="route-change",e.RouteReady="route-ready",e.Ab="ab",e.AbVar="ab-var",e.AbAllVars="ab-all-vars",e.AbConfig="ab-config",e.AbExternalVersion="ab-external-version",e.AbVersionChangeOn="ab-version-change-on",e.AbVersionChangeOff="ab-version-change-off",e.AbOpenLayer="ab-open-layer",e.AbCloseLayer="ab-close-layer",e.AbReady="ab-ready",e.AbComplete="ab-complete",e.AbTimeout="ab-timeout",e.Profile="profile",e.ProfileSet="profile-set",e.ProfileSetOnce="profile-set-once",e.ProfileUnset="profile-unset",e.ProfileIncrement="profile-increment",e.ProfileAppend="profile-append",e.ProfileClear="profile-clear",e.Autotrack="autotrack",e.AutotrackReady="autotrack-ready",e.CepReady="cep-ready",e.TracerReady="tracer-ready",e.sessionRecord="session-record",e.SessionRecordStart="session-record-start",e.SessionRecordPause="session-record-pause",e.SessionRecordEnd="session-record-end",e.SessionRecordReport="session-record-report",e.DestoryInstance="destory-instance",e.VisualCollectReady="visual-collect-ready",e.VisualApiReady="visual-api-ready",e.VisualApiUpdate="visual-api-update"}(a||(a={})),function(e){e.DEBUGGER_MESSAGE="debugger-message",e.DEBUGGER_MESSAGE_SDK="debugger-message-sdk",e.DEBUGGER_MESSAGE_FETCH="debugger-message-fetch",e.DEBUGGER_MESSAGE_FETCH_RESULT="debugger-message-fetch-result",e.DEBUGGER_MESSAGE_EVENT="debugger-message-event",e.DEVTOOL_WEB_READY="devtool-web-ready"}(o||(o={})),function(e){e[e.Var=0]="Var",e[e.All=1]="All"}(s||(s={}));export default(function(){function i(){this.fetchStatus="no",this.refreshFetchStatus="complete",this.versions=[],this.extVersions=[],this.mulilinkVersions=[],this.enable_multilink=!1,this.enable_ab_visual=!1,this.editMode=!1,this.callbacks=[],this.data=null,this.changeListener=new Map,this.readyStatus=!1,this.exposureCache=[]}return i.prototype.apply=function(e,t){var i=this;if(t.enable_ab_test){this.collect=e,this.config=t;var a=t.enable_multilink,o=t.ab_channel_domain,s=t.enable_ab_visual,r=t.ab_cross,c=t.ab_cookie_domain,l=t.ab_timeout,h=o||n(z[t.channel||"cn"]),u=e.adapters.storage,f=this.collect.Types;this.types=f,this.cacheStorgae=new u(!1),this.timeout=l||3e3,this.enable_multilink=a,this.enable_ab_visual=s,this.abKey="__tea_sdk_ab_version_"+t.app_id,this.ab_cross=r,this.ab_cookie_domain=c||"",this.fetchUrl=h+"/service/2/abtest_config/",this.reportUrl=""+e.configManager.getUrl("event"),this.exposureLimit=t.exposure_limit||20,this.ab_batch_time=t.ab_batch_time||500,this.ab_user_mode=t.ab_user_mode||"user_unique_id",this.collect.on(f.TokenChange,function(e){"uuid"===e&&i.readyStatus&&(i.clearCache(),i.fetchAB())}),this.collect.on(f.TokenReset,function(e){"uuid"===e&&i.readyStatus&&(i.clearCache(),i.fetchAB())}),this.collect.on(f.AbVar,function(e){var t=e.name,a=e.defaultValue,o=e.callback;i.getVar(t,a,o)}),this.collect.on(f.AbAllVars,function(e){i.getAllVars(e)}),this.collect.on(f.AbConfig,function(e){var t=e.params,a=e.callback;i.getABconfig(t,a)}),this.collect.on(f.AbExternalVersion,function(e){i.setExternalAbVersion(e)}),this.collect.on(f.AbOpenLayer,function(){i.openOverlayer()}),this.collect.on(f.AbCloseLayer,function(){i.closeOverlayer()}),this.collect.on(f.AbVersionChangeOn,function(e){i.changeListener.set(e,e)}),this.collect.on(f.AbVersionChangeOff,function(e){i.changeListener.get(e)&&i.changeListener.delete(e)}),this.loadMode(),(this.enable_ab_visual||this.enable_multilink)&&this.openOverlayer(this.config.multilink_timeout_ms||500),this.checkLocal(),this.ready("ab"),this.readyStatus||(this.fetchAB(),this.readyStatus=!0),this.collect.emit(f.AbReady)}},i.prototype.ready=function(e){var t=this;if(this.collect.set(e),this.collect.hook._hooksCache.hasOwnProperty(e)){var i=this.collect.hook._hooksCache[e];if(!Object.keys(i).length)return;var a=function(e){i[e].length&&i[e].forEach(function(i){t.collect.hook.emit(e,i)})};for(var o in i)a(o)}},i.prototype.loadMode=function(){var e=function(){try{var e=JSON.parse(atob(window.name));return e||void 0}catch(e){return}}(),t="";if(e){var i=e.scenario,a=e.href;i?(this.editMode=!0,t=i):!a||-1===a.indexOf("datatester")&&-1===a.indexOf("visual-editor")||(this.editMode=!0,t="visual-editor")}this.enable_ab_visual&&"visual-editor"===t&&this.collect.destoryInstace()},i.prototype.checkLocal=function(){var e=this.getABCache(),t=e.ab_version,i=e.ab_ext_version,a=e.ab_version_multilink,o=e.data,s=this.checkFromUrl();s?this.mulilinkVersions.push(s):this.mulilinkVersions=a||[],this.extVersions=i||[],this.versions=t||[],this.data=o;var n=this.versions.concat(this.extVersions);this.enable_multilink&&(n=n.concat(this.mulilinkVersions)),this.configVersions(n.join(","))},i.prototype.checkFromUrl=function(){var e=function(e){var t={};try{var i=r(e).search;if(!i)return t;(i=i.slice(1)).split("&").forEach(function(e){var i,a,o=e.split("=");o.length&&(i=o[0],a=o[1]);try{t[i]=decodeURIComponent(void 0===a?"":a)}catch(e){t[i]=a}})}catch(e){}return t}(window.location.href);return e&&e.vid?e.vid:""},i.prototype.updateVersions=function(){var e=this.extVersions.length?this.versions.concat(this.extVersions):this.versions;this.enable_multilink&&(e=e.concat(this.mulilinkVersions)),this.configVersions(e.join(",")),this.updateABCache(),this.changeListener.size>0&&this.changeListener.forEach(function(t){"function"==typeof t&&t(e)})},i.prototype.configVersions=function(e){this.collect.configManager.setAbVersion(e)},i.prototype.getVar=function(e,t,i){if(!e)throw new Error("variable must not be empty");if(void 0===t)throw new Error("variable no default value");if("function"!=typeof i)throw new Error("callback must be a function");var a={name:e,defaultValue:t,callback:i,type:s.Var};"complete"===this.fetchStatus&&"complete"===this.refreshFetchStatus?this.getRealVar(a,e):this.callbacks.push(a)},i.prototype.getRealVar=function(e,t){var i=e.name,a=e.defaultValue,s=e.callback,n=this.data;if(n){if(null!=(z=n[i])&&"[object Object]"==Object.prototype.toString.call(z)){var r=n[i].vid;return"$ab_url"===t?this.mulilinkVersions.includes(r)||this.mulilinkVersions.push(r):this.versions.includes(r)||this.versions.push(r),this.updateVersions(),this.fechEvent(r,t,a),s(n[i].val),void this.collect.emit(o.DEBUGGER_MESSAGE,{type:o.DEBUGGER_MESSAGE_SDK,secType:"AB",info:"SDK 曝光了实验"+i,level:"info",time:Date.now(),data:n[i]})}var z;this.collect.emit(o.DEBUGGER_MESSAGE,{type:o.DEBUGGER_MESSAGE_SDK,secType:"AB",info:"SDK 调用getVar",level:"info",time:Date.now(),data:a}),s(a)}else s(a)},i.prototype.getAllVars=function(e){if("function"!=typeof e)throw new Error("callback must be a function");var t={callback:e,type:s.All};"complete"===this.fetchStatus&&"complete"===this.refreshFetchStatus?this.getRealAllVars(t):this.callbacks.push(t)},i.prototype.getRealAllVars=function(e){(0,e.callback)(this.data?JSON.parse(JSON.stringify(this.data)):{}),this.collect.emit(o.DEBUGGER_MESSAGE,{type:o.DEBUGGER_MESSAGE_SDK,secType:"AB",info:"SDK 调用getAllVars",level:"info",time:Date.now(),data:this.data})},i.prototype.fechEvent=function(e,t,i){try{if(this.config.disable_track_event)return;if(!e)return;var a=this.collect.configManager.get(),s=a.header,n=a.user,r=this.getABCache(),z=n[this.ab_user_mode]||n.user_unique_id;if(r&&r.uuid&&r.uuid!==z)return;var c={event:"abtest_exposure",ab_sdk_version:""+e,params:JSON.stringify({app_id:this.config.appId,ab_url:"$ab_url"===t?i:window.location.href}),local_time_ms:Date.now()};s.custom=JSON.stringify(s.custom);var l={events:[c],user:n,header:s};this.reportExposure(l,t)}catch(e){this.collect.emit(o.DEBUGGER_MESSAGE,{type:o.DEBUGGER_MESSAGE_SDK,info:"发生了异常",level:"error",time:Date.now(),data:e.message})}},i.prototype.reportExposure=function(e,t){var i=this;this.exposureCache.push(e),this.reportTimeout&&clearTimeout(this.reportTimeout),this.exposureCache.length>=this.exposureLimit?this.report(t):this.reportTimeout=setTimeout(function(){i.report(t),clearTimeout(i.reportTimeout)},this.ab_batch_time)},i.prototype.report=function(e){var t=this;this.collect.requestManager.useRequest({url:this.reportUrl,data:this.exposureCache,timeout:2e4,useBeacon:"$ab_url"===e}),this.exposureCache.forEach(function(e){t.collect.emit(o.DEBUGGER_MESSAGE,{type:o.DEBUGGER_MESSAGE_EVENT,info:"埋点上报成功",time:Date.now(),data:[e],code:200,status:"success"})}),this.exposureCache=[]},i.prototype.setExternalAbVersion=function(e){this.extVersions=[e],this.updateVersions()},i.prototype.getABconfig=function(e,t){var i=Object.keys(e);i&&i.length&&this.collect.configManager.set(e),this.fetchAB(t)},i.prototype.get=function(e){if(this.ab_cross){var t=this.cacheStorgae.getCookie(e,this.ab_cookie_domain);return t?JSON.parse(t):{}}return this.cacheStorgae.getItem(e)},i.prototype.set=function(e,t){this.ab_cross?this.cacheStorgae.setCookie(e,t,2592e6,this.ab_cookie_domain):this.cacheStorgae.setItem(e,t),this.collect.configManager.setAbCache(t)},i.prototype.getABCache=function(e){var t={ab_version:[],ab_ext_version:[],ab_version_multilink:[],data:null,timestamp:+new Date,uuid:""};return t=this.get(this.abKey)||t,e?t[e]:t},i.prototype.updateABCache=function(){var e=this.getABCache();e.ab_version_multilink=this.mulilinkVersions,e.ab_ext_version=this.extVersions,e.ab_version=this.versions,e.timestamp=Date.now(),this.set(this.abKey,e)},i.prototype.setAbCache=function(e){var t=this.getABCache();t.data=this.data,t.uuid=e,t.timestamp=Date.now(),this.set(this.abKey,t)},i.prototype.clearCache=function(){this.refreshFetchStatus="ing",this.data={},this.extVersions=[],this.mulilinkVersions=[],this.versions=[],this.collect.configManager.clearAbCache()},i.prototype.openOverlayer=function(e){var i=this;if(function(){if(!document.getElementById(t)){var e="body { opacity: 0 !important; }",i=document.head||document.getElementsByTagName("head")[0],a=document.createElement("style");a.id=t,a.type="text/css",a.styleSheet?a.styleSheet.cssText=e:a.appendChild(document.createTextNode(e)),i.appendChild(a)}}(),e)var a=setTimeout(function(){i.closeOverlayer(),clearTimeout(a)},e)},i.prototype.closeOverlayer=function(){var e;(e=document.getElementById(t))&&e.parentElement.removeChild(e)},i.prototype.fetchComplete=function(e,t){var i=this;try{if(e&&"[object Object]"==Object.prototype.toString.call(e)){this.data=e,this.setAbCache(t);var a=[];Object.keys(e).forEach(function(t){var i=e[t].vid;i&&a.push(i)}),this.versions=this.versions.filter(function(e){return a.includes(e)});var o=e.$ab_url,n=e.$ab_modification;if(n&&n.val&&this.enable_ab_visual){if(this.collect.destroy)return}else if(o&&this.enable_multilink){this.mulilinkVersions=this.mulilinkVersions.filter(function(e){return a.includes(e)});var z=o.val,c=o.vid;z&&c&&this.getVar("$ab_url",z,function(){i.editMode||(z!==window.location.href?setTimeout(function(){if(!i.collect.destroy){var e=""+z;e=-1===e.indexOf("http")?"https://"+e:e,r(e).host!==location.host?e=e+"&vid="+c:window.history.replaceState("","",e),window.location.href=e}},100):i.closeOverlayer())})}this.updateVersions()}else this.closeOverlayer();this.callbacks.forEach(function(e){return i[e.type===s.Var?"getRealVar":"getRealAllVars"](e,"")}),this.callbacks=[]}catch(e){}},i.prototype.fetchAB=function(t){var i=this,a=this.collect.configManager.get(),s={header:e(e(e({aid:this.config.app_id},a.user||{}),a.header||{}),{ab_sdk_version:this.collect.configManager.getAbVersion(),ab_url:window.location.href})};this.collect.emit(o.DEBUGGER_MESSAGE,{type:o.DEBUGGER_MESSAGE_SDK,info:"SDK 发起AB实验请求",level:"info",logType:"fetch",time:Date.now(),data:s});var n=a.user[this.ab_user_mode]||a.user.user_unique_id;this.collect.requestManager.useRequest({url:this.fetchUrl,data:s,success:function(e){i.fetchStatus="complete",i.refreshFetchStatus="complete";var a=e.data;"success"===e.message?(i.fetchComplete(a,n),t&&t(a)):(i.fetchComplete(null,n),t&&t(null)),i.collect.emit(i.types.AbComplete,a),i.collect.emit(o.DEBUGGER_MESSAGE,{type:o.DEBUGGER_MESSAGE_SDK,secType:"AB",info:"AB实验请求成功",level:"info",logType:"fetch",time:Date.now(),data:a})},fail:function(){i.fetchStatus="complete",i.refreshFetchStatus="complete",i.fetchComplete(null,n),i.collect.emit(i.types.AbTimeout),t&&t(null),i.collect.emit(o.DEBUGGER_MESSAGE,{type:o.DEBUGGER_MESSAGE_SDK,secType:"AB",info:"AB实验请求网络异常",level:"error",logType:"fetch",time:Date.now()})},timeout:this.timeout})},i}());
