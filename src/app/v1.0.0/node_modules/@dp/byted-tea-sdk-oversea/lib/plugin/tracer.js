"use strict";var e,t;e=+Date.now()+Number((""+Math.random()).slice(2,8));!function(e){e.Net="net",e.FailNet="f_net",e.FailData="f_data"}(t||(t={}));var r={pv:["predefine_pageview"],sdk:["_be_active","predefine_page_alive","predefine_page_close","__profile_set","__profile_set_once","__profile_increment","__profile_unset","__profile_append"],autotrack:["bav2b_click","bav2b_page","bav2b_beat","bav2b_page_statistics","__bav_click","__bav_page","__bav_beat","__bav_page_statistics"]},a=function(){function e(){}return e.prototype.apply=function(e,t){var r=this;if(this.ready=t.app_id&&t.enable_tracer&&!t.disable_track_event,this.ready){this.limit={pv:1,sdk:3,autotrack:3,log:3},this.errorCode={f_net:0,f_data:0},this.tracerCache=new Map,this.collect=e,this.appid=t.app_id,this.reportUrl=e.configManager.getUrl("event");var a=this.collect.Types;e.adapters.fetch;this.collect.on(a.Event,(function(e){var t;t=e,Array.isArray(t)?e.forEach((function(e){r.addCount("log")})):r.addCount("log")})),this.collect.on(a.SubmitError,(function(e){var t=e.type,a=e.eventDate,o=e.errorCode,i=e.response;r.addErrorCount(a,t,o,i)})),this.listener(),this.collect.emit(a.TracerReady)}},e.prototype.addCount=function(e,t,r){void 0===t&&(t="net"),void 0===r&&(r=1);try{this.tracerCache||(this.tracerCache=new Map);var a=void 0;if(this.tracerCache.has(e)){if((o=this.tracerCache.get(e)).has(t))a=o.get(t).params.count,a++,o.set(t,this.processTracer(a,e,t));else a=r,o.set(t,this.processTracer(r,e,t))}else{var o=new Map;a=r,o.set(t,this.processTracer(r,e,t)),this.tracerCache.set(e,o)}"net"===t&&a>=this.limit[e]&&this.report(!1)}catch(e){console.log(e)}},e.prototype.addErrorCount=function(e,t,a,o){var i=this;try{if(e&&e.length){var n=e[0].events;n&&n.length&&("f_data"===t?(o&&o.hasOwnProperty("sc")?this.addCount("log",t,n.length-o.sc):this.addCount("log",t,n.length),this.errorCode[t]=a):n.forEach((function(e){var o="log";for(var n in r)if(-1!==r[n].indexOf(e.event)){o=n;break}i.addCount(o,t,1),i.errorCode[t]=a})))}}catch(e){}},e.prototype.report=function(e){if(this.tracerCache){var t=[];this.tracerCache.forEach((function(e){console.log(e),e.forEach((function(e){t.push(e)}))})),t&&t.length&&this.sendTracer(t,e)}},e.prototype.sendTracer=function(e,t){try{var r=this.collect.eventManager.merge(e);this.collect.requestManager.useRequest({url:this.reportUrl,data:r,useBeacon:t}),this.tracerCache=null}catch(e){}},e.prototype.processTracer=function(e,t,r){try{var a={count:e,state:r,key:t,params_for_special:"applog_trace",aid:this.appid,platform:"web",_staging_flag:1,sdk_version:"5.2.4_oversea"};"f_net"!==r&&"f_data"!==r||(a.errorCode=this.errorCode[r]);var o=this.collect.processEvent("applog_trace",a);if(o&&o.event)return delete o.is_bav,o}catch(e){console.warn("something error")}},e.prototype.listener=function(){var e,t=this;document.addEventListener("visibilitychange",(function(){"hidden"===document.visibilityState&&t.leavePage()})),e=function(){t.leavePage()},navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)?window.addEventListener("pagehide",e,!1):window.addEventListener("beforeunload",e,!1)},e.prototype.leavePage=function(){this.report(!0)},e}();module.exports=a;
